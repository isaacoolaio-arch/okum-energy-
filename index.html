<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKUM Energy - Fuel Station Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #E91E63;
            --primary-dark: #C2185B;
            --primary-light: #F48FB1;
            --secondary: #667eea;
            --secondary-dark: #5568d3;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --gray: #6b7280;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ecf0f5;
            min-height: 100vh;
            margin: 0;
            display: flex;
            overflow-x: hidden;
        }

        /* Modern Sidebar */
        .sidebar {
            width: 250px;
            background: #2c3e50;
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 30px 20px;
            text-align: center;
            background: #34495e;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 36px;
            color: white;
            border: 4px solid rgba(255,255,255,0.2);
        }

        .user-name {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-role {
            color: rgba(255,255,255,0.6);
            font-size: 12px;
        }

        .sidebar-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .menu-item {
            padding: 15px 25px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            border-left: 4px solid transparent;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
            border-left-color: #FF6B35;
        }

        .menu-item.active {
            background: #FF6B35;
            color: white;
            border-left-color: #F7931E;
        }

        .menu-item-icon {
            font-size: 18px;
            width: 24px;
        }

        /* Main Content Area */
        .main-wrapper {
            margin-left: 250px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Header Bar */
        .top-header {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-box {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            background: rgba(255,255,255,0.95);
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            padding: 30px;
            flex: 1;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            font-size: 48px;
        }

        .header-text h1 {
            color: var(--primary);
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header-text p {
            color: var(--gray);
            font-size: 16px;
        }

        /* Modern Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-card h3 {
            color: #6b7280;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: var(--dark);
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: var(--gray);
            font-size: 14px;
        }

        .stat-card.revenue {
            border-left-color: var(--primary);
        }

        .stat-card.revenue .value {
            color: var(--primary);
        }

        .stat-card.shifts {
            border-left-color: var(--secondary);
        }

        .stat-card.shifts .value {
            color: var(--secondary);
        }

        .stat-card.last-id {
            border-left-color: var(--success);
        }

        .stat-card.last-id .value {
            color: var(--success);
            font-size: 28px;
        }

        /* Action Buttons */
        .actions-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .action-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }

        .action-card.featured {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .action-card.featured::before {
            background: rgba(255,255,255,0.3);
        }

        .action-card.featured:hover {
            transform: translateY(-5px) scale(1.02);
        }

        .action-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .action-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .action-card.featured .action-title {
            color: white;
        }

        .action-desc {
            font-size: 14px;
            line-height: 1.6;
        }

        .action-card.featured .action-desc {
            color: rgba(255,255,255,0.9);
        }

        .action-card.quick {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
        }

        .action-card.quick::before {
            background: rgba(255,255,255,0.3);
        }

        .action-card.quick .action-title,
        .action-card.quick .action-desc {
            color: white;
        }

        .action-card.quick .action-desc {
            opacity: 0.9;
        }

        /* Utility Buttons */
        .utility-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        /* Views Dropdown */
        .views-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-width: 250px;
            margin-top: 8px;
            z-index: 1000;
            overflow: hidden;
        }

        .views-dropdown a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border);
            font-weight: 500;
        }

        .views-dropdown a:last-child {
            border-bottom: none;
        }

        .views-dropdown a:hover {
            background: var(--light);
            color: var(--primary);
            padding-left: 24px;
        }

        .views-dropdown a span {
            font-size: 18px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: var(--dark);
            border: 2px solid var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Readings Container */
        .readings-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .readings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .readings-header h2 {
            color: var(--dark);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-filter {
            display: flex;
            gap: 10px;
        }

        .search-filter input,
        .search-filter select {
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-filter input:focus,
        .search-filter select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Reading Cards */
        .readings-grid {
            display: grid;
            gap: 20px;
        }

        .reading-card {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 2px solid var(--border);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
        }

        .reading-card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(233, 30, 99, 0.15);
            transform: translateY(-3px);
        }

        .reading-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .reading-id {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .reading-date {
            color: var(--gray);
            font-size: 14px;
        }

        .reading-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .meta-item {
            flex: 1;
        }

        .meta-label {
            font-size: 12px;
            color: var(--gray);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .meta-value {
            font-size: 16px;
            color: var(--dark);
            font-weight: 600;
        }

        .fuel-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .fuel-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--border);
        }

        .fuel-section.petrol {
            border-left: 5px solid var(--danger);
        }

        .fuel-section.diesel {
            border-left: 5px solid var(--success);
        }

        .fuel-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 14px;
        }

        .fuel-section.petrol .fuel-header {
            color: var(--danger);
        }

        .fuel-section.diesel .fuel-header {
            color: var(--success);
        }

        .fuel-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .fuel-section.petrol .fuel-indicator {
            background: var(--danger);
        }

        .fuel-section.diesel .fuel-indicator {
            background: var(--success);
        }

        .fuel-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .fuel-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .fuel-row .label {
            color: var(--gray);
        }

        .fuel-row .value {
            font-weight: 600;
            color: var(--dark);
        }

        .sold-highlight {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: white !important;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 16px !important;
            font-weight: 700 !important;
            text-align: center;
            margin-top: 10px;
        }

        .sales-summary {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .sales-summary h4 {
            font-size: 14px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .sales-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .sales-item {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 8px;
        }

        .sales-item .label {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .sales-item .amount {
            font-size: 18px;
            font-weight: 700;
        }

        .reading-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.complete {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 1000px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            position: relative;
        }

        .modal-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .modal-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        /* Wizard Steps */
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 60px;
            right: 60px;
            height: 3px;
            background: var(--border);
            z-index: 0;
        }

        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--border);
            color: var(--gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: 700;
            font-size: 20px;
            transition: all 0.3s;
        }

        .wizard-step.active .step-circle {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 20px rgba(233, 30, 99, 0.4);
            transform: scale(1.1);
        }

        .wizard-step.completed .step-circle {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .step-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray);
        }

        .wizard-step.active .step-label {
            color: var(--primary);
        }

        .wizard-step.completed .step-label {
            color: var(--success);
        }

        /* Form Styles */
        .form-section {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .form-section h3 {
            color: var(--dark);
            font-size: 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-group label .required {
            color: var(--danger);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
        }

        .form-group input:read-only {
            background: #f3f4f6;
            color: var(--gray);
        }

        .info-message {
            background: #dbeafe;
            border-left: 4px solid var(--info);
            color: #1e40af;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 10px;
            display: none;
        }

        .info-message.show {
            display: block;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Summary Box */
        .summary-box {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 25px;
        }

        .summary-box h3 {
            font-size: 18px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-item .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-item .amount {
            font-size: 24px;
            font-weight: 700;
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid var(--border);
        }

        .wizard-step-content {
            display: none;
        }

        .wizard-step-content.active {
            display: block;
        }

        /* Alert */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
            z-index: 2000;
            max-width: 400px;
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 5px solid var(--success);
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 5px solid var(--danger);
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 5px solid var(--info);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .actions-container {
                grid-template-columns: 1fr;
            }

            .fuel-data {
                grid-template-columns: 1fr;
            }

            .sales-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .search-filter {
                flex-direction: column;
            }

            .wizard-steps {
                flex-direction: column;
                gap: 20px;
            }

            .wizard-steps::before {
                display: none;
            }

            .reading-meta {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Transaction Lists */
        .transaction-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .transaction-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.1);
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .transaction-meta {
            font-size: 12px;
            color: var(--gray);
        }

        .transaction-amount {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-right: 15px;
        }

        .empty-list {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 14px;
            background: white;
            border-radius: 8px;
            border: 2px dashed var(--border);
        }

        /* Selection Popup */
        .selection-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .selection-popup.show {
            display: flex;
        }

        .selection-popup-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .selection-popup-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selection-popup-header h3 {
            font-size: 20px;
            margin: 0;
        }

        .selection-popup-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .selection-popup-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .selection-popup-search {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .selection-popup-search input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .selection-popup-list {
            overflow-y: auto;
            max-height: 400px;
            padding: 10px;
        }

        .selection-item {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .selection-item:hover {
            background: var(--light);
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .selection-item-id {
            font-weight: 700;
            color: var(--primary);
            font-size: 16px;
        }

        .selection-item-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .selection-item-name {
            font-weight: 600;
            color: var(--dark);
        }

        .selection-item-info {
            font-size: 12px;
            color: var(--gray);
        }

        .selection-item-balance {
            font-weight: 700;
            font-size: 16px;
            color: var(--danger);
            text-align: right;
        }

        .selection-empty {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 100%;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 64px; margin-bottom: 15px;">‚õΩ</div>
                <h2 style="margin: 0 0 10px 0; color: var(--dark);">OKUM Energy</h2>
                <p style="margin: 0; color: var(--gray);">Station Manager</p>
            </div>

            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="login-username" required placeholder="Enter username" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" required placeholder="Enter password" style="width: 100%;">
                </div>
                <div id="login-error" style="color: var(--danger); font-size: 14px; margin-bottom: 15px; display: none;"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                    üîê Login
                </button>
            </form>

        </div>
    </div>

    <div id="main-app" style="display: none;">
        <!-- Modern Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar">üë§</div>
                <div class="user-name" id="sidebar-user-name">ISAAC</div>
                <div class="user-role" id="sidebar-user-role">Station Manager</div>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-item active" onclick="showDashboard()">
                    <span class="menu-item-icon">üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" onclick="openWizard()">
                    <span class="menu-item-icon">‚ö°</span>
                    <span>Shift Wizard</span>
                </div>
                <div class="menu-item" onclick="showView('meters')">
                    <span class="menu-item-icon">üìè</span>
                    <span>Meter Readings</span>
                </div>
                <div class="menu-item" onclick="showView('sales')">
                    <span class="menu-item-icon">üí∞</span>
                    <span>Sales Records</span>
                </div>
                <div class="menu-item" onclick="showView('expenses')">
                    <span class="menu-item-icon">üí≥</span>
                    <span>Expenses</span>
                </div>
                <div class="menu-item" onclick="showView('credits')">
                    <span class="menu-item-icon">üíµ</span>
                    <span>Customer Credits</span>
                </div>
                <div class="menu-item" onclick="showView('purchases')">
                    <span class="menu-item-icon">üõí</span>
                    <span>Purchases</span>
                </div>
                <div class="menu-item" onclick="showView('staffMaster')">
                    <span class="menu-item-icon">üë•</span>
                    <span>Staff Master</span>
                </div>
                <div class="menu-item" onclick="showView('stockControl')">
                    <span class="menu-item-icon">üì¶</span>
                    <span>Stock Control</span>
                </div>
                <div class="menu-item" onclick="showView('profitLoss')">
                    <span class="menu-item-icon">üìà</span>
                    <span>Profit & Loss</span>
                </div>
                <div class="menu-item" onclick="showView('ledger')">
                    <span class="menu-item-icon">üìí</span>
                    <span>Transaction Ledger</span>
                </div>
                <div class="menu-item" onclick="showView('settings')">
                    <span class="menu-item-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content Wrapper -->
        <div class="main-wrapper">
            <!-- Top Orange Header -->
            <div class="top-header">
                <div class="search-box">
                    <input type="text" placeholder="Search anything..." id="dashboard-search">
                </div>
                
                <!-- Cloud Sync Status -->
                <div id="cloud-status-badge" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #f3f4f6; border-radius: 6px; font-size: 13px; margin-right: 10px;">
                    <span id="cloud-status-icon">‚òÅÔ∏è</span>
                    <span id="cloud-status-text">Ready</span>
                </div>
		
                <button class="logout-btn" onclick="handleLogout()">
                    üö™ Logout
                </button>
            </div>
            
            <!-- Main Content Container -->
            <div class="container" id="main-content">
                <!-- Alerts Dashboard -->
                <div id="alerts-dashboard" style="display: none; margin-bottom: 20px;"></div>

                <!-- Alert -->
                <div id="alert" class="alert"></div>

                <!-- Dashboard Welcome Section -->
                <div id="dashboard-section">
                    <div style="background: white; border-radius: 12px; padding: 30px; margin-bottom: 30px; box-shadow: 0 2px 15px rgba(0,0,0,0.08);">
                        <h2 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 28px; font-weight: 700;">
                            Welcome Back, <span id="welcome-user-name">ISAAC</span>! üëã
                        </h2>
                        <p style="margin: 0; color: #6b7280; font-size: 15px;">
                            Here's what's happening with your fuel station today
                        </p>
                    </div>

                    <!-- Stats Cards -->
                    <div class="stats-container">
                        <div class="stat-card revenue">
                            <h3>TOTAL REVENUE</h3>
                            <div class="value" id="stat-revenue" style="font-size: 32px; font-weight: 700; color: #FF6B35; margin: 10px 0;">UGX 0</div>
                            <div class="label" style="color: #6b7280; font-size: 13px;">All time sales</div>
                        </div>
                        <div class="stat-card shifts">
                            <h3>TODAY'S READINGS</h3>
                            <div class="value" id="stat-today" style="font-size: 32px; font-weight: 700; color: #3b82f6; margin: 10px 0;">0</div>
                            <div class="label" style="color: #6b7280; font-size: 13px;">Shifts completed today</div>
                        </div>
                        <div class="stat-card last-id">
                            <h3>LAST READING ID</h3>
                            <div class="value" id="stat-last-id" style="font-size: 32px; font-weight: 700; color: #10b981; margin: 10px 0;">ME 0000</div>
                            <div class="label" style="color: #6b7280; font-size: 13px;">Most recent entry</div>
                        </div>
                        <div class="stat-card">
                            <h3>STOCK STATUS</h3>
                            <div class="value" style="font-size: 32px; font-weight: 700; color: #f59e0b; margin: 10px 0;" id="stat-stock">OK</div>
                            <div class="label" style="color: #6b7280; font-size: 13px;">Current inventory</div>
                        </div>
                    </div>

                    <!-- Quick Actions Grid -->
                    <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 15px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 20px; font-weight: 600;">‚ö° Quick Actions</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div onclick="openWizard()" style="cursor: pointer; padding: 25px; background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%); border-radius: 12px; color: white; transition: transform 0.3s ease; box-shadow: 0 4px 15px rgba(255,107,53,0.3);">
                                <div style="font-size: 48px; margin-bottom: 15px;">‚ö°</div>
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Complete Shift Wizard</div>
                                <div style="font-size: 13px; opacity: 0.9;">
                                    Complete your entire shift in 3 easy steps with automatic calculations
                                </div>
                            </div>
                            <div onclick="openQuickEntry()" style="cursor: pointer; padding: 25px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; transition: all 0.3s ease;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üìè</div>
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px; color: #2c3e50;">Quick Meter Entry</div>
                                <div style="font-size: 13px; color: #6b7280;">
                                    Fast entry for experienced staff. Just record meters!
                                </div>
                            </div>
                            <div onclick="showView('expenses')" style="cursor: pointer; padding: 25px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; transition: all 0.3s ease;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üí≥</div>
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px; color: #2c3e50;">Record Expense</div>
                                <div style="font-size: 13px; color: #6b7280;">
                                    Log expenses, petty cash, loans, and fines
                                </div>
                            </div>
                            <div onclick="openPurchaseForm()" style="cursor: pointer; padding: 25px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; transition: all 0.3s ease;">
                                <div style="font-size: 48px; margin-bottom: 15px;">üõí</div>
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px; color: #2c3e50;">Record Purchase</div>
                                <div style="font-size: 13px; color: #6b7280;">
                                    Log fuel purchases from suppliers
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

        <!-- Old Action Cards - Hidden -->
        <div class="actions-container">
            <div class="action-card featured" onclick="openWizard()">
                <div class="action-icon">‚ö°</div>
                <div class="action-title">Complete Shift Wizard</div>
                <div class="action-desc">
                    Complete your entire shift in 3 easy steps with automatic calculations, 
                    sales breakdown, and balance reconciliation. All data flows automatically!
                </div>
            </div>
            <div class="action-card quick" onclick="openQuickEntry()">
                <div class="action-icon">‚ûï</div>
                <div class="action-title">Quick Meter Entry</div>
                <div class="action-desc">
                    Fast entry for experienced staff. Just record meters and go!
                </div>
            </div>
            <div class="action-card" onclick="openPurchaseForm()">
                <div class="action-icon">üõí</div>
                <div class="action-title">Record Purchase</div>
                <div class="action-desc">
                    Log fuel purchases from suppliers with invoice and delivery details.
                </div>
            </div>
            <div class="action-card" onclick="openExpenseForm()">
                <div class="action-icon">üìù</div>
                <div class="action-title">Add Expense</div>
                <div class="action-desc">
                    Record business expenses with categorization and approval tracking.
                </div>
            </div>
            <div class="action-card" onclick="openCreditPaymentForm()">
                <div class="action-icon">üíµ</div>
                <div class="action-title">Credit Payment</div>
                <div class="action-desc">
                    Record customer credit payments and update balances.
                </div>
            </div>
            <div class="action-card" onclick="openSupplierPaymentForm()">
                <div class="action-icon">üí∏</div>
                <div class="action-title">Supplier Payment</div>
                <div class="action-desc">
                    Record payments to suppliers and manage outstanding balances.
                </div>
            </div>
        </div>

        <!-- Utility Buttons -->
        <div class="utility-buttons">
            <div style="position: relative; display: inline-block;">
                <button class="btn btn-primary" onclick="toggleViewsDropdown()">
                    <span>üìä</span> Views ‚ñº
                </button>
                <div id="views-dropdown" class="views-dropdown" style="display: none;">
                    <a href="#" onclick="event.preventDefault(); showView('meters'); toggleViewsDropdown();">
                        <span>‚õΩ</span> Meter Records
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('sales'); toggleViewsDropdown();">
                        <span>üí∞</span> Sales
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('credits'); toggleViewsDropdown();">
                        <span>üí≥</span> Customer Credits
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('credit-payments'); toggleViewsDropdown();">
                        <span>üíµ</span> Credit Payments
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('purchases'); toggleViewsDropdown();">
                        <span>üõí</span> Purchases
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('purchase-details'); toggleViewsDropdown();">
                        <span>üìã</span> Purchase Details
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('supplier-credits'); toggleViewsDropdown();">
                        <span>üè¢</span> Supplier Credits
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('supplier-payments'); toggleViewsDropdown();">
                        <span>üí∏</span> Supplier Payments
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('price-analysis'); toggleViewsDropdown();">
                        <span>üìà</span> Price Analysis
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('petty-cash'); toggleViewsDropdown();">
                        <span>üíµ</span> Petty Cash
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('expenses'); toggleViewsDropdown();">
                        <span>üìù</span> Expenses
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('cash-transactions'); toggleViewsDropdown();">
                        <span>üíµ</span> Cash Transactions
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('mobile-money'); toggleViewsDropdown();">
                        <span>üì±</span> Mobile Money
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('staff-accountability'); toggleViewsDropdown();">
                        <span>üë•</span> Staff Accountability
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('staff-master'); toggleViewsDropdown();">
                        <span>üë®‚Äçüíº</span> Staff Master
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('stock-control'); toggleViewsDropdown();">
                        <span>üì¶</span> Stock Control
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('profit-loss'); toggleViewsDropdown();">
                        <span>üí∞</span> Profit & Loss
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('ledger'); toggleViewsDropdown();">
                        <span>üìí</span> Transaction Ledger
                    </a>
                    <a href="#" onclick="event.preventDefault(); showView('settings'); toggleViewsDropdown();">
                        <span>‚öôÔ∏è</span> Settings
                    </a>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="exportData()">
                <span>üì•</span> Export Data
            </button>
            <button class="btn btn-primary" onclick="cloudStorage.init().then(() => location.reload())">
    	    <span>‚òÅÔ∏è</span> Connect to Cloud
	    </button>
            <button class="btn btn-secondary" onclick="removeDuplicates()">
                <span>üßπ</span> Remove Duplicates
            </button>
            <button class="btn btn-secondary" onclick="reloadData()">
                <span>üîÑ</span> Reload Data
            </button>
            <button class="btn btn-danger" onclick="clearData()">
                <span>üóëÔ∏è</span> Clear All Data
            </button>
            <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">
                <span>üì§</span> Import Data
            </button>
            <input type="file" id="import-file" style="display: none;" onchange="importData(event)" accept=".json">
            <button class="btn btn-secondary" onclick="clearAllData()">
                <span>üóëÔ∏è</span> Clear All Data
            </button>
        </div>

        <!-- Readings Container -->
        <div class="readings-container" id="dashboard-view">
            <div class="readings-header">
                <h2>
                    <span>üìä</span>
                    All Meter Readings
                </h2>
                <div class="search-filter">
                    <input type="text" id="search-input" placeholder="üîç Search..." onkeyup="filterReadings()">
                    <input type="date" id="filter-date" onchange="filterReadings()">
                    <select id="filter-shift" onchange="filterReadings()">
                        <option value="">All Shifts</option>
                        <option value="MORNING">MORNING</option>
                        <option value="EVENING">EVENING</option>
                    </select>
                </div>
            </div>
            <div class="readings-grid" id="readings-list">
                <!-- Readings will be rendered here -->
            </div>
        </div>

        <!-- Transaction Ledger Section -->
        <div class="readings-container" id="ledger-view" style="display: none;">
            <div class="readings-header">
                <h2>
                    <span>üìí</span>
                    Transaction Ledger
                </h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">
                    ‚Üê Back to Dashboard
                </button>
            </div>

            <!-- Ledger Filters -->
            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Transaction Type</label>
                        <select id="ledger-type-filter" onchange="filterLedger()">
                            <option value="">All Types</option>
                            <option value="sales">Sales</option>
                            <option value="credit">Customer Credits</option>
                            <option value="credit payment">Credit Payments</option>
                            <option value="purchase">Purchases</option>
                            <option value="expense">Expenses</option>
                            <option value="supplier payment">Supplier Payments</option>
                            <option value="staff loss">Staff Losses</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date Range</label>
                        <input type="date" id="ledger-date-from" onchange="filterLedger()">
                    </div>
                    <div class="form-group">
                        <label>To</label>
                        <input type="date" id="ledger-date-to" onchange="filterLedger()">
                    </div>
                    <div class="form-group">
                        <label>Search</label>
                        <input type="text" id="ledger-search" placeholder="Search..." onkeyup="filterLedger()">
                    </div>
                </div>
            </div>

            <!-- Ledger Table -->
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <h3 style="margin-bottom: 20px; color: var(--dark);">
                    <span>üìä</span> All Transactions
                </h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Date</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Type</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Description</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Reference</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--dark);">Credit</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--dark);">Debit</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--dark);">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="ledger-tbody">
                            <!-- Ledger entries will be rendered here -->
                        </tbody>
                        <tfoot>
                            <tr style="background: var(--light); border-top: 2px solid var(--border); font-weight: 700;">
                                <td colspan="4" style="padding: 12px;">TOTALS</td>
                                <td style="padding: 12px; text-align: right; color: var(--success);" id="ledger-total-credit">UGX 0</td>
                                <td style="padding: 12px; text-align: right; color: var(--danger);" id="ledger-total-debit">UGX 0</td>
                                <td style="padding: 12px; text-align: right; color: var(--primary);" id="ledger-balance">UGX 0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Meter Records View -->
        <div class="readings-container" id="meters-view" style="display: none;">
            <div class="readings-header">
                <h2><span>‚õΩ</span> Meter Records</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">ID</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Name</th>
                                <th style="padding: 12px; text-align: left;">Shift</th>
                                <th style="padding: 12px; text-align: left;">Pump</th>
                                <th style="padding: 12px; text-align: right;">Prev Petrol</th>
                                <th style="padding: 12px; text-align: right;">Curr Petrol</th>
                                <th style="padding: 12px; text-align: right;">Litres Petrol</th>
                                <th style="padding: 12px; text-align: right;">Prev Diesel</th>
                                <th style="padding: 12px; text-align: right;">Curr Diesel</th>
                                <th style="padding: 12px; text-align: right;">Litres Diesel</th>
                                <th style="padding: 12px; text-align: left;">Witness</th>
                            </tr>
                        </thead>
                        <tbody id="meters-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sales View -->
        <div class="readings-container" id="sales-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üí∞</span> Sales</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">ID</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Attendant</th>
                                <th style="padding: 12px; text-align: left;">Shift</th>
                                <th style="padding: 12px; text-align: left;">Pump</th>
                                <th style="padding: 12px; text-align: right;">Petrol(L)</th>
                                <th style="padding: 12px; text-align: right;">Diesel(L)</th>
                                <th style="padding: 12px; text-align: right;">Sales</th>
                                <th style="padding: 12px; text-align: right;">Expenses</th>
                                <th style="padding: 12px; text-align: right;">Net Sales</th>
                                <th style="padding: 12px; text-align: right;">Credit</th>
                                <th style="padding: 12px; text-align: right;">Momo</th>
                                <th style="padding: 12px; text-align: right;">Cash</th>
                                <th style="padding: 12px; text-align: right;">Losses</th>
                                <th style="padding: 12px; text-align: left;">Prepared By</th>
                            </tr>
                        </thead>
                        <tbody id="sales-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customer Credits View -->
        <div class="readings-container" id="credits-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üí≥</span> Customer Credits</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">ID</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Name</th>
                                <th style="padding: 12px; text-align: left;">Customer</th>
                                <th style="padding: 12px; text-align: right;">Amount</th>
                                <th style="padding: 12px; text-align: right;">Paid</th>
                                <th style="padding: 12px; text-align: right;">Balance</th>
                                <th style="padding: 12px; text-align: center;">Cleared</th>
                                <th style="padding: 12px; text-align: left;">Cleared By</th>
                                <th style="padding: 12px; text-align: left;">Cleared Date</th>
                                <th style="padding: 12px; text-align: center;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="credits-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Credit Payments View -->
        <div class="readings-container" id="credit-payments-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üíµ</span> Credit Payment Register</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">Payment ID</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Credit ID</th>
                                <th style="padding: 12px; text-align: right;">Amount Paid</th>
                                <th style="padding: 12px; text-align: left;">Method</th>
                                <th style="padding: 12px; text-align: left;">Notes</th>
                                <th style="padding: 12px; text-align: left;">Cleared By</th>
                            </tr>
                        </thead>
                        <tbody id="credit-payments-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Purchases View -->
        <div class="readings-container" id="purchases-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üõí</span> Purchases</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">ID</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Name</th>
                                <th style="padding: 12px; text-align: left;">Supplier</th>
                                <th style="padding: 12px; text-align: left;">Product</th>
                                <th style="padding: 12px; text-align: right;">Litres</th>
                                <th style="padding: 12px; text-align: right;">Total Amount</th>
                                <th style="padding: 12px; text-align: right;">Amount Paid</th>
                                <th style="padding: 12px; text-align: right;">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="purchases-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Purchase Details View -->
        <div class="readings-container" id="purchase-details-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üìã</span> Purchase Details</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">Purchase ID</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Invoice Number</th>
                                <th style="padding: 12px; text-align: left;">Payment Method</th>
                                <th style="padding: 12px; text-align: left;">Truck Number</th>
                                <th style="padding: 12px; text-align: left;">Driver Name</th>
                                <th style="padding: 12px; text-align: right;">Price/Liter</th>
                                <th style="padding: 12px; text-align: left;">Notes</th>
                                <th style="padding: 12px; text-align: left;">Recorded By</th>
                            </tr>
                        </thead>
                        <tbody id="purchase-details-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Supplier Credits View -->
        <div class="readings-container" id="supplier-credits-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üè¢</span> Supplier Credits</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">Credit ID</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Purchase ID</th>
                                <th style="padding: 12px; text-align: left;">Supplier</th>
                                <th style="padding: 12px; text-align: right;">Balance</th>
                                <th style="padding: 12px; text-align: center;">Status</th>
                                <th style="padding: 12px; text-align: left;">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="supplier-credits-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Supplier Payments View -->
        <div class="readings-container" id="supplier-payments-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üí∏</span> Supplier Payment History</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">Payment ID</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Credit ID</th>
                                <th style="padding: 12px; text-align: left;">Purchase ID</th>
                                <th style="padding: 12px; text-align: left;">Supplier</th>
                                <th style="padding: 12px; text-align: right;">Amount Paid</th>
                                <th style="padding: 12px; text-align: left;">Method</th>
                                <th style="padding: 12px; text-align: left;">Paid By</th>
                                <th style="padding: 12px; text-align: left;">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="supplier-payments-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Price Analysis View -->
        <div class="readings-container" id="price-analysis-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üìà</span> Price Analysis</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">Purchase ID</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Fuel Type</th>
                                <th style="padding: 12px; text-align: left;">Supplier</th>
                                <th style="padding: 12px; text-align: right;">Cost Price/L</th>
                                <th style="padding: 12px; text-align: right;">Selling Price/L</th>
                                <th style="padding: 12px; text-align: right;">Margin/L</th>
                                <th style="padding: 12px; text-align: right;">Total Margin</th>
                                <th style="padding: 12px; text-align: center;">Auto-Detected</th>
                            </tr>
                        </thead>
                        <tbody id="price-analysis-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Petty Cash View -->
        <div class="readings-container" id="petty-cash-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üíµ</span> Petty Cash Details</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">ID</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Name</th>
                                <th style="padding: 12px; text-align: left;">Detail</th>
                                <th style="padding: 12px; text-align: right;">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="petty-cash-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Expenses View -->
        <div class="readings-container" id="expenses-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üìù</span> Expenses</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            
            <!-- Petty Cash Summary -->
            <div id="petty-cash-summary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 20px; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üí∞ PETTY CASH SUMMARY</div>
                        <div style="font-size: 32px; font-weight: 700;" id="petty-cash-total">UGX 0</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total Transactions</div>
                        <div style="font-size: 32px; font-weight: 700;" id="petty-cash-count">0</div>
                    </div>
                </div>
            </div>
            
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">Expense ID</th>
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Category</th>
                                <th style="padding: 12px; text-align: left;">Description</th>
                                <th style="padding: 12px; text-align: right;">Amount</th>
                                <th style="padding: 12px; text-align: left;">Payment Method</th>
                                <th style="padding: 12px; text-align: left;">Paid To</th>
                                <th style="padding: 12px; text-align: left;">Reference</th>
                                <th style="padding: 12px; text-align: left;">Approved By</th>
                                <th style="padding: 12px; text-align: left;">Recorded By</th>
                                <th style="padding: 12px; text-align: center;">Receipt?</th>
                                <th style="padding: 12px; text-align: left;">Notes</th>
                                <th style="padding: 12px; text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cash Transactions View -->
        <div class="readings-container" id="cash-transactions-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üíµ</span> Cash Transactions</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Name</th>
                                <th style="padding: 12px; text-align: left;">Type</th>
                                <th style="padding: 12px; text-align: left;">Ref</th>
                                <th style="padding: 12px; text-align: right;">IN</th>
                                <th style="padding: 12px; text-align: right;">OUT</th>
                                <th style="padding: 12px; text-align: right;">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="cash-transactions-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Mobile Money View -->
        <div class="readings-container" id="mobile-money-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üì±</span> Mobile Money</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left;">Date</th>
                                <th style="padding: 12px; text-align: left;">Name</th>
                                <th style="padding: 12px; text-align: left;">Type</th>
                                <th style="padding: 12px; text-align: left;">Ref</th>
                                <th style="padding: 12px; text-align: right;">IN</th>
                                <th style="padding: 12px; text-align: right;">OUT</th>
                                <th style="padding: 12px; text-align: right;">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="mobile-money-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Staff Accountability View -->
        <div class="readings-container" id="staff-accountability-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üë•</span> Staff Accountability</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>

            <!-- Filters -->
            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Staff Member</label>
                        <select id="staff-filter" onchange="renderStaffAccountability()">
                            <option value="">All Staff</option>
                            <option value="WINNIE">WINNIE</option>
                            <option value="CYRUS">CYRUS</option>
                            <option value="RONALD">RONALD</option>
                            <option value="NORBERT">NORBERT</option>
                            <option value="BRIAN">BRIAN</option>
                            <option value="ISAAC">ISAAC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="category-filter" onchange="renderStaffAccountability()">
                            <option value="">All Categories</option>
                            <option value="Sales">Sales</option>
                            <option value="Credit Issued">Credit Issued</option>
                            <option value="Mobile Money">Mobile Money</option>
                            <option value="Petty Cash">Petty Cash</option>
                            <option value="Loss">Loss</option>
                            <option value="Advance">Advance</option>
                            <option value="Loan">Loan</option>
                            <option value="Fine">Fine</option>
                            <option value="Staff Advance">Staff Advance</option>
                            <option value="Staff Loan">Staff Loan</option>
                            <option value="Salary Advance">Salary Advance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date From</label>
                        <input type="date" id="staff-date-from" onchange="renderStaffAccountability()">
                    </div>
                    <div class="form-group">
                        <label>Date To</label>
                        <input type="date" id="staff-date-to" onchange="renderStaffAccountability()">
                    </div>
                </div>
            </div>

            <div style="background: white; padding: 30px; border-radius: 15px;">
                <h3 style="margin-bottom: 20px; color: var(--dark);">
                    <span>üìä</span> Staff Transactions
                </h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Staff ID</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Date</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Name</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Category</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Reference</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Details</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--dark);">Amount</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--dark);">Status</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--dark);">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staff-accountability-tbody"></tbody>
                        <tfoot>
                            <tr style="background: var(--light); border-top: 2px solid var(--border); font-weight: 700;">
                                <td colspan="6" style="padding: 12px;">TOTAL</td>
                                <td style="padding: 12px; text-align: right; color: var(--primary);" id="staff-total-amount">UGX 0</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Stock Control View -->
        <div class="readings-container" id="stock-control-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üì¶</span> Stock Control</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>

            <!-- Stock Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 25px; border-radius: 15px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">PMS Stock</div>
                    <div style="font-size: 32px; font-weight: 700; margin-bottom: 5px;" id="stock-pms-current">0 L</div>
                    <div style="font-size: 12px; opacity: 0.8;">Current Level</div>
                </div>
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 25px; border-radius: 15px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">AGO Stock</div>
                    <div style="font-size: 32px; font-weight: 700; margin-bottom: 5px;" id="stock-ago-current">0 L</div>
                    <div style="font-size: 12px; opacity: 0.8;">Current Level</div>
                </div>
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 25px; border-radius: 15px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Purchases</div>
                    <div style="font-size: 32px; font-weight: 700; margin-bottom: 5px;" id="stock-total-purchased">0 L</div>
                    <div style="font-size: 12px; opacity: 0.8;">All Time</div>
                </div>
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 25px; border-radius: 15px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Sales</div>
                    <div style="font-size: 32px; font-weight: 700; margin-bottom: 5px;" id="stock-total-sold">0 L</div>
                    <div style="font-size: 12px; opacity: 0.8;">All Time</div>
                </div>
            </div>

            <!-- Filters -->
            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Fuel Type</label>
                        <select id="stock-fuel-filter" onchange="renderStockControl()">
                            <option value="">All Fuel Types</option>
                            <option value="PMS">PMS (Petrol)</option>
                            <option value="AGO">AGO (Diesel)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date From</label>
                        <input type="date" id="stock-date-from" onchange="renderStockControl()">
                    </div>
                    <div class="form-group">
                        <label>Date To</label>
                        <input type="date" id="stock-date-to" onchange="renderStockControl()">
                    </div>
                </div>
            </div>

            <div style="background: white; padding: 30px; border-radius: 15px;">
                <h3 style="margin-bottom: 20px; color: var(--dark);">
                    <span>üìä</span> Stock Movement History
                </h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Date</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Type</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Fuel</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Reference</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--dark);">Details</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--dark);">In (L)</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--dark);">Out (L)</th>
                                <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--dark);">Balance (L)</th>
                            </tr>
                        </thead>
                        <tbody id="stock-control-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Profit & Loss Account View -->
        <div class="readings-container" id="profit-loss-view" style="display: none;">
            <div class="readings-header">
                <h2><span>üí∞</span> Profit & Loss Account</h2>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>

            <!-- Period Selection -->
            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Period From</label>
                        <input type="date" id="pl-date-from" onchange="renderProfitLoss()">
                    </div>
                    <div class="form-group">
                        <label>Period To</label>
                        <input type="date" id="pl-date-to" onchange="renderProfitLoss()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="renderProfitLoss()" style="margin-top: 24px;">
                            üîÑ Calculate P&L
                        </button>
                    </div>
                </div>
            </div>

            <!-- P&L Statement -->
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <h3 style="margin-bottom: 20px; color: var(--dark); text-align: center; font-size: 24px;">
                    <span>üìä</span> PROFIT & LOSS STATEMENT
                </h3>
                <div style="text-align: center; color: var(--gray); margin-bottom: 30px;" id="pl-period-display">
                    Period: All Time
                </div>

                <div style="max-width: 800px; margin: 0 auto;">
                    <!-- Revenue Section -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="background: #f0f9ff; padding: 12px; border-left: 4px solid #3b82f6; margin-bottom: 15px;">REVENUE</h4>
                        <table style="width: 100%; margin-bottom: 10px;">
                            <tr>
                                <td style="padding: 8px; padding-left: 20px;">Sales Revenue</td>
                                <td style="padding: 8px; text-align: right; font-weight: 600;" id="pl-sales-revenue">UGX 0</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; padding-left: 20px;">Credit Payments Received</td>
                                <td style="padding: 8px; text-align: right; font-weight: 600;" id="pl-credit-payments">UGX 0</td>
                            </tr>
                            <tr style="border-top: 2px solid var(--border); background: #f9fafb;">
                                <td style="padding: 12px; padding-left: 20px; font-weight: 700;">Total Revenue</td>
                                <td style="padding: 12px; text-align: right; font-weight: 700; color: var(--success);" id="pl-total-revenue">UGX 0</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Cost of Goods Sold -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="background: #fef2f2; padding: 12px; border-left: 4px solid #ef4444; margin-bottom: 15px;">COST OF GOODS SOLD</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="padding: 8px; padding-left: 20px;">Fuel Purchases</td>
                                <td style="padding: 8px; text-align: right; font-weight: 600;" id="pl-purchases">UGX 0</td>
                            </tr>
                            <tr style="border-top: 2px solid var(--border); background: #f9fafb;">
                                <td style="padding: 12px; padding-left: 20px; font-weight: 700;">Total COGS</td>
                                <td style="padding: 12px; text-align: right; font-weight: 700; color: var(--danger);" id="pl-total-cogs">UGX 0</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Gross Profit -->
                    <div style="margin-bottom: 30px;">
                        <table style="width: 100%;">
                            <tr style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                                <td style="padding: 15px; padding-left: 20px; font-weight: 700; font-size: 18px;">GROSS PROFIT</td>
                                <td style="padding: 15px; text-align: right; font-weight: 700; font-size: 18px;" id="pl-gross-profit">UGX 0</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Operating Expenses -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="background: #fef2f2; padding: 12px; border-left: 4px solid #f59e0b; margin-bottom: 15px;">OPERATING EXPENSES</h4>
                        <table style="width: 100%;">
                            <tr>
                                <td style="padding: 8px; padding-left: 20px;">General Expenses</td>
                                <td style="padding: 8px; text-align: right; font-weight: 600;" id="pl-expenses">UGX 0</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; padding-left: 20px;">Supplier Payments</td>
                                <td style="padding: 8px; text-align: right; font-weight: 600;" id="pl-supplier-payments">UGX 0</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; padding-left: 20px;">Staff Losses</td>
                                <td style="padding: 8px; text-align: right; font-weight: 600;" id="pl-losses">UGX 0</td>
                            </tr>
                            <tr style="border-top: 2px solid var(--border); background: #f9fafb;">
                                <td style="padding: 12px; padding-left: 20px; font-weight: 700;">Total Operating Expenses</td>
                                <td style="padding: 12px; text-align: right; font-weight: 700; color: var(--danger);" id="pl-total-expenses">UGX 0</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Net Profit -->
                    <div style="margin-bottom: 30px;">
                        <table style="width: 100%;">
                            <tr id="pl-net-result-row" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                                <td style="padding: 20px; padding-left: 20px; font-weight: 700; font-size: 20px;">NET PROFIT</td>
                                <td style="padding: 20px; text-align: right; font-weight: 700; font-size: 20px;" id="pl-net-profit">UGX 0</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Summary Stats -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 30px;">
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">Gross Margin</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--primary);" id="pl-gross-margin">0%</div>
                        </div>
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">Net Margin</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--success);" id="pl-net-margin">0%</div>
                        </div>
                        <div style="background: #fef2f2; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 12px; color: var(--gray); margin-bottom: 5px;">Expense Ratio</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--danger);" id="pl-expense-ratio">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="wizard-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö° Shift Balancing Wizard</h2>
                <p>Complete your shift in 3 easy steps - All calculations are automatic!</p>
                <button class="close-modal" onclick="closeWizard()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Wizard Steps Indicator -->
                <div class="wizard-steps">
                    <div class="wizard-step active" data-step="1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Section Data</div>
                    </div>
                    <div class="wizard-step" data-step="2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Meter Readings</div>
                    </div>
                    <div class="wizard-step" data-step="3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Sales & Balance</div>
                    </div>
                </div>

                <!-- Step 1: Section Data -->
                <div id="wizard-step-1" class="wizard-step-content active">
                    <div class="form-section">
                        <h3><span>üìã</span> Shift Information</h3>
                        <p style="color: var(--gray); margin-bottom: 20px; font-size: 14px;">
                            This information will be used throughout the entire shift
                        </p>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Date <span class="required">*</span></label>
                                <input type="date" id="wiz-date" required>
                            </div>
                            <div class="form-group">
                                <label>Shift <span class="required">*</span></label>
                                <select id="wiz-shift" required>
                                    <option value="">Select Shift</option>
                                    <option value="MORNING">MORNING</option>
                                    <option value="EVENING">EVENING</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Pump <span class="required">*</span></label>
                                <select id="wiz-pump" required>
                                    <option value="">Select Pump</option>
                                    <option value="Pump 1">Pump 1</option>
                                    <option value="Pump 2">Pump 2</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Attendant <span class="required">*</span></label>
                                <select id="wiz-attendant" required>
                                    <option value="">Select Attendant</option>
                                    <option value="WINNIE">WINNIE</option>
                                    <option value="CYRUS">CYRUS</option>
                                    <option value="RONALD">RONALD</option>
                                    <option value="NORBERT">NORBERT</option>
                                    <option value="BRIAN">BRIAN</option>
                                    <option value="ISAAC">ISAAC</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Credit Transactions -->
                    <div class="form-section">
                        <h3><span>üí≥</span> Credit Transactions</h3>
                        <p style="color: var(--gray); margin-bottom: 15px; font-size: 14px;">
                            Add customer credit sales
                        </p>
                        
                        <div class="form-grid" style="margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Customer Name</label>
                                <input type="text" id="credit-customer" placeholder="Customer name">
                            </div>
                            <div class="form-group">
                                <label>Amount (UGX)</label>
                                <input type="number" id="credit-amount" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>Fuel Type</label>
                                <select id="credit-fuel">
                                    <option value="PMS">PMS</option>
                                    <option value="AGO">AGO</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-primary" onclick="addCredit()" style="margin-top: 24px;">
                                    ‚ûï Add Credit
                                </button>
                            </div>
                        </div>

                        <div id="credits-list" style="margin-top: 15px;">
                            <!-- Credits will be listed here -->
                        </div>
                        
                        <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-top: 10px;">
                            <strong>Total Credits: UGX <span id="credits-total">0</span></strong>
                        </div>
                    </div>

                    <!-- Mobile Money Transactions -->
                    <div class="form-section">
                        <h3><span>üì±</span> Mobile Money Transactions</h3>
                        <p style="color: var(--gray); margin-bottom: 15px; font-size: 14px;">
                            Add mobile money payments received
                        </p>
                        
                        <div class="form-grid" style="margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Customer/Reference</label>
                                <input type="text" id="momo-customer" placeholder="Name or number">
                            </div>
                            <div class="form-group">
                                <label>Amount (UGX)</label>
                                <input type="number" id="momo-amount" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>Provider</label>
                                <select id="momo-provider">
                                    <option value="MTN">MTN MoMo</option>
                                    <option value="Airtel">Airtel Money</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-primary" onclick="addMomo()" style="margin-top: 24px;">
                                    ‚ûï Add MoMo
                                </button>
                            </div>
                        </div>

                        <div id="momo-list" style="margin-top: 15px;">
                            <!-- MoMo entries will be listed here -->
                        </div>
                        
                        <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-top: 10px;">
                            <strong>Total Mobile Money: UGX <span id="momo-total">0</span></strong>
                        </div>
                    </div>

                    <!-- Petty Cash Transactions -->
                    <div class="form-section">
                        <h3><span>üíµ</span> Petty Cash Expenses</h3>
                        <p style="color: var(--gray); margin-bottom: 15px; font-size: 14px;">
                            Add petty cash expenses during shift
                        </p>
                        
                        <div class="form-grid" style="margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="petty-desc" placeholder="What was purchased">
                            </div>
                            <div class="form-group">
                                <label>Amount (UGX)</label>
                                <input type="number" id="petty-amount" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="petty-category">
                                    <option value="Supplies">Supplies</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Transport">Transport</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-primary" onclick="addPettyCash()" style="margin-top: 24px;">
                                    ‚ûï Add Expense
                                </button>
                            </div>
                        </div>

                        <div id="petty-list" style="margin-top: 15px;">
                            <!-- Petty cash entries will be listed here -->
                        </div>
                        
                        <div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin-top: 10px;">
                            <strong>Total Petty Cash: UGX <span id="petty-total">0</span></strong>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button class="btn btn-secondary" onclick="closeWizard()">Cancel</button>
                        <button class="btn btn-primary" onclick="wizardNext(1)">Next: Meter Readings ‚Üí</button>
                    </div>
                </div>

                <!-- Step 2: Meter Readings -->
                <div id="wizard-step-2" class="wizard-step-content">
                    <div class="form-section">
                        <h3><span>‚õΩ</span> Premium/PMS Meters</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Opening Meter</label>
                                <input type="number" id="wiz-pms-open" step="0.01" readonly>
                                <div class="info-message" id="pms-open-info"></div>
                            </div>
                            <div class="form-group">
                                <label>Closing Meter <span class="required">*</span></label>
                                <input type="number" id="wiz-pms-close" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Litres Sold</label>
                                <input type="number" id="wiz-pms-litres" step="0.01" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><span>üöõ</span> Diesel/AGO Meters</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Opening Meter</label>
                                <input type="number" id="wiz-ago-open" step="0.01" readonly>
                                <div class="info-message" id="ago-open-info"></div>
                            </div>
                            <div class="form-group">
                                <label>Closing Meter <span class="required">*</span></label>
                                <input type="number" id="wiz-ago-close" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Litres Sold</label>
                                <input type="number" id="wiz-ago-litres" step="0.01" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><span>üë§</span> Witness Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Witnessed By</label>
                                <select id="wiz-witness">
                                    <option value="">Select witness...</option>
                                    <option value="WINNIE">WINNIE</option>
                                    <option value="CYRUS">CYRUS</option>
                                    <option value="RONALD">RONALD</option>
                                    <option value="NORBERT">NORBERT</option>
                                    <option value="BRIAN">BRIAN</option>
                                    <option value="ISAAC">ISAAC</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button class="btn btn-secondary" onclick="wizardPrev(2)">‚Üê Previous</button>
                        <button class="btn btn-primary" onclick="wizardNext(2)">Next: Sales & Balance ‚Üí</button>
                    </div>
                </div>

                <!-- Step 3: Sales & Balance -->
                <div id="wizard-step-3" class="wizard-step-content">
                    <div class="form-section">
                        <h3><span>üí∞</span> Sales Calculation</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>PMS Sales (Litres)</label>
                                <input type="number" id="wiz-pms-sales" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label>PMS Price/Litre (UGX)</label>
                                <input type="number" id="wiz-pms-price" step="1" value="5200">
                            </div>
                            <div class="form-group">
                                <label>PMS Total (UGX)</label>
                                <input type="number" id="wiz-pms-total" readonly>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>AGO Sales (Litres)</label>
                                <input type="number" id="wiz-ago-sales" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label>AGO Price/Litre (UGX)</label>
                                <input type="number" id="wiz-ago-price" step="1" value="4800">
                            </div>
                            <div class="form-group">
                                <label>AGO Total (UGX)</label>
                                <input type="number" id="wiz-ago-total" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction Summary from Step 1 -->
                    <div id="step1-summary" class="form-section" style="background: #f0f9ff; border-left: 4px solid #3b82f6;">
                        <h3><span>üìã</span> From Section Data (Step 1)</h3>
                        <div class="summary-grid" style="grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 5px;">CREDITS</div>
                                <div style="font-size: 16px; font-weight: 700; color: #3b82f6;" id="step1-credits-display">UGX 0</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 3px;" id="step1-credits-count">0 entries</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 5px;">MOBILE MONEY</div>
                                <div style="font-size: 16px; font-weight: 700; color: #3b82f6;" id="step1-momo-display">UGX 0</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 3px;" id="step1-momo-count">0 entries</div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 5px;">PETTY CASH</div>
                                <div style="font-size: 16px; font-weight: 700; color: #ef4444;" id="step1-petty-display">UGX 0</div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 3px;" id="step1-petty-count">0 entries</div>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #6b7280; margin-top: 10px; text-align: center;">
                            ‚ÑπÔ∏è These amounts are auto-filled in Payment Breakdown below
                        </p>
                    </div>

                    <div class="form-section">
                        <h3><span>üíµ</span> Payment Breakdown</h3>
                        <p style="color: var(--gray); margin-bottom: 15px; font-size: 14px;">
                            Credits and Mobile Money are locked (from Step 1). Only Cash can be adjusted.
                        </p>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Cash (UGX) <span style="color: var(--success);">‚úì Editable</span></label>
                                <input type="number" id="wiz-cash" step="1" value="0">
                            </div>
                            <div class="form-group">
                                <label>Mobile Money (UGX) <span style="color: var(--gray);">üîí Locked</span></label>
                                <input type="number" id="wiz-momo" step="1" value="0" readonly style="background: #f3f4f6; color: #6b7280; cursor: not-allowed;">
                                <div style="font-size: 11px; color: #3b82f6; margin-top: 5px;">
                                    üîí Auto-filled from Step 1 (locked)
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Credits (UGX) <span style="color: var(--gray);">üîí Locked</span></label>
                                <input type="number" id="wiz-credits" step="1" value="0" readonly style="background: #f3f4f6; color: #6b7280; cursor: not-allowed;">
                                <div style="font-size: 11px; color: #3b82f6; margin-top: 5px;">
                                    üîí Auto-filled from Step 1 (locked)
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="summary-box">
                        <h3>üí° Shift Summary</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="label">Total Sales</div>
                                <div class="amount" id="summary-sales">UGX 0</div>
                            </div>
                            <div class="summary-item">
                                <div class="label">Total Collections</div>
                                <div class="amount" id="summary-collected">UGX 0</div>
                            </div>
                            <div class="summary-item">
                                <div class="label">Balance</div>
                                <div class="amount" id="summary-balance">UGX 0</div>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button class="btn btn-secondary" onclick="wizardPrev(3)">‚Üê Previous</button>
                        <button class="btn btn-success" onclick="completeWizard()">‚úì Complete Shift</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Entry Modal -->
    <div id="quick-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);">
                <h2>‚ûï Quick Meter Entry</h2>
                <p>Fast entry for experienced staff</p>
                <button class="close-modal" onclick="closeQuickEntry()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="quick-form" onsubmit="saveQuickEntry(event)">
                    <div class="form-section">
                        <h3>Shift Details</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="quick-date" required>
                            </div>
                            <div class="form-group">
                                <label>Shift</label>
                                <select id="quick-shift" required>
                                    <option value="MORNING">MORNING</option>
                                    <option value="EVENING">EVENING</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Pump</label>
                                <select id="quick-pump" required>
                                    <option value="Pump 1">Pump 1</option>
                                    <option value="Pump 2">Pump 2</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Staff</label>
                                <select id="quick-staff" required>
                                    <option value="WINNIE">WINNIE</option>
                                    <option value="CYRUS">CYRUS</option>
                                    <option value="RONALD">RONALD</option>
                                    <option value="NORBERT">NORBERT</option>
                                    <option value="BRIAN">BRIAN</option>
                                    <option value="ISAAC">ISAAC</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Petrol/PMS</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Previous Reading</label>
                                <input type="number" id="quick-pms-prev" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label>Current Reading</label>
                                <input type="number" id="quick-pms-curr" step="0.01" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Diesel/AGO</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Previous Reading</label>
                                <input type="number" id="quick-ago-prev" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label>Current Reading</label>
                                <input type="number" id="quick-ago-curr" step="0.01" required>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeQuickEntry()">Cancel</button>
                        <button type="submit" class="btn btn-success">üíæ Save Reading</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Purchase Form Modal -->
    <div id="purchase-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h2>üõí Record Purchase</h2>
                <p>Log fuel purchases from suppliers</p>
                <button class="close-modal" onclick="closePurchaseForm()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="purchase-form" onsubmit="savePurchase(event)">
                    <div class="form-section">
                        <h3>Purchase Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Date & Time</label>
                                <input type="datetime-local" id="purchase-date" required>
                            </div>
                            <div class="form-group">
                                <label>Recorded By</label>
                                <select id="purchase-recorded-by" required>
                                    <option value="ISAAC">ISAAC</option>
                                    <option value="BRIAN">BRIAN</option>
                                    <option value="WINNIE">WINNIE</option>
                                    <option value="CYRUS">CYRUS</option>
                                    <option value="RONALD">RONALD</option>
                                    <option value="NORBERT">NORBERT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Supplier</label>
                                <select id="purchase-supplier" required>
                                    <option value="GASCO">GASCO</option>
                                    <option value="Total">Total</option>
                                    <option value="Shell">Shell</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Product</label>
                                <select id="purchase-product" required onchange="autopopulatePurchasePrice()">
                                    <option value="PMS">PMS (Petrol)</option>
                                    <option value="AGO">AGO (Diesel)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Quantity & Pricing</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Litres</label>
                                <input type="number" id="purchase-litres" step="0.001" required>
                            </div>
                            <div class="form-group">
                                <label>Price per Liter (UGX)</label>
                                <input type="number" id="purchase-price-per-liter" step="1" required oninput="calculatePurchaseTotal()">
                            </div>
                            <div class="form-group">
                                <label>Total Amount (UGX)</label>
                                <input type="number" id="purchase-total-amount" step="1" readonly style="background: #f3f4f6;">
                            </div>
                            <div class="form-group">
                                <label>Amount Paid (UGX)</label>
                                <input type="number" id="purchase-amount-paid" step="1" value="0" oninput="calculatePurchaseBalance()">
                            </div>
                            <div class="form-group">
                                <label>Balance (UGX)</label>
                                <input type="number" id="purchase-balance" step="1" readonly style="background: #f3f4f6;">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Delivery Details</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Invoice Number</label>
                                <input type="text" id="purchase-invoice" required>
                            </div>
                            <div class="form-group">
                                <label>Payment Method</label>
                                <select id="purchase-payment-method" required>
                                    <option value="Cash">Cash</option>
                                    <option value="Mobile Money">Mobile Money</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Credit">Credit</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Truck Number</label>
                                <input type="text" id="purchase-truck">
                            </div>
                            <div class="form-group">
                                <label>Driver Name</label>
                                <input type="text" id="purchase-driver">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Notes</label>
                                <textarea id="purchase-notes" rows="2" placeholder="Additional notes..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button type="button" class="btn btn-secondary" onclick="closePurchaseForm()">Cancel</button>
                        <button type="submit" class="btn btn-success">üíæ Save Purchase</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Form Modal -->
    <div id="expense-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <h2>üìù Add Expense</h2>
                <p>Record business expenses</p>
                <button class="close-modal" onclick="closeExpenseForm()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="expense-form" onsubmit="saveExpense(event)">
                    <div class="form-section">
                        <h3>Expense Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="expense-date" required>
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="expense-category" required>
                                    <option value="Petty Cash">Petty Cash</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Salaries">Salaries</option>
                                    <option value="Transport">Transport</option>
                                    <option value="Supplies">Supplies</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="expense-description" required placeholder="e.g., Staff Welfare, Repairs">
                            </div>
                            <div class="form-group">
                                <label>Amount (UGX)</label>
                                <input type="number" id="expense-amount" step="1" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Payment Details</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Payment Method</label>
                                <select id="expense-payment-method" required>
                                    <option value="Cash">Cash</option>
                                    <option value="Mobile Money">Mobile Money</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Paid To</label>
                                <input type="text" id="expense-paid-to" required>
                            </div>
                            <div class="form-group">
                                <label>Reference/Receipt No.</label>
                                <input type="text" id="expense-reference">
                            </div>
                            <div class="form-group">
                                <label>Receipt Available?</label>
                                <select id="expense-receipt">
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Approved By</label>
                                <select id="expense-approved-by">
                                    <option value="">Not yet approved</option>
                                    <option value="ISAAC">ISAAC</option>
                                    <option value="BRIAN">BRIAN</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Recorded By</label>
                                <select id="expense-recorded-by" required>
                                    <option value="ISAAC">ISAAC</option>
                                    <option value="BRIAN">BRIAN</option>
                                    <option value="WINNIE">WINNIE</option>
                                    <option value="CYRUS">CYRUS</option>
                                    <option value="RONALD">RONALD</option>
                                    <option value="NORBERT">NORBERT</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Additional Notes</label>
                                <textarea id="expense-notes" rows="2" placeholder="Any additional information..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeExpenseForm()">Cancel</button>
                        <button type="submit" class="btn btn-success">üíæ Save Expense</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Credit Payment Form Modal -->
    <div id="credit-payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <h2>üíµ Credit Payment</h2>
                <p>Record customer credit payment</p>
                <button class="close-modal" onclick="closeCreditPaymentForm()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="credit-payment-form" onsubmit="saveCreditPayment(event)">
                    <div class="form-section">
                        <h3>Payment Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Date & Time</label>
                                <input type="datetime-local" id="credit-payment-date" required>
                            </div>
                            <div class="form-group">
                                <label>Credit ID <span style="color: var(--primary); font-size: 11px;">(Click to select)</span></label>
                                <input type="text" id="credit-payment-credit-id" required placeholder="Click to select customer credit..." readonly onclick="showCustomerCreditSelection()" style="cursor: pointer; background: var(--light);">
                            </div>
                            <div class="form-group">
                                <label>Amount Paid (UGX)</label>
                                <input type="number" id="credit-payment-amount" step="1" required>
                            </div>
                            <div class="form-group">
                                <label>Payment Method</label>
                                <select id="credit-payment-method" required>
                                    <option value="Cash">Cash</option>
                                    <option value="Mobile Money">Mobile Money</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Cleared By</label>
                                <select id="credit-payment-cleared-by" required>
                                    <option value="ISAAC">ISAAC</option>
                                    <option value="BRIAN">BRIAN</option>
                                    <option value="WINNIE">WINNIE</option>
                                    <option value="CYRUS">CYRUS</option>
                                    <option value="RONALD">RONALD</option>
                                    <option value="NORBERT">NORBERT</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Notes</label>
                                <textarea id="credit-payment-notes" rows="2" placeholder="Payment notes..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCreditPaymentForm()">Cancel</button>
                        <button type="submit" class="btn btn-success">üíæ Record Payment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Supplier Payment Form Modal -->
    <div id="supplier-payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <h2>üí∏ Supplier Payment</h2>
                <p>Record payment to supplier</p>
                <button class="close-modal" onclick="closeSupplierPaymentForm()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="supplier-payment-form" onsubmit="saveSupplierPayment(event)">
                    <div class="form-section">
                        <h3>Payment Information</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="supplier-payment-date" required>
                            </div>
                            <div class="form-group">
                                <label>Supplier Credit ID <span style="color: var(--primary); font-size: 11px;">(Click to select)</span></label>
                                <input type="text" id="supplier-payment-credit-id" placeholder="Click to select from list..." readonly onclick="showSupplierCreditSelection()" style="cursor: pointer; background: var(--light);">
                            </div>
                            <div class="form-group">
                                <label>Purchase ID <span style="color: var(--primary); font-size: 11px;">(Click to select)</span></label>
                                <input type="text" id="supplier-payment-purchase-id" required placeholder="Click to select from list..." readonly onclick="showPurchaseSelection()" style="cursor: pointer; background: var(--light);">
                            </div>
                            <div class="form-group">
                                <label>Supplier</label>
                                <select id="supplier-payment-supplier" required>
                                    <option value="">Auto-filled from purchase</option>
                                    <option value="GASCO">GASCO</option>
                                    <option value="Total">Total</option>
                                    <option value="Shell">Shell</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Amount Paid (UGX)</label>
                                <input type="number" id="supplier-payment-amount" step="1" required>
                            </div>
                            <div class="form-group">
                                <label>Payment Method</label>
                                <select id="supplier-payment-method" required>
                                    <option value="Cash">Cash</option>
                                    <option value="Mobile Money">Mobile Money</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Paid By</label>
                                <select id="supplier-payment-paid-by" required>
                                    <option value="ISAAC">ISAAC</option>
                                    <option value="BRIAN">BRIAN</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Notes</label>
                                <textarea id="supplier-payment-notes" rows="2" placeholder="Payment notes..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeSupplierPaymentForm()">Cancel</button>
                        <button type="submit" class="btn btn-success">üíæ Record Payment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings View -->
    <div class="readings-container" id="settings-view" style="display: none;">
        <div class="readings-header">
            <h2><span>‚öôÔ∏è</span> Settings</h2>
            <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
            <!-- Opening Stock Settings -->
            <div style="background: white; padding: 25px; border-radius: 15px;">
                <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">üì¶</span> Opening Stock
                </h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">PMS Opening Stock (Litres)</label>
                        <input type="number" id="settings-pms-stock" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;" step="0.01">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">AGO Opening Stock (Litres)</label>
                        <input type="number" id="settings-ago-stock" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;" step="0.01">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Effective Date</label>
                        <input type="date" id="settings-stock-date" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>
                    <button class="btn btn-primary" onclick="saveOpeningStock()" style="width: 100%;">Save Opening Stock</button>
                </div>
            </div>

            <!-- Opening Balance Settings -->
            <div style="background: white; padding: 25px; border-radius: 15px;">
                <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">üí∞</span> Opening Balance
                </h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Cash Opening Balance</label>
                        <input type="number" id="settings-cash-balance" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;" step="1">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">MoMo Opening Balance</label>
                        <input type="number" id="settings-momo-balance" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;" step="1">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Effective Date</label>
                        <input type="date" id="settings-balance-date" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>
                    <button class="btn btn-primary" onclick="saveOpeningBalance()" style="width: 100%;">Save Opening Balance</button>
                </div>
            </div>

            <!-- Pricing Settings -->
            <div style="background: white; padding: 25px; border-radius: 15px;">
                <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">üíµ</span> Fuel Prices
                </h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">PMS Selling Price</label>
                        <input type="number" id="settings-pms-selling" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;" step="1">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">AGO Selling Price</label>
                        <input type="number" id="settings-ago-selling" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;" step="1">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">PMS Cost Price</label>
                        <input type="number" id="settings-pms-cost" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;" step="1">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">AGO Cost Price</label>
                        <input type="number" id="settings-ago-cost" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;" step="1">
                    </div>
                    <button class="btn btn-primary" onclick="savePrices()" style="width: 100%;">Save Prices</button>
                </div>
            </div>

            <!-- Password Change -->
            <div style="background: white; padding: 25px; border-radius: 15px;">
                <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">üîê</span> Change Password
                </h3>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Current Password</label>
                        <input type="password" id="settings-current-password" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">New Password</label>
                        <input type="password" id="settings-new-password" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Confirm New Password</label>
                        <input type="password" id="settings-confirm-password" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>
                    <button class="btn btn-primary" onclick="changePassword()" style="width: 100%;">Change Password</button>
                </div>
            </div>

            <!-- BATCH 3: View Access Control (ISAAC Only) -->
            <div id="view-locking-section" style="background: white; padding: 25px; border-radius: 15px; display: none;">
                <h3 style="color: var(--danger); margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">üîí</span> View Access Control
                </h3>
                <p style="font-size: 12px; color: var(--gray); margin-bottom: 20px;">Manager Only - Lock views to restrict staff access</p>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;">
                        <label style="font-weight: 600; cursor: pointer;" for="lock-meters">üìä Meter Readings</label>
                        <input type="checkbox" id="lock-meters" onchange="toggleViewLock('meters')" style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;">
                        <label style="font-weight: 600; cursor: pointer;" for="lock-sales">üí∞ Sales Records</label>
                        <input type="checkbox" id="lock-sales" onchange="toggleViewLock('sales')" style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;">
                        <label style="font-weight: 600; cursor: pointer;" for="lock-purchases">üõí Purchases</label>
                        <input type="checkbox" id="lock-purchases" onchange="toggleViewLock('purchases')" style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;">
                        <label style="font-weight: 600; cursor: pointer;" for="lock-expenses">üí∏ Expenses</label>
                        <input type="checkbox" id="lock-expenses" onchange="toggleViewLock('expenses')" style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;">
                        <label style="font-weight: 600; cursor: pointer;" for="lock-credits">üí≥ Customer Credits</label>
                        <input type="checkbox" id="lock-credits" onchange="toggleViewLock('credits')" style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;">
                        <label style="font-weight: 600; cursor: pointer;" for="lock-supplierCredits">üè¢ Supplier Credits</label>
                        <input type="checkbox" id="lock-supplierCredits" onchange="toggleViewLock('supplierCredits')" style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;">
                        <label style="font-weight: 600; cursor: pointer;" for="lock-staffMaster">üë• Staff Master</label>
                        <input type="checkbox" id="lock-staffMaster" onchange="toggleViewLock('staffMaster')" style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;">
                        <label style="font-weight: 600; cursor: pointer;" for="lock-stockControl">üì¶ Stock Control</label>
                        <input type="checkbox" id="lock-stockControl" onchange="toggleViewLock('stockControl')" style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;">
                        <label style="font-weight: 600; cursor: pointer;" for="lock-profitLoss">üìà Profit & Loss</label>
                        <input type="checkbox" id="lock-profitLoss" onchange="toggleViewLock('profitLoss')" style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--light); border-radius: 8px;">
                        <label style="font-weight: 600; cursor: pointer;" for="lock-ledger">üìí Ledger</label>
                        <input type="checkbox" id="lock-ledger" onchange="toggleViewLock('ledger')" style="width: 20px; height: 20px; cursor: pointer;">
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px;">
                    <p style="font-size: 11px; color: #92400e; margin: 0;">
                        <strong>‚ö†Ô∏è Note:</strong> Checked views will be locked for all staff except ISAAC. Staff will see "Access Restricted" when trying to access locked views.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Master View -->
    <div class="readings-container" id="staff-master-view" style="display: none;">
        <div class="readings-header">
            <h2><span>üë®‚Äçüíº</span> Staff Master Database</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary btn-sm" onclick="showAddStaffModal()">+ Add Staff</button>
                <button class="btn btn-secondary btn-sm" onclick="showView('dashboard')">‚Üê Back to Dashboard</button>
            </div>
        </div>
        <div style="background: white; padding: 30px; border-radius: 15px;">
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                            <th style="padding: 12px; text-align: left;">Staff ID</th>
                            <th style="padding: 12px; text-align: left;">Photo</th>
                            <th style="padding: 12px; text-align: left;">Full Name</th>
                            <th style="padding: 12px; text-align: left;">Role</th>
                            <th style="padding: 12px; text-align: right;">Base Salary</th>
                            <th style="padding: 12px; text-align: center;">Status</th>
                            <th style="padding: 12px; text-align: left;">Phone</th>
                            <th style="padding: 12px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staff-master-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Staff Detail View -->
    <div class="readings-container" id="staff-detail-view" style="display: none;">
        <div class="readings-header">
            <h2><span>üë®‚Äçüíº</span> <span id="staff-detail-name">Staff Details</span></h2>
            <button class="btn btn-secondary btn-sm" onclick="showView('staff-master')">‚Üê Back to Staff Master</button>
        </div>
        
        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
            <!-- Staff Info Card -->
            <div style="background: white; padding: 25px; border-radius: 15px; height: fit-content;">
                <div id="staff-detail-photo" style="width: 250px; height: 250px; background: var(--light); border-radius: 15px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 100px;">üë§</div>
                <div id="staff-detail-info" style="display: flex; flex-direction: column; gap: 10px;"></div>
            </div>
            
            <!-- Financial Summary -->
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div style="background: white; padding: 25px; border-radius: 15px;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">Financial Summary</h3>
                    <div id="staff-financial-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
                </div>
                
                <div style="background: white; padding: 25px; border-radius: 15px;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">Transaction History</h3>
                    <div id="staff-transaction-history"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selection Popup -->
    <div id="selection-popup" class="selection-popup">
        <div class="selection-popup-content">
            <div class="selection-popup-header">
                <h3 id="selection-popup-title">Select Item</h3>
                <button class="selection-popup-close" onclick="closeSelectionPopup()">√ó</button>
            </div>
            <div class="selection-popup-search">
                <input type="text" id="selection-search" placeholder="üîç Search..." oninput="filterSelectionItems()">
            </div>
            <div class="selection-popup-list" id="selection-popup-list">
                <!-- Items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Staff Master Modal -->
    <div id="staff-modal" class="selection-popup" style="display: none;">
        <div class="selection-popup-content" style="max-width: 600px;">
            <div class="selection-popup-header">
                <h3 id="staff-modal-title">Add Staff Member</h3>
                <button class="selection-popup-close" onclick="closeStaffModal()">√ó</button>
            </div>
            <div class="selection-popup-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="staff-form" style="display: flex; flex-direction: column; gap: 15px;">
                    <input type="hidden" id="staff-id">
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Full Name *</label>
                        <input type="text" id="staff-fullname" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Role *</label>
                        <select id="staff-role" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="">Select Role</option>
                            <option value="Manager">Manager</option>
                            <option value="Pump Attendant">Pump Attendant</option>
                            <option value="Cashier">Cashier</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Security">Security</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Base Salary *</label>
                        <input type="number" id="staff-salary" required step="1" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Phone Number</label>
                        <input type="tel" id="staff-phone" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Address</label>
                        <textarea id="staff-address" rows="2" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;"></textarea>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Status</label>
                        <select id="staff-status" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="On Leave">On Leave</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Photo</label>
                        <input type="file" id="staff-photo-file" accept="image/*" onchange="handleStaffPhotoUpload(this)" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px;">
                        <div id="staff-photo-preview" style="width: 150px; height: 150px; border: 2px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: var(--light);">
                            <span style="color: var(--gray); font-size: 48px;">üì∑</span>
                        </div>
                        <textarea id="staff-photo" style="display: none;"></textarea>
                        <small style="color: var(--gray); display: block; margin-top: 5px;">Click above to select an image file (JPG, PNG, etc.)</small>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes</label>
                        <textarea id="staff-notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Save Staff</button>
                        <button type="button" class="btn btn-secondary" onclick="closeStaffModal()" style="flex: 1;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>

// Add this at the top of your OKUM HTML file, BEFORE the main <script> tag

const API_URL = 'https://script.google.com/macros/s/AKfycbxZTnBveiZZaCqAI6IaNkiY5mdOcegnUKdrC5fqYAtolZQOKBXD2W6vUpHit1WeIhMI3w/exec';  // ‚Üê Paste your URL here!

const CloudStorage = {
    async saveReading(data) {
        try {
            // üîç DEBUG LOG #5: Data Being Sent to Backend
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç DEBUG #5: SENDING TO BACKEND');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('data.shift:', data.shift);
            console.log('data.pump:', data.pump);
            console.log('data.staff:', data.staff);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('PAYLOAD TO BACKEND:');
            console.log(JSON.stringify({
                action: 'saveReading',
                data: {
                    id: data.id,
                    shift: data.shift,
                    pump: data.pump,
                    staff: data.staff
                }
            }, null, 2));
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'saveReading',
                    data: data
                })
            });
            return await response.json();
        } catch (error) {
            console.error('Cloud save failed:', error);
            return { success: false, error: error.message };
        }
    },
    
    async savePurchase(data) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'savePurchase',
                    data: data
                })
            });
            return await response.json();
        } catch (error) {
            console.error('Cloud save failed:', error);
            return { success: false, error: error.message };
        }
    },
    
    async saveExpense(data) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'saveExpense',
                    data: data
                })
            });
            return await response.json();
        } catch (error) {
            console.error('Cloud save failed:', error);
            return { success: false, error: error.message };
        }
    },
    
    async saveCreditPayment(data) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'saveCreditPayment',
                    data: data
                })
            });
            return await response.json();
        } catch (error) {
            console.error('Cloud save failed:', error);
            return { success: false, error: error.message };
        }
    },
    
    async saveSupplierPayment(data) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'saveSupplierPayment',
                    data: data
                })
            });
            return await response.json();
        } catch (error) {
            console.error('Cloud save failed:', error);
            return { success: false, error: error.message };
        }
    }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOUD SYNC - Manual sync only (no auto-override)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Note: Each save function calls CloudStorage directly to prevent double syncing

console.log('‚òÅÔ∏è Cloud sync enabled!');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOUD BADGE STATUS MANAGEMENT (15 second max display)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updateCloudBadge(status) {
    const badge = document.getElementById('cloud-status-badge');
    const icon = document.getElementById('cloud-status-icon');
    const text = document.getElementById('cloud-status-text');
    
    if (!badge || !icon || !text) return;
    
    switch(status) {
        case 'syncing':
            icon.textContent = '‚òÅÔ∏è';
            text.textContent = 'Syncing...';
            badge.style.background = '#dbeafe';
            badge.style.color = '#1e40af';
            badge.style.display = 'inline-flex';
            break;
        case 'synced':
            icon.textContent = '‚úÖ';
            text.textContent = 'Synced';
            badge.style.background = '#d1fae5';
            badge.style.color = '#065f46';
            badge.style.display = 'inline-flex';
            // Back to ready after 2 seconds
            setTimeout(() => {
                icon.textContent = '‚òÅÔ∏è';
                text.textContent = 'Ready';
                badge.style.background = '#f3f4f6';
                badge.style.color = '#374151';
            }, 2000);
            break;
        case 'error':
            icon.textContent = '‚ùå';
            text.textContent = 'Error';
            badge.style.background = '#fee2e2';
            badge.style.color = '#991b1b';
            badge.style.display = 'inline-flex';
            // Back to ready after 5 seconds
            setTimeout(() => {
                icon.textContent = '‚òÅÔ∏è';
                text.textContent = 'Ready';
                badge.style.background = '#f3f4f6';
                badge.style.color = '#374151';
            }, 5000);
            break;
        case 'offline':
            icon.textContent = 'üî¥';
            text.textContent = 'Offline';
            badge.style.background = '#f3f4f6';
            badge.style.color = '#6b7280';
            badge.style.display = 'inline-flex';
            break;
        case 'online':
            icon.textContent = 'üü¢';
            text.textContent = 'Online';
            badge.style.background = '#d1fae5';
            badge.style.color = '#065f46';
            badge.style.display = 'inline-flex';
            // Back to ready after 2 seconds
            setTimeout(() => {
                icon.textContent = '‚òÅÔ∏è';
                text.textContent = 'Ready';
                badge.style.background = '#f3f4f6';
                badge.style.color = '#374151';
            }, 2000);
            break;
        default:
            icon.textContent = '‚òÅÔ∏è';
            text.textContent = 'Ready';
            badge.style.background = '#f3f4f6';
            badge.style.color = '#374151';
            badge.style.display = 'inline-flex';
    }
}

// Hide badge by default after page load (15 seconds after initial display)
setTimeout(() => {
    const badges = document.querySelectorAll('.cloud-badge, .cloud-status-badge, .realtime-badge');
    badges.forEach(badge => badge.style.display = 'none');
}, 15000);

// Check online status
window.addEventListener('online', () => updateCloudBadge('online'));
window.addEventListener('offline', () => updateCloudBadge('offline'));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN SYSTEM LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Data Storage
        // User Management System
        const defaultUsers = [
            { username: 'admin', password: 'admin123', name: 'Administrator', role: 'Admin' },
            { username: 'isaac', password: 'isaac123', name: 'Isaac', role: 'Manager' },
            { username: 'staff', password: 'staff123', name: 'Staff Member', role: 'Staff' }
        ];
        
        // Initialize users - ensure it always works
        let users;
        try {
            const storedUsers = localStorage.getItem('users');
            if (storedUsers) {
                users = JSON.parse(storedUsers);
            }
            // Validate that users is an array
            if (!users || !Array.isArray(users) || users.length === 0) {
                throw new Error('Invalid users');
            }
        } catch (e) {
            console.log('Initializing default users...');
            users = defaultUsers;
            localStorage.setItem('users', JSON.stringify(defaultUsers));
        }
        
        let currentUser = null;
        try {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser && storedUser !== 'null') {
                currentUser = JSON.parse(storedUser);
            }
        } catch (e) {
            currentUser = null;
        }

        // Data arrays
        let readings = JSON.parse(localStorage.getItem('readings') || '[]');
        let purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
        let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
        let creditPayments = JSON.parse(localStorage.getItem('creditPayments') || '[]');
        let supplierPayments = JSON.parse(localStorage.getItem('supplierPayments') || '[]');
        let lossPayments = JSON.parse(localStorage.getItem('lossPayments') || '[]');
        let loanFinePayments = JSON.parse(localStorage.getItem('loanFinePayments') || '[]');
        let staffMaster = JSON.parse(localStorage.getItem('staffMaster') || '[]');
        let settings = JSON.parse(localStorage.getItem('settings') || JSON.stringify({
            openingStock: { pms: 0, ago: 0, date: new Date().toISOString().split('T')[0] },
            openingBalance: { cash: 0, momo: 0, date: new Date().toISOString().split('T')[0] },
            prices: { pmsSelling: 5200, agoSelling: 4800, pmsCost: 5000, agoCost: 4600 }
        }));
        let viewLocks = JSON.parse(localStorage.getItem('viewLocks') || JSON.stringify({
            meters: false,
            sales: false,
            purchases: false,
            expenses: false,
            staffMaster: false,
            credits: false,
            supplierCredits: false,
            stockControl: false,
            profitLoss: false,
            ledger: false
        }));
        let wizardData = {
            credits: [],
            momos: [],
            pettyCash: []
        };
        let currentReadings = readings; // For filtering

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('wiz-date').value = today;
            document.getElementById('quick-date').value = today;
            
            // IMPROVEMENT 1: Auto-populate wizard prices from settings
            if (settings.prices) {
                document.getElementById('wiz-pms-price').value = settings.prices.pmsSelling || 5200;
                document.getElementById('wiz-ago-price').value = settings.prices.agoSelling || 4800;
            }
            
            // Setup auto-calculations
            setupWizardCalculations();
            
            updateStats();
            renderReadings();
        });

        function setupWizardCalculations() {
            // Real-time calculations for Step 2
            document.getElementById('wiz-pms-close').addEventListener('input', calculateWizardMeters);
            document.getElementById('wiz-ago-close').addEventListener('input', calculateWizardMeters);
            
            // Real-time calculations for Step 3
            document.getElementById('wiz-pms-price').addEventListener('input', calculateWizardSales);
            document.getElementById('wiz-ago-price').addEventListener('input', calculateWizardSales);
            document.getElementById('wiz-cash').addEventListener('input', calculateWizardBalance);
            document.getElementById('wiz-momo').addEventListener('input', calculateWizardBalance);
            document.getElementById('wiz-credits').addEventListener('input', calculateWizardBalance);
            
            // Also recalculate when sales litres change (shouldn't normally happen but just in case)
            document.getElementById('wiz-pms-sales').addEventListener('input', calculateWizardSales);
            document.getElementById('wiz-ago-sales').addEventListener('input', calculateWizardSales);
            
            // Purchase form calculations
            const purchaseLitres = document.getElementById('purchase-litres');
            const purchasePrice = document.getElementById('purchase-price-per-liter');
            const purchasePaid = document.getElementById('purchase-amount-paid');
            if (purchaseLitres && purchasePrice && purchasePaid) {
                purchaseLitres.addEventListener('input', calculatePurchaseTotal);
                purchasePrice.addEventListener('input', calculatePurchaseTotal);
                purchasePaid.addEventListener('input', calculatePurchaseBalance);
            }
        }

        // Transaction Management Functions
        function addCredit() {
            const customer = document.getElementById('credit-customer').value.trim();
            const amount = parseFloat(document.getElementById('credit-amount').value) || 0;
            const fuel = document.getElementById('credit-fuel').value;

            if (!customer || amount <= 0) {
                showAlert('Please enter customer name and amount', 'error');
                return;
            }

           const credit = {
 	   creditId: crypto.randomUUID(), // ‚úÖ CORRECT ID
  	   customer,
  	   amount,
  	  fuel
	    };

	 wizardData.credits.push(credit);
	 renderCredits();
	 updateCreditsTotal();


            // Clear form
            document.getElementById('credit-customer').value = '';
            document.getElementById('credit-amount').value = '';
        }

        function removeCredit(id) {
            wizardData.credits = wizardData.credits.filter(c => c.id !== id);
            renderCredits();
            updateCreditsTotal();
        }

        function renderCredits() {
            const container = document.getElementById('credits-list');
            
            if (wizardData.credits.length === 0) {
                container.innerHTML = '<div class="empty-list">No credit transactions added yet</div>';
                return;
            }

            container.innerHTML = wizardData.credits.map(c => `
                <div class="transaction-item">
                    <div class="transaction-details">
                        <div class="transaction-name">${c.customer}</div>
                        <div class="transaction-meta">${c.fuel}</div>
                    </div>
                    <div class="transaction-amount">UGX ${formatNumber(c.amount)}</div>
                    <button class="btn btn-danger btn-sm" onclick="removeCredit(${c.id})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateCreditsTotal() {
            const total = wizardData.credits.reduce((sum, c) => sum + c.amount, 0);
            document.getElementById('credits-total').textContent = formatNumber(total);
        }

        function addMomo() {
            const customer = document.getElementById('momo-customer').value.trim();
            const amount = parseFloat(document.getElementById('momo-amount').value) || 0;
            const provider = document.getElementById('momo-provider').value;

            if (!customer || amount <= 0) {
                showAlert('Please enter reference and amount', 'error');
                return;
            }

            const momo = {
                id: Date.now(),
                customer,
                amount,
                provider
            };

            wizardData.momos.push(momo);
            renderMomos();
            updateMomosTotal();

            // Clear form
            document.getElementById('momo-customer').value = '';
            document.getElementById('momo-amount').value = '';
        }

        function removeMomo(id) {
            wizardData.momos = wizardData.momos.filter(m => m.id !== id);
            renderMomos();
            updateMomosTotal();
        }

        function renderMomos() {
            const container = document.getElementById('momo-list');
            
            if (wizardData.momos.length === 0) {
                container.innerHTML = '<div class="empty-list">No mobile money transactions added yet</div>';
                return;
            }

            container.innerHTML = wizardData.momos.map(m => `
                <div class="transaction-item">
                    <div class="transaction-details">
                        <div class="transaction-name">${m.customer}</div>
                        <div class="transaction-meta">${m.provider}</div>
                    </div>
                    <div class="transaction-amount">UGX ${formatNumber(m.amount)}</div>
                    <button class="btn btn-danger btn-sm" onclick="removeMomo(${m.id})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateMomosTotal() {
            const total = wizardData.momos.reduce((sum, m) => sum + m.amount, 0);
            document.getElementById('momo-total').textContent = formatNumber(total);
        }

        function addPettyCash() {
            const desc = document.getElementById('petty-desc').value.trim();
            const amount = parseFloat(document.getElementById('petty-amount').value) || 0;
            const category = document.getElementById('petty-category').value;

            if (!desc || amount <= 0) {
                showAlert('Please enter description and amount', 'error');
                return;
            }

            const petty = {
                id: Date.now(),
                description: desc,
                amount,
                category
            };

            wizardData.pettyCash.push(petty);
            renderPettyCash();
            updatePettyTotal();

            // Clear form
            document.getElementById('petty-desc').value = '';
            document.getElementById('petty-amount').value = '';
        }

        function removePettyCash(id) {
            wizardData.pettyCash = wizardData.pettyCash.filter(p => p.id !== id);
            renderPettyCash();
            updatePettyTotal();
        }

        function renderPettyCash() {
            const container = document.getElementById('petty-list');
            
            if (wizardData.pettyCash.length === 0) {
                container.innerHTML = '<div class="empty-list">No petty cash expenses added yet</div>';
                return;
            }

            container.innerHTML = wizardData.pettyCash.map(p => `
                <div class="transaction-item">
                    <div class="transaction-details">
                        <div class="transaction-name">${p.description}</div>
                        <div class="transaction-meta">${p.category}</div>
                    </div>
                    <div class="transaction-amount">UGX ${formatNumber(p.amount)}</div>
                    <button class="btn btn-danger btn-sm" onclick="removePettyCash(${p.id})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updatePettyTotal() {
            const total = wizardData.pettyCash.reduce((sum, p) => sum + p.amount, 0);
            document.getElementById('petty-total').textContent = formatNumber(total);
        }

        // Wizard Functions
        function openWizard() {
            document.getElementById('wizard-modal').classList.add('show');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('wiz-date').value = today;
            
            // Initialize transaction lists
            wizardData.credits = [];
            wizardData.momos = [];
            wizardData.pettyCash = [];
            renderCredits();
            renderMomos();
            renderPettyCash();
            updateCreditsTotal();
            updateMomosTotal();
            updatePettyTotal();
            
            // FIX 2: Load settings fresh and apply selling prices
            settings = JSON.parse(localStorage.getItem('settings')) || {
                opening: { pms: 0, ago: 0, cash: 0 },
                prices: { pmsSelling: 5200, agoSelling: 4800, pmsCost: 5000, agoCost: 4600 },
                password: 'admin123'
            };
            
            // Initialize Step 3 fields with prices from settings
            document.getElementById('wiz-pms-price').value = settings.prices.pmsSelling || 5800;
            document.getElementById('wiz-ago-price').value = settings.prices.agoSelling || 5600;
            document.getElementById('wiz-cash').value = '0';
            document.getElementById('wiz-momo').value = '0';
            document.getElementById('wiz-credits').value = '0';
            
            // Initialize summary
            document.getElementById('summary-sales').textContent = 'UGX 0';
            document.getElementById('summary-collected').textContent = 'UGX 0';
            document.getElementById('summary-balance').textContent = 'UGX 0';
            
            // Trigger calculation to show initial values
            calculateWizardSales();
        }

        function closeWizard() {
            if (confirm('Close wizard? All unsaved data will be lost.')) {
                document.getElementById('wizard-modal').classList.remove('show');
                resetWizard();
            }
        }

        function resetWizard() {
            document.getElementById('wizard-step-1').classList.add('active');
            document.getElementById('wizard-step-2').classList.remove('active');
            document.getElementById('wizard-step-3').classList.remove('active');
            
            document.querySelectorAll('.wizard-step').forEach(s => {
                s.classList.remove('active', 'completed');
            });
            document.querySelector('[data-step="1"]').classList.add('active');
            
            wizardData = {
                credits: [],
                momos: [],
                pettyCash: []
            };
        }

        function wizardNext(step) {
            if (step === 1) {
                const date = document.getElementById('wiz-date').value;
                const shift = document.getElementById('wiz-shift').value;
                const pump = document.getElementById('wiz-pump').value;
                const attendant = document.getElementById('wiz-attendant').value;
                
                // üîç DEBUG LOG #1: Form Input Values
                console.log('');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üîç DEBUG #1: STEP 1 - FORM INPUT VALUES');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('Date input:', date);
                console.log('Shift input:', shift);
                console.log('Pump input:', pump);
                console.log('Attendant input:', attendant);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('');
                
                if (!date || !shift || !pump || !attendant) {
                    showAlert('Please fill all required fields', 'error');
                    return;
                }
                
                // Preserve credits, momos, pettyCash arrays!
                wizardData.date = date;
                wizardData.shift = shift;
                wizardData.pump = pump;
                wizardData.attendant = attendant;
                
                // üîç DEBUG LOG #2: wizardData After Assignment
                console.log('');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üîç DEBUG #2: STEP 1 - wizardData ASSIGNED');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('wizardData.date:', wizardData.date);
                console.log('wizardData.shift:', wizardData.shift);
                console.log('wizardData.pump:', wizardData.pump);
                console.log('wizardData.attendant:', wizardData.attendant);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('');
                
                loadPreviousMeters();
                
                document.getElementById('wizard-step-1').classList.remove('active');
                document.getElementById('wizard-step-2').classList.add('active');
                
                document.querySelector('[data-step="1"]').classList.remove('active');
                document.querySelector('[data-step="1"]').classList.add('completed');
                document.querySelector('[data-step="2"]').classList.add('active');
                
            } else if (step === 2) {
                // Get values
                const pmsClose = parseFloat(document.getElementById('wiz-pms-close').value);
                const agoClose = parseFloat(document.getElementById('wiz-ago-close').value);
                const pmsOpen = parseFloat(document.getElementById('wiz-pms-open').value) || 0;
                const agoOpen = parseFloat(document.getElementById('wiz-ago-open').value) || 0;
                
                console.log('Step 2 values:', {pmsClose, agoClose, pmsOpen, agoOpen});
                
                // Simple validation - just need numbers
                if (isNaN(pmsClose) || isNaN(agoClose)) {
                    showAlert('‚ö†Ô∏è Please enter closing meters for both PMS and AGO', 'error');
                    return;
                }
                
                // Save to wizardData
                wizardData.pmsOpen = pmsOpen;
                wizardData.pmsClose = pmsClose;
                wizardData.pmsLitres = Math.max(0, pmsClose - pmsOpen);
                wizardData.agoOpen = agoOpen;
                wizardData.agoClose = agoClose;
                wizardData.agoLitres = Math.max(0, agoClose - agoOpen);
                
                console.log('‚úì Step 2 data saved, moving to Step 3');
                
                // Move to Step 3 immediately
                document.getElementById('wizard-step-2').classList.remove('active');
                document.getElementById('wizard-step-3').classList.add('active');
                
                document.querySelector('[data-step="2"]').classList.remove('active');
                document.querySelector('[data-step="2"]').classList.add('completed');
                document.querySelector('[data-step="3"]').classList.add('active');
                
                // Now populate Step 3 fields
                document.getElementById('wiz-pms-sales').value = wizardData.pmsLitres.toFixed(2);
                document.getElementById('wiz-ago-sales').value = wizardData.agoLitres.toFixed(2);
                
                // Calculate sales
                setTimeout(() => {
                    calculateWizardSales();
                    
                    setTimeout(() => {
                        // Get Step 1 totals
                        const creditsTotal = (wizardData.credits || []).reduce((sum, c) => sum + c.amount, 0);
                        const momoTotal = (wizardData.momos || []).reduce((sum, m) => sum + m.amount, 0);
                        const pettyTotal = (wizardData.pettyCash || []).reduce((sum, p) => sum + p.amount, 0);
                        
                        // Update Step 1 summary display
                        const hasTransactions = creditsTotal > 0 || momoTotal > 0 || pettyTotal > 0;
                        const summarySection = document.getElementById('step1-summary');
                        
                        if (hasTransactions && summarySection) {
                            summarySection.style.display = 'block';
                            document.getElementById('step1-credits-display').textContent = 'UGX ' + formatNumber(creditsTotal);
                            document.getElementById('step1-credits-count').textContent = (wizardData.credits || []).length + ' entries';
                            document.getElementById('step1-momo-display').textContent = 'UGX ' + formatNumber(momoTotal);
                            document.getElementById('step1-momo-count').textContent = (wizardData.momos || []).length + ' entries';
                            document.getElementById('step1-petty-display').textContent = 'UGX ' + formatNumber(pettyTotal);
                            document.getElementById('step1-petty-count').textContent = (wizardData.pettyCash || []).length + ' entries';
                        } else if (summarySection) {
                            summarySection.style.display = 'none';
                        }
                        
                        // Auto-fill payment fields
                        document.getElementById('wiz-credits').value = creditsTotal.toFixed(0);
                        document.getElementById('wiz-momo').value = momoTotal.toFixed(0);
                        
                        const totalSales = parseFloat(document.getElementById('wiz-pms-total').value || 0) + 
                                          parseFloat(document.getElementById('wiz-ago-total').value || 0);
                        const cashAmount = totalSales - creditsTotal - momoTotal - pettyTotal;
                        document.getElementById('wiz-cash').value = Math.max(0, cashAmount).toFixed(0);
                        
                        calculateWizardBalance();
                        console.log('‚úì Step 3 populated successfully');
                    }, 100);
                }, 100);
            }
        }

        function wizardPrev(step) {
            if (step === 2) {
                document.getElementById('wizard-step-2').classList.remove('active');
                document.getElementById('wizard-step-1').classList.add('active');
                
                document.querySelector('[data-step="2"]').classList.remove('active');
                document.querySelector('[data-step="1"]').classList.remove('completed');
                document.querySelector('[data-step="1"]').classList.add('active');
                
            } else if (step === 3) {
                document.getElementById('wizard-step-3').classList.remove('active');
                document.getElementById('wizard-step-2').classList.add('active');
                
                document.querySelector('[data-step="3"]').classList.remove('active');
                document.querySelector('[data-step="2"]').classList.remove('completed');
                document.querySelector('[data-step="2"]').classList.add('active');
                
                // Recalculate when coming back to Step 2
                calculateWizardMeters();
            }
        }

        async function loadPreviousMeters() {
            // üåê FETCH FROM CLOUD IF NO LOCAL READINGS
            if (readings.length === 0 && typeof API_URL !== 'undefined' && API_URL) {
                console.log('üì° No local readings, fetching from cloud...');
                try {
                    const response = await fetch(`${API_URL}?action=getReadings`);
                    const result = await response.json();
                    if (result.success && result.data && result.data.length > 0) {
                        readings = result.data;
                        localStorage.setItem('readings', JSON.stringify(readings));
                        console.log(`‚úÖ Loaded ${readings.length} readings from cloud`);
                    }
                } catch (error) {
                    console.error('‚ùå Failed to fetch from cloud:', error);
                }
            }
            
            const pump = wizardData.pump;
            const currentDate = new Date(wizardData.date);
            const currentShift = wizardData.shift;
            
            // Filter readings for same pump
            const pumpReadings = readings.filter(r => r.pump === pump);
            
            if (pumpReadings.length === 0) {
                // No previous readings for this pump
                document.getElementById('wiz-pms-open').value = 0;
                document.getElementById('wiz-ago-open').value = 0;
                
                const pmsInfo = document.getElementById('pms-open-info');
                pmsInfo.textContent = '‚ö†Ô∏è No previous reading found. Starting from 0.';
                pmsInfo.classList.add('show');
                
                const agoInfo = document.getElementById('ago-open-info');
                agoInfo.textContent = '‚ö†Ô∏è No previous reading found. Starting from 0.';
                agoInfo.classList.add('show');
                return;
            }
            
            // Sort readings chronologically (most recent first)
            const sortedReadings = pumpReadings.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                
                // Compare dates first
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateB - dateA; // Most recent date first
                }
                
                // Same date - compare shifts (EVENING comes after MORNING)
                const shiftOrder = { 'MORNING': 0, 'EVENING': 1 };
                return (shiftOrder[b.shift] || 0) - (shiftOrder[a.shift] || 0);
            });
            
            // Find the most recent reading BEFORE current date/shift
            let previousReading = null;
            
            for (let reading of sortedReadings) {
                const readingDate = new Date(reading.date);
                const shiftOrder = { 'MORNING': 0, 'EVENING': 1 };
                
                // Check if this reading is before current date/shift
                if (readingDate < currentDate) {
                    previousReading = reading;
                    break;
                } else if (readingDate.getTime() === currentDate.getTime()) {
                    // Same date - check shift order
                    if ((shiftOrder[reading.shift] || 0) < (shiftOrder[currentShift] || 0)) {
                        previousReading = reading;
                        break;
                    }
                }
            }
            
            if (previousReading) {
                document.getElementById('wiz-pms-open').value = previousReading.pmsClose || 0;
                document.getElementById('wiz-ago-open').value = previousReading.agoClose || 0;
                
                wizardData.pmsOpen = previousReading.pmsClose || 0;
                wizardData.agoOpen = previousReading.agoClose || 0;
                
                const pmsInfo = document.getElementById('pms-open-info');
                pmsInfo.textContent = `üîÑ Auto-loaded from ${previousReading.date} ${previousReading.shift} (${previousReading.id})`;
                pmsInfo.classList.add('show');
                
                const agoInfo = document.getElementById('ago-open-info');
                agoInfo.textContent = `üîÑ Auto-loaded from ${previousReading.date} ${previousReading.shift} (${previousReading.id})`;
                agoInfo.classList.add('show');
            } else {
                document.getElementById('wiz-pms-open').value = 0;
                document.getElementById('wiz-ago-open').value = 0;
                
                const pmsInfo = document.getElementById('pms-open-info');
                pmsInfo.textContent = '‚ö†Ô∏è No previous reading found. Starting from 0.';
                pmsInfo.classList.add('show');
                
                const agoInfo = document.getElementById('ago-open-info');
                agoInfo.textContent = '‚ö†Ô∏è No previous reading found. Starting from 0.';
                agoInfo.classList.add('show');
            }
        }

        function calculateWizardMeters() {
            const pmsOpen = parseFloat(document.getElementById('wiz-pms-open').value) || 0;
            const pmsClose = parseFloat(document.getElementById('wiz-pms-close').value) || 0;
            const agoOpen = parseFloat(document.getElementById('wiz-ago-open').value) || 0;
            const agoClose = parseFloat(document.getElementById('wiz-ago-close').value) || 0;
            
            document.getElementById('wiz-pms-litres').value = Math.max(0, pmsClose - pmsOpen).toFixed(2);
            document.getElementById('wiz-ago-litres').value = Math.max(0, agoClose - agoOpen).toFixed(2);
        }

        function calculateWizardSales() {
            const pmsLitres = parseFloat(document.getElementById('wiz-pms-sales').value) || 0;
            const pmsPrice = parseFloat(document.getElementById('wiz-pms-price').value) || 0;
            const agoLitres = parseFloat(document.getElementById('wiz-ago-sales').value) || 0;
            const agoPrice = parseFloat(document.getElementById('wiz-ago-price').value) || 0;
            
            const pmsTotal = pmsLitres * pmsPrice;
            const agoTotal = agoLitres * agoPrice;
            
            document.getElementById('wiz-pms-total').value = pmsTotal.toFixed(0);
            document.getElementById('wiz-ago-total').value = agoTotal.toFixed(0);
            
            // Always recalculate balance when sales change
            setTimeout(() => calculateWizardBalance(), 100);
        }

        function calculateWizardBalance() {
            const pmsTotal = parseFloat(document.getElementById('wiz-pms-total').value) || 0;
            const agoTotal = parseFloat(document.getElementById('wiz-ago-total').value) || 0;
            const cash = parseFloat(document.getElementById('wiz-cash').value) || 0;
            const momo = parseFloat(document.getElementById('wiz-momo').value) || 0;
            const credits = parseFloat(document.getElementById('wiz-credits').value) || 0;
            const totalPetty = wizardData.pettyCash.reduce((sum, p) => sum + p.amount, 0);
            
            const totalSales = pmsTotal + agoTotal;
            const totalCollected = cash + momo + credits;
            const rawDifference = totalSales - totalCollected;
            
            // Losses = Raw Difference - Petty Cash Expenses
            // (Because petty cash is legitimate expense, not a loss)
            const losses = Math.max(0, rawDifference - totalPetty);
            
            // Update summary with formatted numbers
            document.getElementById('summary-sales').textContent = 'UGX ' + formatNumber(totalSales);
            document.getElementById('summary-collected').textContent = 'UGX ' + formatNumber(totalCollected);
            document.getElementById('summary-balance').textContent = 'UGX ' + formatNumber(losses);
            
            console.log('Balance calculated:', {totalSales, totalCollected, rawDifference, totalPetty, losses}); // Debug log
        }

        function completeWizard() {
            // Prevent duplicate submissions
            if (window.isSubmitting) {
                showAlert('‚è≥ Please wait, saving in progress...', 'info');
                return;
            }
            window.isSubmitting = true;
            
            // FIX 3: Reload expenses from localStorage to get accurate count for ID generation
            expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            
            const totalCredits = wizardData.credits.reduce((sum, c) => sum + c.amount, 0);
            const totalMomos = wizardData.momos.reduce((sum, m) => sum + m.amount, 0);
            const totalPetty = wizardData.pettyCash.reduce((sum, p) => sum + p.amount, 0);
            
            // Calculate sales and collections
            const totalSales = parseFloat(document.getElementById('wiz-pms-total').value) + 
                              parseFloat(document.getElementById('wiz-ago-total').value);
            const cash = parseFloat(document.getElementById('wiz-cash').value);
            const momo = parseFloat(document.getElementById('wiz-momo').value);
            const credits = parseFloat(document.getElementById('wiz-credits').value);
            const totalCollected = cash + momo + credits;
            
            // Calculate losses: (Total Sales - Total Collection) - Petty Cash
            // This gives us only the actual shortage, not including legitimate expenses
            const rawDifference = totalSales - totalCollected;
            const losses = Math.max(0, rawDifference - totalPetty);
            
            // Calculate totalCollected (cash + momo + credits)
            const collectedAmount = cash + momo + credits;
            
            // Generate reading ID first
            const readingId = generateId();
            
            // üîç DEBUG LOG #3: Before Creating Reading Object
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç DEBUG #3: BEFORE CREATING READING OBJECT');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('wizardData.shift:', wizardData.shift);
            console.log('wizardData.pump:', wizardData.pump);
            console.log('wizardData.attendant:', wizardData.attendant);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            // Update credit IDs to match backend format
            const creditsWithBackendIds = wizardData.credits.map((credit, index) => ({
                ...credit,
                id: `CR-${readingId}-${index + 1}`
            }));
            
            // ‚úÖ CREATE READING OBJECT - EXACT BACKEND ORDER
            const reading = {};
            reading.id = readingId;
            reading.date = wizardData.date;
            reading.shift = wizardData.shift;
            reading.pump = wizardData.pump;
            reading.staff = wizardData.attendant;
            reading.pmsOpen = wizardData.pmsOpen;
            reading.pmsClose = wizardData.pmsClose;
            reading.pmsSold = wizardData.pmsLitres;
            reading.agoOpen = wizardData.agoOpen;
            reading.agoClose = wizardData.agoClose;
            reading.agoSold = wizardData.agoLitres;
            reading.pmsPrice = parseFloat(document.getElementById('wiz-pms-price').value);
            reading.agoPrice = parseFloat(document.getElementById('wiz-ago-price').value);
            reading.pmsSales = parseFloat(document.getElementById('wiz-pms-total').value);
            reading.agoSales = parseFloat(document.getElementById('wiz-ago-total').value);
            reading.totalSales = totalSales;
            reading.cash = cash;
            reading.momo = momo;
            reading.credits = credits;
            reading.totalCollected = collectedAmount;
            reading.pettyCash = totalPetty;
            reading.losses = losses;
            reading.witness = document.getElementById('wiz-witness').value || '';
            reading.preparedBy = currentUser ? currentUser.name : 'Unknown';
            reading.timestamp = new Date().toISOString();
            // Additional data (not in sheet columns but useful for app)
            reading.creditTransactions = creditsWithBackendIds;
            reading.momoTransactions = wizardData.momos;
            reading.pettyCashTransactions = wizardData.pettyCash;
            reading.totalCreditsAmount = totalCredits;
            reading.totalMomosAmount = totalMomos;
            reading.totalPettyCashAmount = totalPetty;
            reading.type = 'wizard';
            
            // üîç DEBUG LOG #4: Final Reading Object
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç DEBUG #4: FINAL READING OBJECT');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('reading.id:', reading.id);
            console.log('reading.date:', reading.date);
            console.log('reading.shift:', reading.shift);
            console.log('reading.pump:', reading.pump);
            console.log('reading.staff:', reading.staff);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('FULL READING OBJECT:');
            console.log(JSON.stringify(reading, null, 2));
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            readings.push(reading);
            localStorage.setItem('readings', JSON.stringify(readings));
            
            // Sync reading to cloud
            if (typeof CloudStorage !== 'undefined' && CloudStorage.saveReading) {
                console.log('‚òÅÔ∏è Syncing reading to cloud:', reading.id);
                if (typeof updateCloudBadge === 'function') updateCloudBadge('syncing');
                
                CloudStorage.saveReading(reading).then(result => {
                    if (result && result.success) {
                        console.log('‚úÖ Reading synced to cloud');
                        if (typeof updateCloudBadge === 'function') updateCloudBadge('synced');
                    } else {
                        if (typeof updateCloudBadge === 'function') updateCloudBadge('error');
                    }
                }).catch(error => {
                    console.error('‚ùå Reading cloud sync error:', error);
                    if (typeof updateCloudBadge === 'function') updateCloudBadge('error');
                });
            }
            
            // FIX 2: Save petty cash as ONE summary entry per shift (not individual breakdown)
            if (wizardData.pettyCash.length > 0) {
                const totalPettyCash = wizardData.pettyCash.reduce((sum, p) => sum + p.amount, 0);
                
                // Create transaction count instead of full breakdown
                const transactionCount = wizardData.pettyCash.length;
                
                const pettyCashExpense = {
                    id: (() => {
                    // Calculate proper max ID
                    let maxId = 0;
                    expenses.forEach(e => {
                        const match = e.id.match(/EX\s*(\d+)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            if (num > maxId) maxId = num;
                        }
                    });
                    return `EX ${String(maxId + 1).padStart(4, '0')}`;
                })(),
                    date: wizardData.date,
                    category: 'Petty Cash',
                    description: `Total pettycash - ${transactionCount} transaction${transactionCount !== 1 ? 's' : ''}`,
                    amount: totalPettyCash,
                    paymentMethod: 'Cash',
                    paidTo: 'Staff',
                    reference: reading.id,
                    approvedBy: wizardData.attendant,
                    recordedBy: wizardData.attendant,
                    receiptAvailable: 'No',
                    notes: `${wizardData.shift} Shift - ${wizardData.pump}`,
                    status: 'Paid',
                    timestamp: new Date().toISOString()
                };
                
                expenses.push(pettyCashExpense);
                
                // Sync expense to cloud
                if (typeof CloudStorage !== 'undefined' && CloudStorage.saveExpense) {
                    console.log('‚òÅÔ∏è Syncing petty cash expense to cloud:', pettyCashExpense.id);
                    CloudStorage.saveExpense(pettyCashExpense).then(result => {
                        if (result && result.success) {
                            console.log('‚úÖ Expense synced to cloud');
                        }
                    }).catch(error => {
                        console.error('‚ùå Expense cloud sync error:', error);
                    });
                }
            }
            
            if (expenses.length > 0) {
                localStorage.setItem('expenses', JSON.stringify(expenses));
            }
            
            showAlertAndReload('‚úÖ Shift completed successfully! Reading ID: ' + reading.id, 'success');
            
            // Reset submission flag
            window.isSubmitting = false;
            
            closeWizard();
        }

        // Quick Entry Functions
        function openQuickEntry() {
            document.getElementById('quick-modal').classList.add('show');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quick-date').value = today;
        }

        function closeQuickEntry() {
            document.getElementById('quick-modal').classList.remove('show');
            document.getElementById('quick-form').reset();
        }

        function saveQuickEntry(event) {
            event.preventDefault();
            
            const pmsPrev = parseFloat(document.getElementById('quick-pms-prev').value) || 0;
            const pmsCurr = parseFloat(document.getElementById('quick-pms-curr').value) || 0;
            const agoPrev = parseFloat(document.getElementById('quick-ago-prev').value) || 0;
            const agoCurr = parseFloat(document.getElementById('quick-ago-curr').value) || 0;
            
            const reading = {
                id: generateId(),
                date: document.getElementById('quick-date').value,
                shift: document.getElementById('quick-shift').value,
                pump: document.getElementById('quick-pump').value,
                staff: document.getElementById('quick-staff').value,
                pmsOpen: pmsPrev,
                pmsClose: pmsCurr,
                pmsSold: pmsCurr - pmsPrev,
                agoOpen: agoPrev,
                agoClose: agoCurr,
                agoSold: agoCurr - agoPrev,
                timestamp: new Date().toISOString(),
                type: 'quick'
            };
            
            readings.push(reading);
            localStorage.setItem('readings', JSON.stringify(readings));
            
            // Sync reading to cloud
            if (typeof CloudStorage !== 'undefined' && CloudStorage.saveReading) {
                console.log('‚òÅÔ∏è Syncing reading to cloud:', reading.id);
                CloudStorage.saveReading(reading).then(result => {
                    if (result && result.success) {
                        console.log('‚úÖ Reading synced to cloud');
                    }
                }).catch(error => {
                    console.error('‚ùå Reading cloud sync error:', error);
                });
            }
            
            showAlertAndReload('‚úÖ Reading saved successfully! ID: ' + reading.id, 'success');
            
            closeQuickEntry();
        }

        // Purchase Form Functions
        function openPurchaseForm() {
            document.getElementById('purchase-modal').classList.add('show');
            const today = new Date().toISOString().slice(0, 16);
            document.getElementById('purchase-date').value = today;
            
            // Auto-populate cost price based on default product (PMS)
            autopopulatePurchasePrice();
        }

        function closePurchaseForm() {
            document.getElementById('purchase-modal').classList.remove('show');
            document.getElementById('purchase-form').reset();
        }

        // BATCH 1 - IMPROVEMENT 2: Auto-populate purchase cost price from settings
        function autopopulatePurchasePrice() {
            const product = document.getElementById('purchase-product').value;
            const priceField = document.getElementById('purchase-price-per-liter');
            
            if (settings.prices) {
                if (product === 'PMS') {
                    priceField.value = settings.prices.pmsCost || 5000;
                } else if (product === 'AGO') {
                    priceField.value = settings.prices.agoCost || 4800;
                }
                calculatePurchaseTotal();
            }
        }

        function calculatePurchaseTotal() {
            const litres = parseFloat(document.getElementById('purchase-litres').value) || 0;
            const pricePerLiter = parseFloat(document.getElementById('purchase-price-per-liter').value) || 0;
            const total = litres * pricePerLiter;
            document.getElementById('purchase-total-amount').value = total.toFixed(0);
            calculatePurchaseBalance();
        }

        function calculatePurchaseBalance() {
            const total = parseFloat(document.getElementById('purchase-total-amount').value) || 0;
            const paid = parseFloat(document.getElementById('purchase-amount-paid').value) || 0;
            const balance = total - paid;
            document.getElementById('purchase-balance').value = balance.toFixed(0);
        }

        function savePurchase(event) {
            event.preventDefault();
            
            // CRITICAL: Reload purchases from localStorage to get latest IDs
            purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            
            // Calculate amounts
            const litres = parseFloat(document.getElementById('purchase-litres').value);
            const pricePerLiter = parseFloat(document.getElementById('purchase-price-per-liter').value);
            const totalAmount = litres * pricePerLiter;
            const amountPaid = parseFloat(document.getElementById('purchase-amount-paid')?.value || 0);
            const balance = totalAmount - amountPaid;
            
            // Calculate proper max ID
            let maxId = 0;
            purchases.forEach(p => {
                const match = (p.id || '').match(/PU\s*(\d+)/);
                if (match) {
                    const num = parseInt(match[1]);
                    if (num > maxId) maxId = num;
                }
            });
            const purchaseId = `PU ${String(maxId + 1).padStart(4, '0')}`;
            
            const purchase = {
                id: purchaseId,
                date: document.getElementById('purchase-date').value,
                recordedBy: document.getElementById('purchase-recorded-by').value,
                supplier: document.getElementById('purchase-supplier').value,
                product: document.getElementById('purchase-product').value,
                litres: litres,
                pricePerLiter: pricePerLiter,
                totalAmount: totalAmount,
                amountPaid: amountPaid,
                balance: balance,
                invoice: document.getElementById('purchase-invoice').value,
                paymentMethod: document.getElementById('purchase-payment-method').value,
                truckNumber: document.getElementById('purchase-truck').value,
                driverName: document.getElementById('purchase-driver').value,
                notes: document.getElementById('purchase-notes').value,
                timestamp: new Date().toISOString()
            };
            
            purchases.push(purchase);
            localStorage.setItem('purchases', JSON.stringify(purchases));
            
            // Sync to cloud
            if (typeof CloudStorage !== 'undefined' && CloudStorage.savePurchase) {
                console.log('‚òÅÔ∏è Syncing purchase to cloud:', purchaseId);
                if (typeof updateCloudBadge === 'function') updateCloudBadge('syncing');
                
                CloudStorage.savePurchase(purchase).then(result => {
                    if (result && result.success) {
                        console.log('‚úÖ Purchase synced to cloud');
                        if (typeof updateCloudBadge === 'function') updateCloudBadge('synced');
                    } else {
                        console.warn('‚ö†Ô∏è Purchase saved locally but cloud sync failed');
                        if (typeof updateCloudBadge === 'function') updateCloudBadge('error');
                    }
                }).catch(error => {
                    console.error('‚ùå Purchase cloud sync error:', error);
                    if (typeof updateCloudBadge === 'function') updateCloudBadge('error');
                });
            }
            
            showAlertAndReload('‚úÖ Purchase saved successfully! ID: ' + purchase.id, 'success');
            
            closePurchaseForm();
        }

        // Expense Form Functions
        function openExpenseForm() {
            document.getElementById('expense-modal').classList.add('show');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expense-date').value = today;
        }

        function closeExpenseForm() {
            document.getElementById('expense-modal').classList.remove('show');
            document.getElementById('expense-form').reset();
        }

        function saveExpense(event) {
            event.preventDefault();
            
            // CRITICAL: Reload expenses from localStorage to get latest IDs
            expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            
            const expense = {
                id: (() => {
                    // Calculate proper max ID
                    let maxId = 0;
                    expenses.forEach(e => {
                        const match = e.id.match(/EX\s*(\d+)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            if (num > maxId) maxId = num;
                        }
                    });
                    return `EX ${String(maxId + 1).padStart(4, '0')}`;
                })(),
                date: document.getElementById('expense-date').value,
                category: document.getElementById('expense-category').value,
                description: document.getElementById('expense-description').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                paymentMethod: document.getElementById('expense-payment-method').value,
                paidTo: document.getElementById('expense-paid-to').value,
                reference: document.getElementById('expense-reference').value,
                // receipt field removed - not in backend schema
                approvedBy: document.getElementById('expense-approved-by').value || 'Pending',
                recordedBy: document.getElementById('expense-recorded-by').value,
                notes: document.getElementById('expense-notes').value,
                status: document.getElementById('expense-approved-by').value ? 'Paid' : 'Pending',
                timestamp: new Date().toISOString()
            };
            
            expenses.push(expense);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            
            // Sync expense to cloud
            if (typeof CloudStorage !== 'undefined' && CloudStorage.saveExpense) {
                console.log('‚òÅÔ∏è Syncing expense to cloud:', expense.id);
                if (typeof updateCloudBadge === 'function') updateCloudBadge('syncing');
                
                CloudStorage.saveExpense(expense).then(result => {
                    if (result && result.success) {
                        console.log('‚úÖ Expense synced to cloud');
                        if (typeof updateCloudBadge === 'function') updateCloudBadge('synced');
                    } else {
                        if (typeof updateCloudBadge === 'function') updateCloudBadge('error');
                    }
                }).catch(error => {
                    console.error('‚ùå Expense cloud sync error:', error);
                    if (typeof updateCloudBadge === 'function') updateCloudBadge('error');
                });
            }
            
            showAlertAndReload('‚úÖ Expense saved successfully! ID: ' + expense.id, 'success');
            
            closeExpenseForm();
        }

        // Credit Payment Form Functions
        let currentCreditForPayment = null;
        
        function openCreditPaymentForm(creditId, customerName, balance) {
            currentCreditForPayment = { id: creditId, customer: customerName, balance: balance };
            
            document.getElementById('credit-payment-modal').classList.add('show');
            const today = new Date().toISOString().slice(0, 16);
            document.getElementById('credit-payment-date').value = today;
            
            // Pre-fill credit info if available
            if (creditId) {
                const creditIdField = document.getElementById('credit-payment-credit-id');
                if (creditIdField) {
                    creditIdField.value = creditId;
                    creditIdField.readOnly = true;
                }
                
                // Set max amount to balance
                const amountField = document.getElementById('credit-payment-amount');
                if (amountField && balance) {
                    amountField.max = balance;
                    amountField.placeholder = `Max: UGX ${formatNumber(balance)}`;
                }
            }
        }

        function closeCreditPaymentForm() {
            document.getElementById('credit-payment-modal').classList.remove('show');
            document.getElementById('credit-payment-form').reset();
            currentCreditForPayment = null;
        }

        function saveCreditPayment(event) {
            event.preventDefault();
            
            // Get credit ID from form or currentCreditForPayment
            const creditId = document.getElementById('credit-payment-credit-id')?.value || 
                            (currentCreditForPayment ? currentCreditForPayment.id : '');
            
            if (!creditId) {
                alert('‚ùå Error: No credit ID specified');
                return;
            }
            
            const payment = {
                id: `CP-${creditId}-${Date.now()}`,
                date: document.getElementById('credit-payment-date').value,
                creditId: creditId,
                amount: parseFloat(document.getElementById('credit-payment-amount').value),
                method: document.getElementById('credit-payment-method').value,
                clearedBy: document.getElementById('credit-payment-cleared-by').value,
                notes: document.getElementById('credit-payment-notes').value,
                timestamp: new Date().toISOString()
            };
            
            creditPayments.push(payment);
            localStorage.setItem('creditPayments', JSON.stringify(creditPayments));
            
            // Sync to cloud
            if (typeof CloudStorage !== 'undefined' && CloudStorage.saveCreditPayment) {
                console.log('‚òÅÔ∏è Syncing credit payment to cloud:', payment.id);
                if (typeof updateCloudBadge === 'function') updateCloudBadge('syncing');
                
                CloudStorage.saveCreditPayment(payment).then(result => {
                    if (result && result.success) {
                        console.log('‚úÖ Credit payment synced to cloud');
                        if (typeof updateCloudBadge === 'function') updateCloudBadge('synced');
                    } else {
                        console.warn('‚ö†Ô∏è Credit payment saved locally but cloud sync failed');
                        if (typeof updateCloudBadge === 'function') updateCloudBadge('error');
                    }
                }).catch(error => {
                    console.error('‚ùå Cloud sync error:', error);
                    if (typeof updateCloudBadge === 'function') updateCloudBadge('error');
                });
            }
            
            showAlertAndReload('‚úÖ Credit payment recorded successfully! ID: ' + payment.id, 'success');
            
            // üîÑ UPDATE CREDIT STATUS IN CLOUD
            if (typeof updateCloudRecord === 'function') {
                updateCloudRecord('Credits', payment.creditId, {
                    Paid: 'YES',
                    Balance: 0
                });
            }
        
            closeCreditPaymentForm();
        }

        // Supplier Payment Form Functions
        function openSupplierPaymentForm() {
            document.getElementById('supplier-payment-modal').classList.add('show');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('supplier-payment-date').value = today;
        }

        function closeSupplierPaymentForm() {
            document.getElementById('supplier-payment-modal').classList.remove('show');
            document.getElementById('supplier-payment-form').reset();
        }

        function saveSupplierPayment(event) {
            event.preventDefault();
            
            const payment = {
                id: `SP ${String(supplierPayments.length + 1).padStart(4, '0')}`,
                date: document.getElementById('supplier-payment-date').value,
                creditId: document.getElementById('supplier-payment-credit-id').value,
                purchaseId: document.getElementById('supplier-payment-purchase-id').value,
                supplier: document.getElementById('supplier-payment-supplier').value,
                amount: parseFloat(document.getElementById('supplier-payment-amount').value),
                method: document.getElementById('supplier-payment-method').value,
                paidBy: document.getElementById('supplier-payment-paid-by').value,
                notes: document.getElementById('supplier-payment-notes').value,
                timestamp: new Date().toISOString()
            };
            
            supplierPayments.push(payment);
            localStorage.setItem('supplierPayments', JSON.stringify(supplierPayments));
            
            // Sync to cloud
            if (typeof CloudStorage !== 'undefined' && CloudStorage.saveSupplierPayment) {
                console.log('‚òÅÔ∏è Syncing supplier payment to cloud:', payment.id);
                if (typeof updateCloudBadge === 'function') updateCloudBadge('syncing');
                
                CloudStorage.saveSupplierPayment(payment).then(result => {
                    if (result && result.success) {
                        console.log('‚úÖ Supplier payment synced to cloud');
                        if (typeof updateCloudBadge === 'function') updateCloudBadge('synced');
                        showAlertAndReload('‚úÖ Supplier payment recorded successfully! ID: ' + payment.id, 'success');
                    } else {
                        console.warn('‚ö†Ô∏è Supplier payment saved locally but cloud sync failed');
                        if (typeof updateCloudBadge === 'function') updateCloudBadge('error');
                        showAlertAndReload('‚ö†Ô∏è Supplier payment saved locally, cloud sync failed', 'warning');
                    }
                }).catch(error => {
                    console.error('‚ùå Cloud sync error:', error);
                    if (typeof updateCloudBadge === 'function') updateCloudBadge('error');
                    showAlertAndReload('‚ùå Supplier payment cloud sync error', 'error');
                });
            } else {
                showAlertAndReload('‚úÖ Supplier payment recorded successfully! ID: ' + payment.id, 'success');
            }
            
            closeSupplierPaymentForm();
        }

        // Selection Popup Functions
        let selectionData = [];
        let selectionCallback = null;

        function closeSelectionPopup() {
            document.getElementById('selection-popup').classList.remove('show');
            document.getElementById('selection-search').value = '';
        }

        function filterSelectionItems() {
            const searchTerm = document.getElementById('selection-search').value.toLowerCase();
            const items = document.querySelectorAll('.selection-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'grid' : 'none';
            });
        }

        function showPurchaseSelection() {
            // BATCH 2 FIX: Calculate actual balance after payments for each purchase
            const availablePurchases = purchases
                .map(p => {
                    // Calculate total paid for this purchase
                    const totalPaid = supplierPayments
                        .filter(sp => sp.purchaseId === p.id)
                        .reduce((sum, sp) => sum + sp.amount, 0);
                    
                    // Calculate current balance
                    const currentBalance = p.balance - totalPaid;
                    
                    return {
                        ...p,
                        currentBalance: currentBalance,
                        originalBalance: p.balance,
                        totalPaid: totalPaid
                    };
                })
                .filter(p => p.currentBalance > 0);  // Show ONLY purchases with unpaid balance
            
            if (availablePurchases.length === 0) {
                showAlert('No unpaid purchases found. All purchases have been fully paid!', 'info');
                return;
            }
            
            document.getElementById('selection-popup-title').textContent = `Select Purchase (${availablePurchases.length} Unpaid)`;
            
            const listHtml = availablePurchases.map(p => {
                const statusBadge = '<span style="background: var(--danger); color: white; padding: 2px 8px; border-radius: 8px; font-size: 10px; margin-left: 5px;">OUTSTANDING</span>';
                
                return `
                <div class="selection-item" onclick="selectPurchase('${p.id}', '${p.supplier}', ${p.currentBalance})">
                    <div class="selection-item-id" style="font-weight: 600; color: var(--primary);">${p.id} ${statusBadge}</div>
                    <div class="selection-item-details">
                        <div class="selection-item-name">${p.supplier}</div>
                        <div class="selection-item-info">${p.product} - ${formatNumber(p.litres)}L @ UGX ${formatNumber(p.pricePerLiter)}/L</div>
                        <div class="selection-item-info">Invoice: ${p.invoice} | Date: ${formatDate(p.date.split('T')[0])}</div>
                        <div class="selection-item-info" style="font-size: 11px; color: var(--gray);">
                            Total: UGX ${formatNumber(p.totalAmount)} | Paid: UGX ${formatNumber(p.totalPaid)} | Balance: UGX ${formatNumber(p.currentBalance)}
                        </div>
                    </div>
                    <div class="selection-item-balance" style="color: var(--danger);">
                        UGX ${formatNumber(p.currentBalance)}
                        <div style="font-size: 10px; color: var(--gray);">Balance Due</div>
                    </div>
                </div>
            `}).join('');
            
            document.getElementById('selection-popup-list').innerHTML = listHtml || '<div class="selection-empty">No unpaid purchases available</div>';
            document.getElementById('selection-popup').classList.add('show');
        }

        function selectPurchase(purchaseId, supplier, balance) {
            document.getElementById('supplier-payment-purchase-id').value = purchaseId;
            document.getElementById('supplier-payment-supplier').value = supplier;
            
            // Auto-suggest amount equal to balance
            if (balance > 0) {
                document.getElementById('supplier-payment-amount').value = balance;
            }
            
            closeSelectionPopup();
        }

        function showSupplierCreditSelection() {
            // Generate supplier credits from purchases with balances
            const supplierCredits = [];
            purchases.forEach((purchase, idx) => {
                if (purchase.balance > 0) {
                   const totalPaid = supplierPayments
  .filter(sp => sp.purchaseId === p.purchaseId)
  .reduce((sum, sp) => sum + sp.amount, 0);

const currentBalance = p.totalAmount - totalPaid;

                    
                    if (currentBalance > 0) {
                        supplierCredits.push({
                            id: `SC ${String(idx + 1).padStart(4, '0')}`,
                            purchaseId: purchase.id,
                            supplier: purchase.supplier,
                            balance: currentBalance,
                            date: purchase.date
                        });
                    }
                }
            });
            
            if (supplierCredits.length === 0) {
                showAlert('No unpaid supplier credits found. All purchases have been fully paid!', 'info');
                return;
            }
            
            document.getElementById('selection-popup-title').textContent = 'Select Supplier Credit (Unpaid Only)';
            
            const listHtml = supplierCredits.map(sc => `
                <div class="selection-item" onclick="selectSupplierCredit('${sc.id}', '${sc.purchaseId}', '${sc.supplier}', ${sc.balance})">
                    <div class="selection-item-id">${sc.id}</div>
                    <div class="selection-item-details">
                        <div class="selection-item-name">${sc.supplier}</div>
                        <div class="selection-item-info">Purchase: ${sc.purchaseId}</div>
                        <div class="selection-item-info">Date: ${formatDate(sc.date.split('T')[0])}</div>
                    </div>
                    <div class="selection-item-balance">
                        UGX ${formatNumber(sc.balance)}
                        <div style="font-size: 10px; color: var(--gray);">Outstanding</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('selection-popup-list').innerHTML = listHtml || '<div class="selection-empty">No supplier credits available</div>';
            document.getElementById('selection-popup').classList.add('show');
        }

        function selectSupplierCredit(creditId, purchaseId, supplier, balance) {
            document.getElementById('supplier-payment-credit-id').value = creditId;
            document.getElementById('supplier-payment-purchase-id').value = purchaseId;
            document.getElementById('supplier-payment-supplier').value = supplier;
            
            // Auto-suggest amount equal to balance
            if (balance > 0) {
                document.getElementById('supplier-payment-amount').value = balance;
            }
            
            closeSelectionPopup();
        }

	function showCustomerCreditSelection() {
  const allCredits = [];

  readings.forEach(r => {
    if (!r.creditTransactions) return;

    r.creditTransactions.forEach(credit => {
      const totalPaid = creditPayments
        .filter(cp => cp.creditId === credit.creditId)
        .reduce((sum, cp) => sum + cp.amount, 0);

      const balance = credit.amount - totalPaid;

      if (balance > 0) {
        allCredits.push({
          creditId: credit.creditId, // ‚úÖ REAL ID
          displayId: `CR ${String(allCredits.length + 1).padStart(4, '0')}`,
          customer: credit.customer,
          fuel: credit.fuel,
          amount: credit.amount,
          balance,
          date: r.date,
          staff: r.staff
        });
      }
    });
  });

  if (allCredits.length === 0) {
    showAlert('No unpaid customer credits found.', 'info');
    return;
  }

  document.getElementById('selection-popup-title').textContent =
    `Select Customer Credit (${allCredits.length} Unpaid)`;

  document.getElementById('selection-popup-list').innerHTML =
    allCredits.map(c => `
      <div class="selection-item"
        onclick="selectCustomerCredit('${c.creditId}', ${c.balance})">
        <div class="selection-item-id">
          ${c.displayId}
          <span style="background:var(--danger);color:white;
            padding:2px 8px;border-radius:8px;font-size:10px;">
            OUTSTANDING
          </span>
        </div>
        <div class="selection-item-details">
          <div>${c.customer} (${c.fuel})</div>
          <div>Total: UGX ${formatNumber(c.amount)}</div>
          <div>Balance: UGX ${formatNumber(c.balance)}</div>
        </div>
      </div>
    `).join('');

  document.getElementById('selection-popup').classList.add('show');
}


       function selectCustomerCredit(creditId, balance) {
  document.getElementById('credit-payment-credit-id').value = creditId;

  if (balance > 0) {
    document.getElementById('credit-payment-amount').value = balance;
  }

  closeSelectionPopup();
}

function migrateCredits() {
  let changed = false;

  readings.forEach(r => {
    if (!r.creditTransactions) return;

    r.creditTransactions.forEach(c => {
      if (!c.creditId) {
        c.creditId = CR-RD-000123-1;
        changed = true;
      }
    });
  });
  
  if (changed) {
    localStorage.setItem('readings', JSON.stringify(readings));
    console.log('‚úÖ Credits migrated');
  }
}

function migratePurchases() {
  let changed = false;

  purchases.forEach(p => {
    if (!p.purchaseId) {
      p.purchaseId = crypto.randomUUID();
      changed = true;
    }
  });

  if (changed) {
    localStorage.setItem('purchases', JSON.stringify(purchases));
    console.log('‚úÖ Purchases migrated');

	
  }
}





        // Rendering Functions
        function renderReadings() {
            const container = document.getElementById('readings-list');
            
            if (currentReadings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <h3>No readings yet</h3>
                        <p>Start by using the Shift Wizard or Quick Entry</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentReadings.map(r => `
                <div class="reading-card">
                    <div class="reading-header">
                        <div>
                            <div class="reading-id">${r.id}</div>
                            <div class="reading-date">${formatDate(r.date)} - ${r.shift}</div>
                        </div>
                        <span class="status-badge complete">‚úì Complete</span>
                    </div>
                    
                    <div class="reading-meta">
                        <div class="meta-item">
                            <div class="meta-label">Staff</div>
                            <div class="meta-value">${r.staff}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Shift</div>
                            <div class="meta-value">${r.shift}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Pump</div>
                            <div class="meta-value">${r.pump}</div>
                        </div>
                    </div>
                    
                    <div class="fuel-data">
                        <div class="fuel-section petrol">
                            <div class="fuel-header">
                                <span class="fuel-indicator"></span>
                                <span>Petrol</span>
                            </div>
                            <div class="fuel-details">
                                <div class="fuel-row">
                                    <span class="label">Prev:</span>
                                    <span class="value">${formatNumber(r.pmsOpen)} L</span>
                                </div>
                                <div class="fuel-row">
                                    <span class="label">Curr:</span>
                                    <span class="value">${formatNumber(r.pmsClose)} L</span>
                                </div>
                                <div class="sold-highlight">Sold: ${formatNumber(r.pmsSold)} L</div>
                            </div>
                        </div>
                        
                        <div class="fuel-section diesel">
                            <div class="fuel-header">
                                <span class="fuel-indicator"></span>
                                <span>Diesel</span>
                            </div>
                            <div class="fuel-details">
                                <div class="fuel-row">
                                    <span class="label">Prev:</span>
                                    <span class="value">${formatNumber(r.agoOpen)} L</span>
                                </div>
                                <div class="fuel-row">
                                    <span class="label">Curr:</span>
                                    <span class="value">${formatNumber(r.agoClose)} L</span>
                                </div>
                                <div class="sold-highlight">Sold: ${formatNumber(r.agoSold)} L</div>
                            </div>
                        </div>
                    </div>
                    
                    ${r.totalSales ? `
                        <div class="sales-summary">
                            <h4>Sales Summary</h4>
                            <div class="sales-grid">
                                <div class="sales-item">
                                    <div class="label">Total Sales</div>
                                    <div class="amount">UGX ${formatNumber(r.totalSales)}</div>
                                </div>
                                <div class="sales-item">
                                    <div class="label">Collections</div>
                                    <div class="amount">UGX ${formatNumber((r.cash || 0) + (r.momo || 0) + (r.credits || 0))}</div>
                                </div>
                                <div class="sales-item">
                                    <div class="label">Balance</div>
                                    <div class="amount">UGX ${formatNumber(r.totalSales - ((r.cash || 0) + (r.momo || 0) + (r.credits || 0)))}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="reading-actions">
                        <button class="btn btn-danger btn-sm" onclick="deleteReading('${r.id}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            `).reverse().join('');
        }

        function filterReadings() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const date = document.getElementById('filter-date').value;
            const shift = document.getElementById('filter-shift').value;
            
            currentReadings = readings.filter(r => {
                const matchSearch = !search || 
                    r.id.toLowerCase().includes(search) ||
                    r.staff.toLowerCase().includes(search) ||
                    r.pump.toLowerCase().includes(search);
                const matchDate = !date || r.date === date;
                const matchShift = !shift || r.shift === shift;
                
                return matchSearch && matchDate && matchShift;
            });
            
            renderReadings();
        }

        function deleteReading(id) {
            if (confirm('Delete this reading? This cannot be undone.')) {
                readings = readings.filter(r => r.id !== id);
                localStorage.setItem('readings', JSON.stringify(readings));
                currentReadings = readings;
                updateStats();
                renderReadings();
                showAlert('Reading deleted', 'info');
            }
        }

        // Stats Functions
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayReadings = readings.filter(r => r.date === today);
            const totalRevenue = readings.reduce((sum, r) => sum + (r.totalSales || 0), 0);
            const lastReading = readings.length > 0 ? readings[readings.length - 1] : null;
            
            document.getElementById('stat-revenue').textContent = 'UGX ' + formatNumber(totalRevenue);
            document.getElementById('stat-today').textContent = todayReadings.length;
            document.getElementById('stat-last-id').textContent = lastReading ? lastReading.id : 'ME 0000';
            
            // Refresh alerts
            if (currentUser) {
                checkAndDisplayAlerts();
            }
        }

        // Data Management
        function exportData() {
            const data = {
                readings,
                purchases,
                expenses,
                creditPayments,
                supplierPayments,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `okum-energy-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showAlert('‚úÖ Data exported successfully!', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('Import data? This will merge with existing data.')) {
                        readings = [...readings, ...(data.readings || [])];
                        purchases = [...purchases, ...(data.purchases || [])];
                        expenses = [...expenses, ...(data.expenses || [])];
                        creditPayments = [...creditPayments, ...(data.creditPayments || [])];
                        supplierPayments = [...supplierPayments, ...(data.supplierPayments || [])];
                        
                        localStorage.setItem('readings', JSON.stringify(readings));
                        localStorage.setItem('purchases', JSON.stringify(purchases));
                        localStorage.setItem('expenses', JSON.stringify(expenses));
                        localStorage.setItem('creditPayments', JSON.stringify(creditPayments));
                        localStorage.setItem('supplierPayments', JSON.stringify(supplierPayments));
                        
                        currentReadings = readings;
                        updateStats();
                        renderReadings();
                        showAlert('‚úÖ Data imported successfully!', 'success');
                    }
                } catch (error) {
                    showAlert('‚ùå Invalid data file!', 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Delete ALL data? This cannot be undone!')) {
                if (confirm('Are you absolutely sure? This will delete everything!')) {
                    localStorage.clear();
                    readings = [];
                    purchases = [];
                    expenses = [];
                    creditPayments = [];
                    supplierPayments = [];
                    currentReadings = [];
                    updateStats();
                    renderReadings();
                    showAlert('All data cleared', 'info');
                }
            }
        }

        // View Management
        function showView(viewName) {
            // BATCH 3: Check if view is locked for non-ISAAC users
            if (currentUser && currentUser.username !== 'ISAAC') {
                const lockedViews = {
                    'meters': viewLocks.meters,
                    'sales': viewLocks.sales,
                    'purchases': viewLocks.purchases,
                    'purchase-details': viewLocks.purchases,
                    'expenses': viewLocks.expenses,
                    'credits': viewLocks.credits,
                    'credit-payments': viewLocks.credits,
                    'supplier-credits': viewLocks.supplierCredits,
                    'supplier-payments': viewLocks.supplierCredits,
                    'staff-master': viewLocks.staffMaster,
                    'staff-detail': viewLocks.staffMaster,
                    'stock-control': viewLocks.stockControl,
                    'profit-loss': viewLocks.profitLoss,
                    'ledger': viewLocks.ledger
                };
                
                if (lockedViews[viewName]) {
                    showAlert('üîí Access Restricted - This view has been locked by management', 'error');
                    return;
                }
            }
            
            // Hide all views
            const allViews = [
                'dashboard-view', 'ledger-view', 'meters-view', 'sales-view', 
                'credits-view', 'credit-payments-view', 'purchases-view', 'purchase-details-view',
                'supplier-credits-view', 'supplier-payments-view', 'price-analysis-view',
                'petty-cash-view', 'expenses-view', 'cash-transactions-view', 'mobile-money-view',
                'staff-accountability-view', 'stock-control-view', 'profit-loss-view',
                'settings-view', 'staff-master-view', 'staff-detail-view'
            ];
            
            allViews.forEach(view => {
                const element = document.getElementById(view);
                if (element) element.style.display = 'none';
            });
            
            // Show selected view and render data
            const viewMap = {
                'dashboard': 'dashboard-view',
                'ledger': 'ledger-view',
                'meters': 'meters-view',
                'sales': 'sales-view',
                'credits': 'credits-view',
                'credit-payments': 'credit-payments-view',
                'purchases': 'purchases-view',
                'purchase-details': 'purchase-details-view',
                'supplier-credits': 'supplier-credits-view',
                'supplier-payments': 'supplier-payments-view',
                'price-analysis': 'price-analysis-view',
                'petty-cash': 'petty-cash-view',
                'expenses': 'expenses-view',
                'cash-transactions': 'cash-transactions-view',
                'mobile-money': 'mobile-money-view',
                'staff-accountability': 'staff-accountability-view',
                'stock-control': 'stock-control-view',
                'profit-loss': 'profit-loss-view',
                'settings': 'settings-view',
                'staff-master': 'staff-master-view',
                'staff-detail': 'staff-detail-view'
            };
            
            const viewId = viewMap[viewName];
            if (viewId) {
                document.getElementById(viewId).style.display = 'block';
                
                // Call appropriate render function
                if (viewName === 'ledger') {
                    // FIX 4: Reload lossPayments fresh before rendering ledger
                    lossPayments = JSON.parse(localStorage.getItem('lossPayments') || '[]');
                    renderLedger();
                }
                else if (viewName === 'meters') renderMetersView();
                else if (viewName === 'sales') renderSalesView();
                else if (viewName === 'credits') renderCreditsView();
                else if (viewName === 'credit-payments') renderCreditPaymentsView();
                else if (viewName === 'purchases') renderPurchasesView();
                else if (viewName === 'purchase-details') renderPurchaseDetailsView();
                else if (viewName === 'supplier-credits') renderSupplierCreditsView();
                else if (viewName === 'supplier-payments') renderSupplierPaymentsView();
                else if (viewName === 'price-analysis') renderPriceAnalysisView();
                else if (viewName === 'petty-cash') renderPettyCashView();
                else if (viewName === 'expenses') renderExpensesView();
                else if (viewName === 'cash-transactions') renderCashTransactionsView();
                else if (viewName === 'mobile-money') renderMobileMoneyView();
                else if (viewName === 'staff-accountability') renderStaffAccountability();
                else if (viewName === 'stock-control') renderStockControl();
                else if (viewName === 'profit-loss') renderProfitLoss();
                else if (viewName === 'settings') loadSettings();
                else if (viewName === 'staff-master') renderStaffMaster();
            }
        }

        function toggleViewsDropdown() {
            const dropdown = document.getElementById('views-dropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('views-dropdown');
            const button = event.target.closest('.btn');
            
            if (dropdown && !dropdown.contains(event.target) && (!button || !button.textContent.includes('Views'))) {
                dropdown.style.display = 'none';
            }
        });

        // Ledger Functions
        function buildLedgerFromReadings() {
            // FIX 4: Reload all data fresh from localStorage to ensure latest data
            const currentLossPayments = JSON.parse(localStorage.getItem('lossPayments') || '[]');
            
            const ledgerEntries = [];
            let creditCounter = 0;
            
            // Sort readings by date
            const sortedReadings = [...readings].sort((a, b) => {
                const dateA = new Date(a.date + ' ' + (a.shift === 'MORNING' ? '06:00' : '18:00'));
                const dateB = new Date(b.date + ' ' + (b.shift === 'MORNING' ? '06:00' : '18:00'));
                return dateA - dateB;
            });
            
            // 1. Add SALES from readings - CREDIT side (money in)
            sortedReadings.forEach(reading => {
                const saleId = reading.id.replace('ME', 'SA');
                
                if (reading.totalSales) {
                    ledgerEntries.push({
                        date: reading.date,
                        type: 'Sales',
                        description: `${reading.shift} Shift - ${reading.pump} - ${reading.staff}`,
                        reference: saleId,
                        credit: reading.totalSales,
                        debit: 0
                    });
                }
                
                // 2. Add CUSTOMER CREDITS from readings - DEBIT side (money out on credit)
                if (reading.creditTransactions && reading.creditTransactions.length > 0) {
                    reading.creditTransactions.forEach(credit => {
                        creditCounter++;
                        const creditId = `CR ${String(creditCounter).padStart(4, '0')}`;
                        ledgerEntries.push({
                            date: reading.date,
                            type: 'Credit',
                            description: `Credit Sale - ${credit.customer} (${credit.fuel})`,
                            reference: creditId,
                            credit: 0,
                            debit: credit.amount
                        });
                    });
                }
                
                // 5. Add STAFF LOSSES from readings - DEBIT side (money lost)
                if (reading.losses && reading.losses > 0) {
                    ledgerEntries.push({
                        date: reading.date,
                        type: 'Staff Loss',
                        description: `Staff Loss - ${reading.shift} Shift - ${reading.staff}`,
                        reference: reading.id.replace('ME', 'SA'),
                        credit: 0,
                        debit: reading.losses
                    });
                }
            });
            
            // 3. Add CREDIT PAYMENTS - CREDIT side (money in from payment)
            creditPayments.forEach(payment => {
                ledgerEntries.push({
                    date: payment.date.split('T')[0],
                    type: 'Credit Payment',
                    description: `Payment for ${payment.creditId} - ${payment.method}`,
                    reference: payment.id,
                    credit: payment.amount,
                    debit: 0
                });
            });
            
            // 6. Add LOSS PAYMENTS - CREDIT side (money recovered from staff)
            currentLossPayments.forEach(payment => {
                ledgerEntries.push({
                    date: payment.date,
                    type: 'Loss Recovered',
                    description: `Loss cleared by ${payment.staff} - ${payment.method}`,
                    reference: payment.id,
                    credit: payment.amountPaid,
                    debit: 0
                });
            });
            
            // 6b. Add LOAN/FINE PAYMENTS - CREDIT side (money recovered from staff)
            const currentLoanFinePayments = JSON.parse(localStorage.getItem('loanFinePayments') || '[]');
            currentLoanFinePayments.forEach(payment => {
                ledgerEntries.push({
                    date: payment.date,
                    type: `${payment.expenseCategory} Payment`,
                    description: `${payment.expenseCategory} paid by ${payment.staff} - ${payment.method}${payment.balance > 0 ? ` (Balance: ${formatNumber(payment.balance)})` : ''}`,
                    reference: payment.id,
                    credit: payment.amountPaid,
                    debit: 0
                });
            });
            
            // 7. Add PURCHASES - DEBIT side (money out)
            purchases.forEach(purchase => {
                ledgerEntries.push({
                    date: purchase.date.split('T')[0],
                    type: 'Purchase',
                    description: `${purchase.product} - ${formatNumber(purchase.litres)}L from ${purchase.supplier}`,
                    reference: purchase.id,
                    credit: 0,
                    debit: purchase.totalAmount
                });
            });
            
            // 4. Add EXPENSES - DEBIT side (money out)
            expenses.forEach(expense => {
                ledgerEntries.push({
                    date: expense.date,
                    type: 'Expense',
                    description: `${expense.category} - ${expense.description}`,
                    reference: expense.id,
                    credit: 0,
                    debit: expense.amount
                });
            });
            
            // 8. Add SUPPLIER PAYMENTS - DEBIT side (money out)
            supplierPayments.forEach(payment => {
                ledgerEntries.push({
                    date: payment.date,
                    type: 'Supplier Payment',
                    description: `Payment to ${payment.supplier} for ${payment.purchaseId}`,
                    reference: payment.id,
                    credit: 0,
                    debit: payment.amount
                });
            });
            
            // Sort all entries by date
            ledgerEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            return ledgerEntries;
        }

        function renderLedger() {
            const ledgerEntries = buildLedgerFromReadings();
            const tbody = document.getElementById('ledger-tbody');
            
            if (ledgerEntries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 40px; text-align: center; color: var(--gray);">
                            <div style="font-size: 48px; margin-bottom: 15px;">üìí</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No transactions yet</div>
                            <div style="font-size: 14px;">Complete shifts using the wizard to see transactions here</div>
                        </td>
                    </tr>
                `;
                document.getElementById('ledger-total-debit').textContent = 'UGX 0';
                document.getElementById('ledger-total-credit').textContent = 'UGX 0';
                document.getElementById('ledger-balance').textContent = 'UGX 0';
                return;
            }
            
            let runningBalance = 0;
            let totalDebit = 0;
            let totalCredit = 0;
            
            tbody.innerHTML = ledgerEntries.map(entry => {
                totalDebit += entry.debit;
                totalCredit += entry.credit;
                runningBalance += entry.credit - entry.debit;
                
                return `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px;">${formatDate(entry.date)}</td>
                        <td style="padding: 12px;">
                            <span style="background: ${getTypeColor(entry.type)}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${entry.type}
                            </span>
                        </td>
                        <td style="padding: 12px;">${entry.description}</td>
                        <td style="padding: 12px; color: var(--primary); font-weight: 600;">${entry.reference}</td>
                        <td style="padding: 12px; text-align: right; color: var(--success);">
                            ${entry.credit > 0 ? 'UGX ' + formatNumber(entry.credit) : '-'}
                        </td>
                        <td style="padding: 12px; text-align: right; color: var(--danger);">
                            ${entry.debit > 0 ? 'UGX ' + formatNumber(entry.debit) : '-'}
                        </td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: ${runningBalance >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            UGX ${formatNumber(Math.abs(runningBalance))}
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('ledger-total-debit').textContent = 'UGX ' + formatNumber(totalDebit);
            document.getElementById('ledger-total-credit').textContent = 'UGX ' + formatNumber(totalCredit);
            document.getElementById('ledger-balance').textContent = 'UGX ' + formatNumber(totalCredit - totalDebit);
        }

        function getTypeColor(type) {
            const colors = {
                'Sales': '#10b981',           // Green - Income
                'Credit': '#3b82f6',          // Blue - Credit issued
                'Credit Payment': '#059669',  // Dark Green - Payment received
                'Purchase': '#f59e0b',        // Orange - Expense
                'Expense': '#ef4444',         // Red - Expense
                'Supplier Payment': '#dc2626', // Dark Red - Payment made
                'Staff Loss': '#7c3aed'       // Purple - Loss
            };
            return colors[type] || '#6b7280';
        }

        function filterLedger() {
            // Placeholder for ledger filtering
            renderLedger();
        }

        // View Rendering Functions
        function renderMetersView() {
            const tbody = document.getElementById('meters-tbody');
            if (!readings || readings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="padding: 40px; text-align: center; color: var(--gray);">No meter records found. Start by adding shift data using the wizard.</td></tr>';
                return;
            }
            
            tbody.innerHTML = readings.map(r => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${r.id}</td>
                    <td style="padding: 12px;">${formatDate(r.date)}</td>
                    <td style="padding: 12px;">${r.staff}</td>
                    <td style="padding: 12px;"><span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${r.shift}</span></td>
                    <td style="padding: 12px;">${r.pump}</td>
                    <td style="padding: 12px; text-align: right;">${formatNumber(r.pmsOpen || 0)}</td>
                    <td style="padding: 12px; text-align: right;">${formatNumber(r.pmsClose || 0)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--success);">${formatNumber(r.pmsSold || 0)}</td>
                    <td style="padding: 12px; text-align: right;">${formatNumber(r.agoOpen || 0)}</td>
                    <td style="padding: 12px; text-align: right;">${formatNumber(r.agoClose || 0)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--success);">${formatNumber(r.agoSold || 0)}</td>
                    <td style="padding: 12px;">${r.witness || '-'}</td>
                </tr>
            `).join('');
        }

        function renderSalesView() {
            const tbody = document.getElementById('sales-tbody');
            if (!readings || readings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" style="padding: 40px; text-align: center; color: var(--gray);">No sales records found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = readings.map(r => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${r.id.replace('ME', 'SA')}</td>
                    <td style="padding: 12px;">${formatDate(r.date)}</td>
                    <td style="padding: 12px;">${r.staff}</td>
                    <td style="padding: 12px;"><span style="background: var(--primary); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${r.shift}</span></td>
                    <td style="padding: 12px;">${r.pump}</td>
                    <td style="padding: 12px; text-align: right;">${formatNumber(r.pmsSold || 0)}</td>
                    <td style="padding: 12px; text-align: right;">${formatNumber(r.agoSold || 0)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">UGX ${formatNumber(r.totalSales || 0)}</td>
                    <td style="padding: 12px; text-align: right;">UGX ${formatNumber(r.expenses || 0)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">UGX ${formatNumber((r.totalSales || 0) - (r.expenses || 0))}</td>
                    <td style="padding: 12px; text-align: right;">UGX ${formatNumber(r.credits || 0)}</td>
                    <td style="padding: 12px; text-align: right;">UGX ${formatNumber(r.momo || 0)}</td>
                    <td style="padding: 12px; text-align: right; color: var(--success); font-weight: 600;">UGX ${formatNumber(r.cash || 0)}</td>
                    <td style="padding: 12px; text-align: right; color: var(--danger);">UGX ${formatNumber(r.losses || 0)}</td>
                    <td style="padding: 12px;">${r.preparedBy || 'System'}</td>
                </tr>
            `).join('');
        }

        function renderCreditsView() {
            const tbody = document.getElementById('credits-tbody');
            const allCredits = [];
            
            // Extract credits from readings
            readings.forEach(r => {
                if (r.creditTransactions && r.creditTransactions.length > 0) {
                    r.creditTransactions.forEach(credit => {
                        // Use the backend ID format (CR-ME 0109-1)
                        const backendId = credit.id || '';
                        
                        // Calculate total paid for this credit from credit payments
                        // Match using backend ID
                        const paymentsForThisCredit = creditPayments.filter(cp => 
                            cp.creditId === backendId
                        );
                        const totalPaid = paymentsForThisCredit.reduce((sum, cp) => sum + cp.amount, 0);
                        const balance = credit.amount - totalPaid;
                        
                        // Get the last payment for cleared info
                        const lastPayment = paymentsForThisCredit.length > 0 
                            ? paymentsForThisCredit[paymentsForThisCredit.length - 1] 
                            : null;
                        
                        allCredits.push({
                            id: backendId,  // Use backend ID (CR-ME 0109-1)
                            date: r.date,
                            name: r.staff,
                            customer: credit.customer,
                            fuel: credit.fuel || 'N/A',
                            amount: credit.amount,
                            paid: totalPaid,
                            balance: balance,
                            cleared: balance <= 0 ? 'YES' : 'NO',
                            clearedBy: balance <= 0 && lastPayment ? lastPayment.clearedBy : '',
                            clearedDate: balance <= 0 && lastPayment ? formatDate(lastPayment.date.split('T')[0]) : ''
                        });
                    });
                }
            });
            
            if (allCredits.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="padding: 40px; text-align: center; color: var(--gray);">No customer credit records found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = allCredits.map(c => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px; font-weight: 600; color: var(--primary);">${c.id}</td>
                    <td style="padding: 12px;">${formatDate(c.date)}</td>
                    <td style="padding: 12px;">${c.name}</td>
                    <td style="padding: 12px; font-weight: 600;">${c.customer}</td>
                    <td style="padding: 12px; text-align: right;">UGX ${formatNumber(c.amount)}</td>
                    <td style="padding: 12px; text-align: right; color: var(--success);">UGX ${formatNumber(c.paid)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: ${c.balance > 0 ? 'var(--danger)' : 'var(--success)'};">UGX ${formatNumber(c.balance)}</td>
                    <td style="padding: 12px; text-align: center;"><span style="background: ${c.cleared === 'YES' ? 'var(--success)' : 'var(--danger)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${c.cleared}</span></td>
                    <td style="padding: 12px;">${c.clearedBy || '-'}</td>
                    <td style="padding: 12px;">${c.clearedDate || '-'}</td>
                    <td style="padding: 12px; text-align: center;">
                        ${c.balance > 0 ? `<button onclick="openCreditPaymentForm('${c.id}', '${c.customer}', ${c.balance})" class="btn btn-sm btn-success" style="font-size: 12px; padding: 6px 12px;">üíµ Record Payment</button>` : '<span style="color: var(--success);">‚úÖ Paid</span>'}
                    </td>
                </tr>
            `).join('');
        }

        function renderCreditPaymentsView() {
            const tbody = document.getElementById('credit-payments-tbody');
            
            if (!creditPayments || creditPayments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: var(--gray);">No credit payment records found. Click "Credit Payment" to record customer credit repayments.</td></tr>';
                return;
            }
            
            tbody.innerHTML = creditPayments.map(cp => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${cp.id}</td>
                    <td style="padding: 12px;">${formatDate(cp.date.split('T')[0])} ${cp.date.split('T')[1] ? cp.date.split('T')[1].substring(0, 5) : ''}</td>
                    <td style="padding: 12px; font-weight: 600; color: var(--primary);">${cp.creditId}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--success);">UGX ${formatNumber(cp.amount)}</td>
                    <td style="padding: 12px;">${cp.method}</td>
                    <td style="padding: 12px;">${cp.notes || '-'}</td>
                    <td style="padding: 12px;">${cp.clearedBy}</td>
                </tr>
            `).join('');
        }

        function renderPurchasesView() {
            const tbody = document.getElementById('purchases-tbody');
            
            if (!purchases || purchases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="padding: 40px; text-align: center; color: var(--gray);">No purchase records found. Click "Record Purchase" to add fuel purchases from suppliers.</td></tr>';
                return;
            }
            
            tbody.innerHTML = purchases.map(p => {
                // Calculate updated balance after ALL supplier payments
                const totalPaid = supplierPayments
  		.filter(sp => sp.purchaseId === p.purchaseId)
  		.reduce((sum, sp) => sum + sp.amount, 0);

		const currentBalance = p.totalAmount - totalPaid;

                const balanceColor = currentBalance > 0 ? 'var(--danger)' : 'var(--success)';
                
                return `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${p.id}</td>
                    <td style="padding: 12px;">${formatDate(p.date.split('T')[0])}</td>
                    <td style="padding: 12px;">${p.recordedBy}</td>
                    <td style="padding: 12px; font-weight: 600;">${p.supplier}</td>
                    <td style="padding: 12px;"><span style="background: ${p.product === 'PMS' ? 'var(--success)' : 'var(--info)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${p.product}</span></td>
                    <td style="padding: 12px; text-align: right;">${formatNumber(p.litres)} L</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">UGX ${formatNumber(p.totalAmount)}</td>
                    <td style="padding: 12px; text-align: right; color: var(--success);">UGX ${formatNumber(p.amountPaid + totalPaid)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: ${balanceColor};">
                        UGX ${formatNumber(currentBalance)}
                        ${currentBalance === 0 ? '<div style="font-size: 10px; color: var(--success); margin-top: 2px;">FULLY PAID</div>' : ''}
                    </td>
                </tr>
            `}).join('');
        }
	
		function getPurchaseBalance(purchase) {
  		const paid = supplierPayments
   		 .filter(sp => sp.purchaseId === purchase.purchaseId)
   		 .reduce((sum, sp) => sum + sp.amount, 0);

 		 return purchase.totalAmount - paid;
		}


        function renderPurchaseDetailsView() {
            const tbody = document.getElementById('purchase-details-tbody');
            
            if (!purchases || purchases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="padding: 40px; text-align: center; color: var(--gray);">No purchase details found. This module tracks invoice numbers, truck details, and pricing information.</td></tr>';
                return;
            }
            
            tbody.innerHTML = purchases.map(p => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${p.id}</td>
                    <td style="padding: 12px;">${formatDate(p.date.split('T')[0])}</td>
                    <td style="padding: 12px; font-weight: 600;">${p.invoice}</td>
                    <td style="padding: 12px;">${p.paymentMethod}</td>
                    <td style="padding: 12px;">${p.truckNumber || '-'}</td>
                    <td style="padding: 12px;">${p.driverName || '-'}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">UGX ${formatNumber(p.pricePerLiter)}</td>
                    <td style="padding: 12px;">${p.notes || '-'}</td>
                    <td style="padding: 12px;">${p.recordedBy}</td>
                </tr>
            `).join('');
        }

        function renderSupplierCreditsView() {
            const tbody = document.getElementById('supplier-credits-tbody');
            
            // Auto-generate supplier credits from purchases with outstanding balances
            const supplierCredits = [];
            purchases.forEach((purchase, idx) => {
                // Calculate total paid for this purchase from supplier payments
                const totalPaid = supplierPayments
                    .filter(sp => sp.purchaseId === purchase.id)
                    .reduce((sum, sp) => sum + sp.amount, 0);
                
                // Calculate current balance
                // Initial balance from purchase + subtract any payments made
                const initialBalance = purchase.balance || 0;
                const currentBalance = initialBalance - totalPaid;
                
                // Show ALL credits with initial balance (including fully paid ones with 0 balance)
                if (initialBalance > 0) {
                    supplierCredits.push({
                        id: `SC ${String(supplierCredits.length + 1).padStart(4, '0')}`,
                        date: purchase.date,
                        purchaseId: purchase.id,
                        supplier: purchase.supplier,
                        initialAmount: initialBalance,
                        paidAmount: totalPaid,
                        balance: currentBalance,
                        status: currentBalance > 0 ? 'UNPAID' : 'FULLY PAID',
                        notes: currentBalance > 0 
                            ? `Balance due: UGX ${formatNumber(currentBalance)} (Paid: UGX ${formatNumber(totalPaid)} of UGX ${formatNumber(initialBalance)})`
                            : `FULLY PAID - Paid UGX ${formatNumber(totalPaid)}`
                    });
                }
            });
            
            if (supplierCredits.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: var(--gray);">No supplier credits found. All purchases are cash payments or fully paid!</td></tr>';
                return;
            }
            
            tbody.innerHTML = supplierCredits.map(sc => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${sc.id}</td>
                    <td style="padding: 12px;">${formatDate(sc.date.split('T')[0])}</td>
                    <td style="padding: 12px; font-weight: 600; color: var(--primary);">${sc.purchaseId}</td>
                    <td style="padding: 12px; font-weight: 600;">${sc.supplier}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: ${sc.balance > 0 ? 'var(--danger)' : 'var(--success)'};">UGX ${formatNumber(sc.balance)}</td>
                    <td style="padding: 12px; text-align: center;"><span style="background: ${sc.status === 'PAID' ? 'var(--success)' : 'var(--danger)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${sc.status}</span></td>
                    <td style="padding: 12px;">${sc.notes}</td>
                </tr>
            `).join('');
        }

        function renderSupplierPaymentsView() {
            const tbody = document.getElementById('supplier-payments-tbody');
            const allPaymentRecords = [];
            
            // 1. Add actual payment records
            supplierPayments.forEach(sp => {
                allPaymentRecords.push({
                    id: sp.id,
                    date: sp.date,
                    creditId: sp.creditId || '-',
                    purchaseId: sp.purchaseId,
                    supplier: sp.supplier,
                    amount: sp.amount,
                    method: sp.method,
                    paidBy: sp.paidBy,
                    notes: sp.notes || '-',
                    type: 'Payment',
                    status: 'Paid'
                });
            });
            
            // 2. Add fully paid purchases (where balance = 0 after payments)
            purchases.forEach(p => {
                // Calculate total paid for this purchase
                const totalPaid = supplierPayments
                    .filter(sp => sp.purchaseId === p.id)
                    .reduce((sum, sp) => sum + sp.amount, 0);
                
                const initialBalance = p.balance || 0;
                const currentBalance = initialBalance - totalPaid;
                
                // If purchase was on credit (had a balance) and is now fully paid
                if (initialBalance > 0 && currentBalance <= 0) {
                    // Check if we haven't already added this as a payment record
                    const hasPaymentRecord = supplierPayments.some(sp => sp.purchaseId === p.id);
                    
                    if (!hasPaymentRecord) {
                        // Add as a "Fully Paid" status entry
                        allPaymentRecords.push({
                            id: p.id,
                            date: p.date.split('T')[0],
                            creditId: '-',
                            purchaseId: p.id,
                            supplier: p.supplier,
                            amount: initialBalance,
                            method: p.paymentMethod,
                            paidBy: p.recordedBy,
                            notes: 'Fully paid on purchase',
                            type: 'Direct Payment',
                            status: 'Fully Paid'
                        });
                    }
                }
                
                // Also show purchases with balance that have been fully cleared through payments
                if (initialBalance > 0 && currentBalance <= 0 && totalPaid >= initialBalance) {
                    // Add a summary entry showing full clearance
                    const hasPayments = supplierPayments.filter(sp => sp.purchaseId === p.id).length > 0;
                    if (hasPayments) {
                        allPaymentRecords.push({
                            id: `${p.id}-CLEARED`,
                            date: p.date.split('T')[0],
                            creditId: '-',
                            purchaseId: p.id,
                            supplier: p.supplier,
                            amount: totalPaid,
                            method: 'Multiple',
                            paidBy: '-',
                            notes: `FULLY CLEARED - ${supplierPayments.filter(sp => sp.purchaseId === p.id).length} payment(s) made`,
                            type: 'Status Update',
                            status: 'Fully Paid'
                        });
                    }
                }
            });
            
            // Sort by date
            allPaymentRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (allPaymentRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="padding: 40px; text-align: center; color: var(--gray);">No supplier payment records found. Click "Supplier Payment" to record payments to suppliers.</td></tr>';
                return;
            }
            
            tbody.innerHTML = allPaymentRecords.map(sp => {
                const statusBadge = sp.status === 'Fully Paid' 
                    ? '<span style="background: var(--success); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">FULLY PAID</span>'
                    : '<span style="background: var(--info); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">PAYMENT</span>';
                
                return `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${sp.id}</td>
                    <td style="padding: 12px;">${formatDate(sp.date)}</td>
                    <td style="padding: 12px; color: var(--primary);">${sp.creditId}</td>
                    <td style="padding: 12px; font-weight: 600; color: var(--primary);">${sp.purchaseId}</td>
                    <td style="padding: 12px; font-weight: 600;">${sp.supplier}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--danger);">UGX ${formatNumber(sp.amount)}</td>
                    <td style="padding: 12px;">${sp.method}</td>
                    <td style="padding: 12px;">${sp.paidBy}</td>
                    <td style="padding: 12px;">
                        ${statusBadge}
                        <div style="font-size: 11px; color: var(--gray); margin-top: 4px;">${sp.notes}</div>
                    </td>
                </tr>
            `}).join('');
        }

        function renderPriceAnalysisView() {
            const tbody = document.getElementById('price-analysis-tbody');
            const priceData = [];
            
            // Build price analysis from purchases with matched selling prices from readings
            purchases.forEach(purchase => {
                const purchaseDate = purchase.date.split('T')[0];
                const product = purchase.product.toUpperCase().includes('PMS') || purchase.product.toLowerCase().includes('petrol') ? 'PMS' : 'AGO';
                const costPrice = purchase.pricePerLiter || 0;
                
                // Find readings from the same date to get selling price
                let sellingPrice = 0;
                let litresSold = 0;
                
                readings.forEach(r => {
                    if (r.date === purchaseDate) {
                        if (product === 'PMS' && r.pmsPrice) {
                            sellingPrice = r.pmsPrice;
                            litresSold += (r.pmsSold || 0);
                        } else if (product === 'AGO' && r.agoPrice) {
                            sellingPrice = r.agoPrice;
                            litresSold += (r.agoSold || 0);
                        }
                    }
                });
                
                // Calculate margins
                const marginPerLiter = sellingPrice - costPrice;
                const totalMargin = marginPerLiter * litresSold;
                const marginPercent = costPrice > 0 ? ((marginPerLiter / costPrice) * 100) : 0;
                
                priceData.push({
                    purchaseId: purchase.id,
                    date: purchaseDate,
                    product: product,
                    supplier: purchase.supplier,
                    costPrice: costPrice,
                    sellingPrice: sellingPrice,
                    marginPerLiter: marginPerLiter,
                    totalMargin: totalMargin,
                    marginPercent: marginPercent,
                    litresPurchased: purchase.litres || 0,
                    litresSold: litresSold,
                    autoDetected: sellingPrice > 0 ? 'Yes' : 'Manual'
                });
            });
            
            // Sort by date (newest first)
            priceData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (priceData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="padding: 40px; text-align: center; color: var(--gray);">No price analysis data found. Complete meter readings and purchase records to see price trends and profit margins.</td></tr>';
                return;
            }
            
            tbody.innerHTML = priceData.map(p => {
                const marginColor = p.marginPerLiter >= 0 ? 'var(--success)' : 'var(--danger)';
                const autoColor = p.autoDetected === 'Yes' ? 'var(--success)' : 'var(--warning)';
                
                return `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px; font-weight: 600; color: var(--primary);">${p.purchaseId}</td>
                    <td style="padding: 12px;">${formatDate(p.date)}</td>
                    <td style="padding: 12px;">
                        <span style="background: ${p.product === 'PMS' ? '#3b82f6' : '#f59e0b'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                            ${p.product}
                        </span>
                    </td>
                    <td style="padding: 12px; font-weight: 600;">${p.supplier}</td>
                    <td style="padding: 12px; text-align: right;">UGX ${formatNumber(p.costPrice)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--primary);">UGX ${formatNumber(p.sellingPrice)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: ${marginColor};">
                        UGX ${formatNumber(p.marginPerLiter)}
                        <div style="font-size: 10px; color: var(--gray);">${p.marginPercent.toFixed(1)}%</div>
                    </td>
                    <td style="padding: 12px; text-align: right; font-weight: 700; color: ${marginColor};">
                        UGX ${formatNumber(p.totalMargin)}
                        <div style="font-size: 10px; color: var(--gray);">${formatNumber(p.litresSold)}L sold</div>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="background: ${autoColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">
                            ${p.autoDetected}
                        </span>
                    </td>
                </tr>
            `}).join('');
        }

        function renderPettyCashView() {
            const tbody = document.getElementById('petty-cash-tbody');
            const allPetty = [];
            let pettyCounter = 0;  // Use counter for sequential IDs
            
            // Extract petty cash from readings
            readings.forEach(r => {
                if (r.pettyCashTransactions && r.pettyCashTransactions.length > 0) {
                    r.pettyCashTransactions.forEach((petty, idx) => {
                        pettyCounter++;
                        allPetty.push({
                            id: `EW${String(pettyCounter).padStart(3, '0')}`,
                            date: r.date,
                            name: r.staff,
                            detail: `${petty.category} - ${petty.description}`,
                            amount: petty.amount
                        });
                    });
                }
            });
            
            if (allPetty.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 40px; text-align: center; color: var(--gray);">No petty cash records found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = allPetty.map(p => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${p.id}</td>
                    <td style="padding: 12px;">${formatDate(p.date)}</td>
                    <td style="padding: 12px;">${p.name}</td>
                    <td style="padding: 12px;">${p.detail}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--danger);">UGX ${formatNumber(p.amount)}</td>
                </tr>
            `).join('');
        }

        function renderExpensesView() {
            const tbody = document.getElementById('expenses-tbody');
            
            // Combine regular expenses with petty cash totals from readings
            const allExpenses = [];
            
            // 1. Add regular expenses
            expenses.forEach(e => {
                allExpenses.push({
                    id: e.id,
                    date: e.date,
                    category: e.category,
                    description: e.description,
                    amount: e.amount,
                    paymentMethod: e.paymentMethod,
                    paidTo: e.paidTo,
                    reference: e.reference || '-',
                    approvedBy: e.approvedBy,
                    recordedBy: e.recordedBy,
                    receipt: e.receipt,
                    notes: e.notes || '-',
                    status: e.status,
                    sortDate: new Date(e.date)
                });
            });
            
            // 2. Add petty cash totals from readings (one entry per shift)
            readings.forEach(r => {
                // Check if this reading already has a petty cash expense entry
                const expenseExists = expenses.some(e => 
                    e.reference === r.id && e.category === 'Petty Cash'
                );
                if (expenseExists) return; // Skip if already exists
                
                if (r.pettyCashTransactions && r.pettyCashTransactions.length > 0) {
                    const pettyTotal = r.pettyCashTransactions.reduce((sum, p) => sum + p.amount, 0);
                    
                    allExpenses.push({
                        id: r.id.replace('ME', 'EX'),  // Convert ME 0001 to EX 0001
                        date: r.date,
                        category: 'Petty Cash',
                        description: 'Staff welfare - Total pettycash',
                        amount: pettyTotal,
                        paymentMethod: 'Cash',
                        paidTo: 'Staff',
                        reference: r.id.replace('ME', 'SA'),  // Reference to Sales ID (SA 0001 not ME 0001)
                        approvedBy: r.staff,
                        recordedBy: r.staff,
                        receipt: 'Yes',
                        notes: `${r.shift} Shift - ${r.pump}`,
                        status: 'Paid',
                        sortDate: new Date(r.date + ' ' + (r.shift === 'MORNING' ? '06:00' : '18:00'))
                    });
                }
            });
            
            // Sort by date
            allExpenses.sort((a, b) => a.sortDate - b.sortDate);
            
            // Calculate petty cash summary (only from readings-based entries)
            const pettyCashExpenses = allExpenses.filter(e => e.category === 'Petty Cash');
            const pettyCashTotal = pettyCashExpenses.reduce((sum, e) => sum + e.amount, 0);
            const pettyCashCount = pettyCashExpenses.length;
            
            // Update summary display
            document.getElementById('petty-cash-total').textContent = `UGX ${formatNumber(pettyCashTotal)}`;
            document.getElementById('petty-cash-count').textContent = pettyCashCount;
            
            if (allExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" style="padding: 40px; text-align: center; color: var(--gray);">No expense records found. Click "Add Expense" to record business expenses.</td></tr>';
                return;
            }
            
            tbody.innerHTML = allExpenses.map(e => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${e.id}</td>
                    <td style="padding: 12px;">${formatDate(e.date)}</td>
                    <td style="padding: 12px;"><span style="background: ${e.category === 'Petty Cash' ? '#667eea' : 'var(--secondary)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${e.category}</span></td>
                    <td style="padding: 12px;">${e.description}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--danger);">UGX ${formatNumber(e.amount)}</td>
                    <td style="padding: 12px;">${e.paymentMethod}</td>
                    <td style="padding: 12px;">${e.paidTo}</td>
                    <td style="padding: 12px;">${e.reference}</td>
                    <td style="padding: 12px;">${e.approvedBy}</td>
                    <td style="padding: 12px;">${e.recordedBy}</td>
                    <td style="padding: 12px; text-align: center;"><span style="background: ${e.receipt === 'Yes' ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${e.receipt}</span></td>
                    <td style="padding: 12px;">${e.notes}</td>
                    <td style="padding: 12px; text-align: center;"><span style="background: ${e.status === 'Paid' ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${e.status}</span></td>
                </tr>
            `).join('');
        }

        function renderMobileMoneyView() {
            const tbody = document.getElementById('mobile-money-tbody');
            const allMomo = [];
            
            // 1. MOMO IN: Sales from readings
            readings.forEach(r => {
                if (r.momoTransactions && r.momoTransactions.length > 0) {
                    r.momoTransactions.forEach((momo, idx) => {
                        allMomo.push({
                            ref: `MM${String(allMomo.length + 1).padStart(3, '0')}`,
                            date: r.date,
                            time: r.shift === 'MORNING' ? '06:00' : '18:00',
                            name: r.staff,
                            type: 'Sales',
                            category: 'MoMo Collection',
                            detail: `${momo.provider} - ${momo.customer}`,
                            inAmount: momo.amount,
                            outAmount: 0
                        });
                    });
                }
            });
            
            // 2. MOMO IN: Credit payments received via mobile money
            creditPayments.forEach(cp => {
                if (cp.method === 'Mobile Money' || cp.method === 'MoMo') {
                    allMomo.push({
                        ref: cp.id,
                        date: cp.date.split('T')[0],
                        time: cp.date.split('T')[1] ? cp.date.split('T')[1].substring(0, 5) : '12:00',
                        name: cp.clearedBy,
                        type: 'Credit Payment',
                        category: 'MoMo Collection',
                        detail: `Payment for ${cp.creditId}`,
                        inAmount: cp.amount,
                        outAmount: 0
                    });
                }
            });
            
            // 3. MOMO OUT: Purchases paid via mobile money
            purchases.forEach(p => {
                if (p.paymentMethod === 'Mobile Money' || p.paymentMethod === 'MoMo') {
                    allMomo.push({
                        ref: p.id,
                        date: p.date.split('T')[0],
                        time: p.date.split('T')[1] ? p.date.split('T')[1].substring(0, 5) : '12:00',
                        name: p.recordedBy,
                        type: 'Purchase',
                        category: 'MoMo Payment',
                        detail: `${p.product} from ${p.supplier}`,
                        inAmount: 0,
                        outAmount: p.totalAmount
                    });
                }
            });
            
            // 4. MOMO OUT: Expenses paid via mobile money
            expenses.forEach(e => {
                if (e.paymentMethod === 'Mobile Money' || e.paymentMethod === 'MoMo') {
                    allMomo.push({
                        ref: e.id,
                        date: e.date,
                        time: '12:00',
                        name: e.recordedBy,
                        type: 'Expense',
                        category: 'MoMo Payment',
                        detail: `${e.category} - ${e.description}`,
                        inAmount: 0,
                        outAmount: e.amount
                    });
                }
            });
            
            // 5. MOMO OUT: Supplier payments via mobile money
            supplierPayments.forEach(sp => {
                if (sp.method === 'Mobile Money' || sp.method === 'MoMo') {
                    allMomo.push({
                        ref: sp.id,
                        date: sp.date,
                        time: '12:00',
                        name: sp.paidBy,
                        type: 'Supplier Payment',
                        category: 'MoMo Payment',
                        detail: `Payment to ${sp.supplier} for ${sp.purchaseId}`,
                        inAmount: 0,
                        outAmount: sp.amount
                    });
                }
            });
            
            // Sort by date and time
            allMomo.sort((a, b) => {
                const dateA = new Date(a.date + ' ' + a.time);
                const dateB = new Date(b.date + ' ' + b.time);
                return dateA - dateB;
            });
            
            // Calculate running balance
            let runningBalance = 0;
            allMomo.forEach(m => {
                runningBalance += m.inAmount - m.outAmount;
                m.balance = runningBalance;
            });
            
            if (allMomo.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: var(--gray);">No mobile money records found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = allMomo.map(m => {
                const typeColor = m.category === 'MoMo Collection' ? 'var(--success)' : 'var(--danger)';
                return `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${formatDate(m.date)}</td>
                    <td style="padding: 12px;">${m.name}</td>
                    <td style="padding: 12px;"><span style="background: ${typeColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${m.type}</span></td>
                    <td style="padding: 12px; color: var(--primary); font-weight: 600;">${m.ref}</td>
                    <td style="padding: 12px; text-align: right; color: var(--success); font-weight: 600;">${m.inAmount > 0 ? 'UGX ' + formatNumber(m.inAmount) : '-'}</td>
                    <td style="padding: 12px; text-align: right; color: var(--danger); font-weight: 600;">${m.outAmount > 0 ? 'UGX ' + formatNumber(m.outAmount) : '-'}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: ${m.balance >= 0 ? 'var(--success)' : 'var(--danger)'};">UGX ${formatNumber(m.balance)}</td>
                </tr>
            `}).join('');
        }

        function renderCashTransactionsView() {
            const tbody = document.getElementById('cash-transactions-tbody');
            const allCash = [];
            
            // 1. CASH IN: Sales collections from readings
            readings.forEach(r => {
                if (r.cash && r.cash > 0) {
                    allCash.push({
                        ref: r.id.replace('ME', 'SA'),
                        date: r.date,
                        time: r.shift === 'MORNING' ? '06:00' : '18:00',
                        name: r.staff,
                        type: 'Sales',
                        category: 'Cash Collection',
                        inAmount: r.cash,
                        outAmount: 0,
                        details: `${r.shift} Shift - ${r.pump}`
                    });
                }
            });
            
            // 2. CASH IN: Credit payments received in cash
            creditPayments.forEach(cp => {
                if (cp.method === 'Cash') {
                    allCash.push({
                        ref: cp.id,
                        date: cp.date.split('T')[0],
                        time: cp.date.split('T')[1] ? cp.date.split('T')[1].substring(0, 5) : '12:00',
                        name: cp.clearedBy,
                        type: 'Credit Payment',
                        category: 'Cash Collection',
                        inAmount: cp.amount,
                        outAmount: 0,
                        details: `Payment for ${cp.creditId}`
                    });
                }
            });
            
            // 3. CASH OUT: Purchases paid in cash
            purchases.forEach(p => {
                if (p.paymentMethod === 'Cash') {
                    allCash.push({
                        ref: p.id,
                        date: p.date.split('T')[0],
                        time: p.date.split('T')[1] ? p.date.split('T')[1].substring(0, 5) : '12:00',
                        name: p.recordedBy,
                        type: 'Purchase',
                        category: 'Cash Payment',
                        inAmount: 0,
                        outAmount: p.totalAmount,
                        details: `${p.product} from ${p.supplier}`
                    });
                }
            });
            
            // 4. CASH OUT: Expenses paid in cash
            expenses.forEach(e => {
                if (e.paymentMethod === 'Cash') {
                    allCash.push({
                        ref: e.id,
                        date: e.date,
                        time: '12:00',
                        name: e.recordedBy,
                        type: 'Expense',
                        category: 'Cash Payment',
                        inAmount: 0,
                        outAmount: e.amount,
                        details: `${e.category} - ${e.description}`
                    });
                }
            });
            
            // 5. CASH OUT: Petty cash from readings
            readings.forEach(r => {
                if (r.pettyCashTransactions && r.pettyCashTransactions.length > 0) {
                    const pettyTotal = r.pettyCashTransactions.reduce((sum, p) => sum + p.amount, 0);
                    if (pettyTotal > 0) {
                        allCash.push({
                            ref: r.id.replace('ME', 'EX'),
                            date: r.date,
                            time: r.shift === 'MORNING' ? '06:00' : '18:00',
                            name: r.staff,
                            type: 'Petty Cash',
                            category: 'Cash Payment',
                            inAmount: 0,
                            outAmount: pettyTotal,
                            details: `${r.shift} Shift petty expenses`
                        });
                    }
                }
            });
            
            // 6. CASH OUT: Supplier payments in cash
            supplierPayments.forEach(sp => {
                if (sp.method === 'Cash') {
                    allCash.push({
                        ref: sp.id,
                        date: sp.date,
                        time: '12:00',
                        name: sp.paidBy,
                        type: 'Supplier Payment',
                        category: 'Cash Payment',
                        inAmount: 0,
                        outAmount: sp.amount,
                        details: `Payment to ${sp.supplier} for ${sp.purchaseId}`
                    });
                }
            });
            
            // Sort by date and time
            allCash.sort((a, b) => {
                const dateA = new Date(a.date + ' ' + a.time);
                const dateB = new Date(b.date + ' ' + b.time);
                return dateA - dateB;
            });
            
            // Calculate running balance
            let runningBalance = 0;
            allCash.forEach(c => {
                runningBalance += c.inAmount - c.outAmount;
                c.balance = runningBalance;
            });
            
            if (allCash.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: var(--gray);">No cash transaction records found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = allCash.map(c => {
                const typeColor = c.category === 'Cash Collection' ? 'var(--success)' : 'var(--danger)';
                return `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${formatDate(c.date)}</td>
                    <td style="padding: 12px;">${c.name}</td>
                    <td style="padding: 12px;"><span style="background: ${typeColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${c.type}</span></td>
                    <td style="padding: 12px; color: var(--primary); font-weight: 600;">${c.ref}</td>
                    <td style="padding: 12px; text-align: right; color: var(--success); font-weight: 600;">${c.inAmount > 0 ? 'UGX ' + formatNumber(c.inAmount) : '-'}</td>
                    <td style="padding: 12px; text-align: right; color: var(--danger); font-weight: 600;">${c.outAmount > 0 ? 'UGX ' + formatNumber(c.outAmount) : '-'}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: ${c.balance >= 0 ? 'var(--success)' : 'var(--danger)'};">UGX ${formatNumber(c.balance)}</td>
                </tr>
            `}).join('');
        }

        function renderStaffAccountability() {
            const tbody = document.getElementById('staff-accountability-tbody');
            const staffFilter = document.getElementById('staff-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const dateFrom = document.getElementById('staff-date-from').value;
            const dateTo = document.getElementById('staff-date-to').value;
            
            const staffTransactions = [];
            let staffIdCounter = {};
            
            // Helper to get staff ID
            const getStaffId = (name) => {
                if (!staffIdCounter[name]) {
                    staffIdCounter[name] = Object.keys(staffIdCounter).length + 1;
                }
                return `ST ${String(staffIdCounter[name]).padStart(3, '0')}`;
            };
            
            // Extract transactions from readings
            readings.forEach(r => {
                // Filter by date if specified
                if (dateFrom && r.date < dateFrom) return;
                if (dateTo && r.date > dateTo) return;
                
                // Filter by staff if specified
                if (staffFilter && r.staff !== staffFilter) return;
                
                // 1. Sales
                if (r.totalSales && r.totalSales > 0) {
                    if (!categoryFilter || categoryFilter === 'Sales') {
                        staffTransactions.push({
                            staffId: getStaffId(r.staff),
                            date: r.date,
                            name: r.staff,
                            category: 'Sales',
                            reference: r.id.replace('ME', 'SA'),
                            details: `${r.shift} Shift - ${r.pump} - PMS: ${formatNumber(r.pmsSold)}L, AGO: ${formatNumber(r.agoSold)}L`,
                            amount: r.totalSales,
                            status: 'Completed'
                        });
                    }
                }
                
                // 2. Credits Issued
                if (r.creditTransactions && r.creditTransactions.length > 0) {
                    r.creditTransactions.forEach((credit, idx) => {
                        if (!categoryFilter || categoryFilter === 'Credit Issued') {
                            const timestampId = credit.id ? credit.id.toString() : '';
                            const creditId = `CR ${String(idx + 1).padStart(4, '0')}`;
                            
                            // Check if credit has been paid
                            const totalPaid = creditPayments
                                .filter(cp => cp.creditId === timestampId || 
                                             cp.creditId === `CR ${timestampId}` ||
                                             cp.creditId === creditId)
                                .reduce((sum, cp) => sum + cp.amount, 0);
                            
                            const balance = credit.amount - totalPaid;
                            let status = 'Pending Payment';
                            if (balance <= 0) {
                                status = 'Fully Paid';
                            } else if (totalPaid > 0) {
                                status = 'Partially Paid';
                            }
                            
                            staffTransactions.push({
                                staffId: getStaffId(r.staff),
                                date: r.date,
                                name: r.staff,
                                category: 'Credit Issued',
                                reference: creditId,
                                details: `Credit to ${credit.customer} - ${credit.fuel} ${totalPaid > 0 ? `(Paid: UGX ${formatNumber(totalPaid)})` : ''}`,
                                amount: credit.amount,
                                status: status,
                                creditId: timestampId,
                                balance: balance
                            });
                        }
                    });
                }
                
                // 3. Mobile Money
                if (r.momoTransactions && r.momoTransactions.length > 0) {
                    r.momoTransactions.forEach((momo, idx) => {
                        if (!categoryFilter || categoryFilter === 'Mobile Money') {
                            staffTransactions.push({
                                staffId: getStaffId(r.staff),
                                date: r.date,
                                name: r.staff,
                                category: 'Mobile Money',
                                reference: `MM${String(idx + 1).padStart(3, '0')}`,
                                details: `${momo.provider} - ${momo.customer}`,
                                amount: momo.amount,
                                status: 'Received'
                            });
                        }
                    });
                }
                
                // 4. Petty Cash
                if (r.pettyCashTransactions && r.pettyCashTransactions.length > 0) {
                    r.pettyCashTransactions.forEach((petty, idx) => {
                        if (!categoryFilter || categoryFilter === 'Petty Cash') {
                            staffTransactions.push({
                                staffId: getStaffId(r.staff),
                                date: r.date,
                                name: r.staff,
                                category: 'Petty Cash',
                                reference: `EW${String(idx + 1).padStart(3, '0')}`,
                                details: `${petty.description} (${petty.category})`,
                                amount: petty.amount,
                                status: 'Spent'
                            });
                        }
                    });
                }
                
                // 5. Losses
                if (r.losses && r.losses > 0) {
                    if (!categoryFilter || categoryFilter === 'Loss') {
                        // Check if loss has been cleared
                        const payment = lossPayments.find(lp => lp.readingId === r.id);
                        const status = payment ? 'Cleared' : 'Outstanding';
                        
                        staffTransactions.push({
                            staffId: getStaffId(r.staff),
                            date: r.date,
                            name: r.staff,
                            category: 'Loss',
                            reference: r.id.replace('ME', 'SA'),
                            details: `${r.shift} Shift - Cash Shortage`,
                            amount: r.losses,
                            status: status,
                            readingId: r.id,  // Store for Clear Loss button
                            cleared: !!payment
                        });
                    }
                }
            });
            
            // BATCH 3: Add Staff Expenses (Advance, Loan, Fine, Loss) linked to Staff Master
            expenses.forEach(expense => {
                // Skip if no paidTo field
                if (!expense.paidTo || expense.paidTo.trim() === '') return;
                
                // Check if this is a staff-related expense by category OR by name
                const staffExpenseCategories = ['Advance', 'Loan', 'Fine', 'Loss', 'advance', 'loan', 'fine', 'loss'];
                const commonStaffNames = ['WINNIE', 'CYRUS', 'RONALD', 'NORBERT', 'BRIAN', 'ISAAC'];
                
                const isStaffExpenseByCategory = staffExpenseCategories.some(cat => 
                    expense.category && expense.category.toLowerCase().includes(cat)
                );
                
                const isStaffExpenseByName = commonStaffNames.some(name => 
                    expense.paidTo.toUpperCase().includes(name)
                );
                
                // If not a staff expense by category or name, skip
                if (!isStaffExpenseByCategory && !isStaffExpenseByName) return;
                
                // Match expense.paidTo with staff names (flexible matching)
                const paidToClean = expense.paidTo.trim().toUpperCase();
                
                // Try to match with staffMaster first
                const matchedStaff = staffMaster.find(staff => 
                    staff.fullName && staff.fullName.trim().toUpperCase() === paidToClean
                );
                
                // If no staffMaster match, try to extract staff name from common names
                let staffName = expense.paidTo;
                if (!matchedStaff) {
                    const foundName = commonStaffNames.find(name => paidToClean.includes(name));
                    if (foundName) staffName = foundName;
                }
                
                // Filter by date if specified
                if (dateFrom && expense.date < dateFrom) return;
                if (dateTo && expense.date > dateTo) return;
                
                // Filter by staff if specified (flexible matching)
                if (staffFilter) {
                    const filterClean = staffFilter.trim().toUpperCase();
                    const nameClean = staffName.trim().toUpperCase();
                    if (!nameClean.includes(filterClean) && !filterClean.includes(nameClean)) return;
                }
                
                // Filter by category (if user is filtering for specific categories)
                if (!categoryFilter || categoryFilter === expense.category) {
                    const expenseCategoryColor = {
                        'Advance': '#10b981',
                        'Loan': '#3b82f6',
                        'Fine': '#ef4444',
                        'Loss': '#7c3aed',
                        'Staff Loan': '#3b82f6',
                        'Staff Advance': '#10b981',
                        'Salary Advance': '#10b981'
                    };
                    
                    staffTransactions.push({
                        staffId: matchedStaff ? matchedStaff.id : getStaffId(staffName),
                        date: expense.date,
                        name: staffName,
                        category: expense.category,
                        reference: expense.id,
                        details: `${expense.description || 'N/A'} - ${expense.paymentMethod}`,
                        amount: expense.amount,
                        status: expense.status || 'Paid',
                        expenseId: expense.id,
                        categoryColor: expenseCategoryColor[expense.category] || '#6b7280',
                        isExpense: true  // Flag to identify expenses for action buttons
                    });
                }
            });
            
            // Sort by date (most recent first)
            staffTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (staffTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="padding: 40px; text-align: center; color: var(--gray);">No staff transactions found matching filters.</td></tr>';
                document.getElementById('staff-total-amount').textContent = 'UGX 0';
                return;
            }
            
            // Calculate total
            const totalAmount = staffTransactions.reduce((sum, t) => sum + t.amount, 0);
            
            // Render table
            tbody.innerHTML = staffTransactions.map(t => {
                const categoryColors = {
                    'Sales': 'var(--success)',
                    'Credit Issued': 'var(--primary)',
                    'Mobile Money': '#8b5cf6',
                    'Petty Cash': 'var(--danger)',
                    'Loss': '#7c3aed',
                    'Advance': '#10b981',
                    'Loan': '#3b82f6',
                    'Fine': '#ef4444',
                    'Staff Loan': '#3b82f6',
                    'Staff Advance': '#10b981',
                    'Salary Advance': '#10b981'
                };
                
                const statusColors = {
                    'Completed': 'var(--success)',
                    'Pending Payment': '#f59e0b',
                    'Fully Paid': 'var(--success)',
                    'Partially Paid': '#f59e0b',
                    'Received': 'var(--success)',
                    'Spent': 'var(--danger)',
                    'Outstanding': '#ef4444',
                    'Cleared': 'var(--success)',
                    'Paid': 'var(--success)'
                };
                
                // Add action buttons for transactions
                let actionButton = '-';
                
                // Loss transactions
                if (t.category === 'Loss' && !t.cleared && t.readingId) {
                    actionButton = `<button class="btn btn-primary btn-sm" onclick="showClearLossModal('${t.readingId}')">Clear Loss</button>`;
                } else if (t.category === 'Loss' && t.cleared) {
                    actionButton = '<span style="color: var(--success); font-weight: 600;">‚úì Cleared</span>';
                }
                
                // Staff expenses (Advance, Loan, Fine) - Show status-based actions
                if (t.isExpense) {
                    const expenseCategories = ['Advance', 'Loan', 'Fine', 'advance', 'loan', 'fine'];
                    const isStaffExpense = expenseCategories.some(cat => 
                        t.category && t.category.toLowerCase().includes(cat)
                    );
                    
                    if (isStaffExpense) {
                        if (t.status === 'Paid' || t.status === 'Completed') {
                            if (t.category.toLowerCase().includes('loan') || t.category.toLowerCase().includes('fine')) {
                                actionButton = '<span style="color: var(--success); font-weight: 600;">‚úì Paid</span>';
                            } else if (t.category.toLowerCase().includes('advance')) {
                                actionButton = '<span style="color: var(--success); font-weight: 600;">‚úì Given</span>';
                            } else {
                                actionButton = '<span style="color: var(--success); font-weight: 600;">‚úì Paid</span>';
                            }
                        } else {
                            // Show action button for pending expenses
                            actionButton = `<button class="btn btn-primary btn-sm" onclick="markExpensePaid('${t.expenseId}')">Mark Paid</button>`;
                        }
                    }
                }
                
                return `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px; font-weight: 600; color: var(--primary);">${t.staffId}</td>
                    <td style="padding: 12px;">${formatDate(t.date)}</td>
                    <td style="padding: 12px; font-weight: 600;">${t.name}</td>
                    <td style="padding: 12px;">
                        <span style="background: ${categoryColors[t.category] || 'var(--gray)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                            ${t.category}
                        </span>
                    </td>
                    <td style="padding: 12px; color: var(--primary); font-weight: 600;">${t.reference}</td>
                    <td style="padding: 12px; color: var(--gray);">${t.details}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: ${t.category === 'Loss' || t.category === 'Petty Cash' ? 'var(--danger)' : 'var(--success)'};">
                        UGX ${formatNumber(t.amount)}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="background: ${statusColors[t.status] || 'var(--gray)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">
                            ${t.status}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        ${actionButton}
                    </td>
                </tr>
            `}).join('');
            
            document.getElementById('staff-total-amount').textContent = 'UGX ' + formatNumber(totalAmount);
        }

        function renderStockControl() {
            const tbody = document.getElementById('stock-control-tbody');
            const fuelFilter = document.getElementById('stock-fuel-filter').value;
            const dateFrom = document.getElementById('stock-date-from').value;
            const dateTo = document.getElementById('stock-date-to').value;
            
            const stockMovements = [];
            let pmsBalance = 0;
            let agoBalance = 0;
            let totalPMSPurchased = 0;
            let totalAGOPurchased = 0;
            let totalPMSSold = 0;
            let totalAGOSold = 0;
            
            // Collect all movements (purchases and sales)
            const allMovements = [];
            
            // Add purchases (IN)
            purchases.forEach(p => {
                allMovements.push({
                    date: p.date,
                    type: 'Purchase',
                    fuel: p.product,
                    reference: p.id,
                    details: `From ${p.supplier} - Invoice: ${p.invoice}`,
                    inAmount: p.litres,
                    outAmount: 0,
                    timestamp: new Date(p.date).getTime()
                });
            });
            
            // Add sales (OUT)
            readings.forEach(r => {
                if (r.pmsSold && r.pmsSold > 0) {
                    allMovements.push({
                        date: r.date,
                        type: 'Sales',
                        fuel: 'PMS',
                        reference: r.id.replace('ME', 'SA'),
                        details: `${r.shift} Shift - ${r.pump} - ${r.staff}`,
                        inAmount: 0,
                        outAmount: r.pmsSold,
                        timestamp: new Date(r.date).getTime()
                    });
                }
                
                if (r.agoSold && r.agoSold > 0) {
                    allMovements.push({
                        date: r.date,
                        type: 'Sales',
                        fuel: 'AGO',
                        reference: r.id.replace('ME', 'SA'),
                        details: `${r.shift} Shift - ${r.pump} - ${r.staff}`,
                        inAmount: 0,
                        outAmount: r.agoSold,
                        timestamp: new Date(r.date).getTime()
                    });
                }
            });
            
            // Sort by date (oldest first)
            allMovements.sort((a, b) => a.timestamp - b.timestamp);
            
            // Calculate running balances and filter
            allMovements.forEach(m => {
                // Apply filters
                if (fuelFilter && m.fuel !== fuelFilter) return;
                if (dateFrom && m.date < dateFrom) return;
                if (dateTo && m.date > dateTo) return;
                
                // Update balances
                if (m.fuel === 'PMS') {
                    pmsBalance += m.inAmount - m.outAmount;
                    totalPMSPurchased += m.inAmount;
                    totalPMSSold += m.outAmount;
                    m.balance = pmsBalance;
                } else if (m.fuel === 'AGO') {
                    agoBalance += m.inAmount - m.outAmount;
                    totalAGOPurchased += m.inAmount;
                    totalAGOSold += m.outAmount;
                    m.balance = agoBalance;
                }
                
                stockMovements.push(m);
            });
            
            // Update summary cards
            document.getElementById('stock-pms-current').textContent = formatNumber(pmsBalance) + ' L';
            document.getElementById('stock-ago-current').textContent = formatNumber(agoBalance) + ' L';
            document.getElementById('stock-total-purchased').textContent = formatNumber(totalPMSPurchased + totalAGOPurchased) + ' L';
            document.getElementById('stock-total-sold').textContent = formatNumber(totalPMSSold + totalAGOSold) + ' L';
            
            if (stockMovements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--gray);">No stock movements found matching filters.</td></tr>';
                return;
            }
            
            // Render table
            tbody.innerHTML = stockMovements.map(m => {
                const typeColor = m.type === 'Purchase' ? 'var(--success)' : '#3b82f6';
                const fuelColor = m.fuel === 'PMS' ? '#10b981' : '#3b82f6';
                const balanceColor = m.balance >= 1000 ? 'var(--success)' : (m.balance >= 500 ? '#f59e0b' : 'var(--danger)');
                
                return `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${formatDate(m.date)}</td>
                    <td style="padding: 12px;">
                        <span style="background: ${typeColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                            ${m.type}
                        </span>
                    </td>
                    <td style="padding: 12px;">
                        <span style="background: ${fuelColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                            ${m.fuel}
                        </span>
                    </td>
                    <td style="padding: 12px; font-weight: 600; color: var(--primary);">${m.reference}</td>
                    <td style="padding: 12px; color: var(--gray);">${m.details}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--success);">
                        ${m.inAmount > 0 ? formatNumber(m.inAmount) : '-'}
                    </td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--danger);">
                        ${m.outAmount > 0 ? formatNumber(m.outAmount) : '-'}
                    </td>
                    <td style="padding: 12px; text-align: right; font-weight: 700; color: ${balanceColor};">
                        ${formatNumber(m.balance)}
                    </td>
                </tr>
            `}).join('');
        }

        // User Authentication Functions
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            console.log('Login attempt:', username); // Debug
            console.log('Users array:', users); // Debug
            
            // Ensure users array exists
            if (!users || users.length === 0) {
                console.log('Users array empty, reinitializing...'); // Debug
                users = [
                    { username: 'admin', password: 'admin123', name: 'Administrator', role: 'Admin' },
                    { username: 'isaac', password: 'isaac123', name: 'Isaac', role: 'Manager' },
                    { username: 'staff', password: 'staff123', name: 'Staff Member', role: 'Staff' }
                ];
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            const user = users.find(u => u.username === username && u.password === password);
            
            console.log('User found:', user); // Debug
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('login-error').style.display = 'none';
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                
                // Update sidebar user info
                document.getElementById('sidebar-user-name').textContent = currentUser.name.toUpperCase();
                document.getElementById('sidebar-user-role').textContent = currentUser.role;
                document.getElementById('welcome-user-name').textContent = currentUser.name;
                
                // Show dashboard by default
                showDashboard();
                
                // Show alerts
                checkAndDisplayAlerts();
                
                showAlert('‚úÖ Welcome back, ' + currentUser.name + '!', 'success');
                
                // Update stats
                updateStats();
            } else {
                document.getElementById('login-error').textContent = '‚ùå Invalid username or password';
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function quickLogin(username, password) {
            document.getElementById('login-username').value = username;
            document.getElementById('login-password').value = password;
            document.getElementById('login-form').dispatchEvent(new Event('submit', { cancelable: true }));
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('login-form').reset();
                document.getElementById('login-error').style.display = 'none';
            }
        }

        // Dashboard Navigation Functions
        function showDashboard() {
            // Hide all view sections
            const allViewSections = document.querySelectorAll('[id$="-section"]');
            allViewSections.forEach(section => {
                if (section.id !== 'dashboard-section') {
                    section.style.display = 'none';
                }
            });
            
            // Show dashboard
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
                dashboardSection.style.display = 'block';
            }
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.menu-item').classList.add('active'); // First menu item (Dashboard)
            
            // Update stats
            updateStats();
        }

        function checkAuth() {
            console.log('Checking auth, currentUser:', currentUser); // Debug
            if (currentUser) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                
                // Update sidebar user info
                if (document.getElementById('sidebar-user-name')) {
                    document.getElementById('sidebar-user-name').textContent = currentUser.name.toUpperCase();
                    document.getElementById('sidebar-user-role').textContent = currentUser.role;
                    document.getElementById('welcome-user-name').textContent = currentUser.name;
                }
                
                checkAndDisplayAlerts();
                showDashboard();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        }

        // Alerts System
        function checkAndDisplayAlerts() {
            const alertsContainer = document.getElementById('alerts-dashboard');
            const alerts = [];
            
            // 1. Check for unpaid customer credits
            const unpaidCredits = [];
            let creditCounter = 0;
            readings.forEach(r => {
                if (r.creditTransactions && r.creditTransactions.length > 0) {
                    r.creditTransactions.forEach(credit => {
                        // Generate CR display ID
                        creditCounter++;
                        const displayId = `CR ${String(creditCounter).padStart(4, '0')}`;
                        const timestampId = credit.id ? credit.id.toString() : '';
                        
                        // Find payments for this specific credit
                        const totalPaid = creditPayments
                            .filter(cp => cp.creditId === timestampId || 
                                         cp.creditId === `CR ${timestampId}` ||
                                         cp.creditId === displayId)
                            .reduce((sum, cp) => sum + cp.amount, 0);
                        
                        const balance = credit.amount - totalPaid;
                        
                        if (balance > 0) {
                            // Check if overdue (more than 7 days)
                            const creditDate = new Date(r.date);
                            const today = new Date();
                            const daysDiff = Math.floor((today - creditDate) / (1000 * 60 * 60 * 24));
                            
                            // Show alert for ANY unpaid credits (not just overdue)
                            unpaidCredits.push({
                                id: displayId,
                                customer: credit.customer,
                                amount: balance,
                                days: daysDiff,
                                overdue: daysDiff > 7
                            });
                        }
                    });
                }
            });
            
            // 2. Check for uncleard purchase balances
            const unpaidPurchases = [];
            purchases.forEach(p => {
                const totalPaid = supplierPayments
                    .filter(sp => sp.purchaseId === p.id)
                    .reduce((sum, sp) => sum + sp.amount, 0);
                const balance = (p.balance || 0) - totalPaid;
                
                if (balance > 0) {
                    unpaidPurchases.push({
                        id: p.id,
                        supplier: p.supplier,
                        amount: balance
                    });
                }
            });
            
            // 3. Check for unsorted losses
            const unsortedLosses = readings.filter(r => r.losses && r.losses > 0);
            
            // Build alerts HTML
            if (unpaidCredits.length > 0) {
                const overdueCredits = unpaidCredits.filter(c => c.overdue);
                const totalAmount = unpaidCredits.reduce((sum, c) => sum + c.amount, 0);
                
                alerts.push({
                    type: overdueCredits.length > 0 ? 'danger' : 'warning',
                    icon: overdueCredits.length > 0 ? 'üö®' : '‚ö†Ô∏è',
                    title: overdueCredits.length > 0 ? 'Overdue Customer Credits!' : 'Outstanding Customer Credits',
                    message: `${unpaidCredits.length} customer credit(s) unpaid - Total: UGX ${formatNumber(totalAmount)}${overdueCredits.length > 0 ? ` (${overdueCredits.length} overdue)` : ''}`,
                    details: unpaidCredits.slice(0, 5).map(c => 
                        `${c.customer}: UGX ${formatNumber(c.amount)}${c.overdue ? ' <b style="color: #dc2626;">(Overdue ' + c.days + ' days)</b>' : ' (' + c.days + ' days)'}`
                    ).join('<br>'),
                    action: "showView('credits')"  // Use single quotes inside
                });
            }
            
            if (unpaidPurchases.length > 0) {
                const totalOwed = unpaidPurchases.reduce((sum, p) => sum + p.amount, 0);
                alerts.push({
                    type: 'danger',
                    icon: 'üí∏',
                    title: 'Unpaid Supplier Balances',
                    message: `${unpaidPurchases.length} supplier balance(s) pending - Total: UGX ${formatNumber(totalOwed)}`,
                    details: unpaidPurchases.slice(0, 3).map(p => `${p.supplier}: UGX ${formatNumber(p.amount)}`).join('<br>'),
                    action: "showView('supplier-credits')"  // Use single quotes inside
                });
            }
            
            if (unsortedLosses.length > 0) {
                const totalLosses = unsortedLosses.reduce((sum, r) => sum + r.losses, 0);
                alerts.push({
                    type: 'info',
                    icon: 'üìä',
                    title: 'Unsorted Losses',
                    message: `${unsortedLosses.length} shift(s) with losses - Total: UGX ${formatNumber(totalLosses)}`,
                    details: unsortedLosses.slice(0, 3).map(r => `${r.id} - ${r.staff}: UGX ${formatNumber(r.losses)}`).join('<br>'),
                    action: "showView('staff-accountability')"  // Use single quotes inside
                });
            }
            
            // Display alerts
            if (alerts.length > 0) {
                const alertColors = {
                    warning: { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' },
                    danger: { bg: '#fee2e2', border: '#ef4444', text: '#991b1b' },
                    info: { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af' }
                };
                
                // COMPACT DISPLAY: All alerts in one line
                alertsContainer.innerHTML = `
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        ${alerts.map(alert => {
                            const color = alertColors[alert.type];
                            // Extract count and total from message
                            const match = alert.message.match(/(\d+).*Total:\s*(UGX\s*[\d,]+)/);
                            const count = match ? match[1] : '';
                            const total = match ? match[2] : '';
                            
                            return `
                                <div style="background: ${color.bg}; border: 1px solid ${color.border}; padding: 8px 12px; border-radius: 6px; display: inline-flex; align-items: center; gap: 8px; cursor: pointer;" onclick="${alert.action}">
                                    <span style="font-size: 18px;">${alert.icon}</span>
                                    <span style="font-size: 14px; font-weight: 600; color: ${color.text};">
                                        ${alert.title.replace('Outstanding Customer Credits', 'Credits').replace('Unpaid Supplier Balances', 'Suppliers').replace('Unsorted Losses', 'Losses')} - ${count} ${alert.title.includes('Credits') ? 'customers' : alert.title.includes('Suppliers') ? 'balances' : 'shifts'}, ${total}
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                alertsContainer.style.display = 'block';
            } else {
                alertsContainer.style.display = 'none';
            }
        }

        // Profit & Loss Functions
        function renderProfitLoss() {
            const dateFrom = document.getElementById('pl-date-from').value;
            const dateTo = document.getElementById('pl-date-to').value;
            
            let filteredReadings = readings;
            let filteredPurchases = purchases;
            let filteredExpenses = expenses;
            let filteredCreditPayments = creditPayments;
            let filteredSupplierPayments = supplierPayments;
            
            // Apply date filters
            if (dateFrom) {
                filteredReadings = filteredReadings.filter(r => r.date >= dateFrom);
                filteredPurchases = filteredPurchases.filter(p => p.date >= dateFrom);
                filteredExpenses = filteredExpenses.filter(e => e.date >= dateFrom);
                filteredCreditPayments = filteredCreditPayments.filter(cp => cp.date.split('T')[0] >= dateFrom);
                filteredSupplierPayments = filteredSupplierPayments.filter(sp => sp.date >= dateFrom);
            }
            
            if (dateTo) {
                filteredReadings = filteredReadings.filter(r => r.date <= dateTo);
                filteredPurchases = filteredPurchases.filter(p => p.date <= dateTo);
                filteredExpenses = filteredExpenses.filter(e => e.date <= dateTo);
                filteredCreditPayments = filteredCreditPayments.filter(cp => cp.date.split('T')[0] <= dateTo);
                filteredSupplierPayments = filteredSupplierPayments.filter(sp => sp.date <= dateTo);
            }
            
            // Calculate Revenue
            const salesRevenue = filteredReadings.reduce((sum, r) => sum + (r.totalSales || 0), 0);
            const creditPaymentsReceived = filteredCreditPayments.reduce((sum, cp) => sum + cp.amount, 0);
            const totalRevenue = salesRevenue + creditPaymentsReceived;
            
            // Calculate Cost of Goods Sold
            const purchasesTotal = filteredPurchases.reduce((sum, p) => sum + p.totalAmount, 0);
            const totalCOGS = purchasesTotal;
            
            // Calculate Gross Profit
            const grossProfit = totalRevenue - totalCOGS;
            
            // Calculate Operating Expenses
            const generalExpenses = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            const supplierPaymentsTotal = filteredSupplierPayments.reduce((sum, sp) => sum + sp.amount, 0);
            const lossesTotal = filteredReadings.reduce((sum, r) => sum + (r.losses || 0), 0);
            const totalExpenses = generalExpenses + supplierPaymentsTotal + lossesTotal;
            
            // Calculate Net Profit
            const netProfit = grossProfit - totalExpenses;
            
            // Update display
            document.getElementById('pl-sales-revenue').textContent = 'UGX ' + formatNumber(salesRevenue);
            document.getElementById('pl-credit-payments').textContent = 'UGX ' + formatNumber(creditPaymentsReceived);
            document.getElementById('pl-total-revenue').textContent = 'UGX ' + formatNumber(totalRevenue);
            
            document.getElementById('pl-purchases').textContent = 'UGX ' + formatNumber(purchasesTotal);
            document.getElementById('pl-total-cogs').textContent = 'UGX ' + formatNumber(totalCOGS);
            
            document.getElementById('pl-gross-profit').textContent = 'UGX ' + formatNumber(grossProfit);
            
            document.getElementById('pl-expenses').textContent = 'UGX ' + formatNumber(generalExpenses);
            document.getElementById('pl-supplier-payments').textContent = 'UGX ' + formatNumber(supplierPaymentsTotal);
            document.getElementById('pl-losses').textContent = 'UGX ' + formatNumber(lossesTotal);
            document.getElementById('pl-total-expenses').textContent = 'UGX ' + formatNumber(totalExpenses);
            
            document.getElementById('pl-net-profit').textContent = 'UGX ' + formatNumber(Math.abs(netProfit));
            
            // Update result row color
            const resultRow = document.getElementById('pl-net-result-row');
            if (netProfit >= 0) {
                resultRow.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                resultRow.querySelector('td:first-child').textContent = 'NET PROFIT';
            } else {
                resultRow.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                resultRow.querySelector('td:first-child').textContent = 'NET LOSS';
            }
            
            // Calculate margins
            const grossMargin = totalRevenue > 0 ? ((grossProfit / totalRevenue) * 100).toFixed(1) : 0;
            const netMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0;
            const expenseRatio = totalRevenue > 0 ? ((totalExpenses / totalRevenue) * 100).toFixed(1) : 0;
            
            document.getElementById('pl-gross-margin').textContent = grossMargin + '%';
            document.getElementById('pl-net-margin').textContent = netMargin + '%';
            document.getElementById('pl-expense-ratio').textContent = expenseRatio + '%';
            
            // Update period display
            const periodDisplay = document.getElementById('pl-period-display');
            if (dateFrom && dateTo) {
                periodDisplay.textContent = `Period: ${formatDate(dateFrom)} to ${formatDate(dateTo)}`;
            } else if (dateFrom) {
                periodDisplay.textContent = `Period: From ${formatDate(dateFrom)}`;
            } else if (dateTo) {
                periodDisplay.textContent = `Period: Up to ${formatDate(dateTo)}`;
            } else {
                periodDisplay.textContent = 'Period: All Time';
            }
        }

        // Google Sheets Sync Function
        function syncToGoogleSheets() {
            showAlert('üîÑ Preparing data for Google Sheets export...', 'info');
            
            // Prepare data for export
            const exportData = {
                readings: readings,
                purchases: purchases,
                expenses: expenses,
                creditPayments: creditPayments,
                supplierPayments: supplierPayments,
                exportDate: new Date().toISOString(),
                exportedBy: currentUser ? currentUser.name : 'Unknown'
            };
            
            // Convert to JSON and download
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `okum-energy-export-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert('‚úÖ Data exported! Upload this file to Google Sheets using Apps Script', 'success');
            
            // Show instructions
            setTimeout(() => {
                if (confirm('Would you like to see Google Sheets sync instructions?')) {
                    showGoogleSheetsInstructions();
                }
            }, 1000);
        }

        function showGoogleSheetsInstructions() {
            const instructions = 
`üìä GOOGLE SHEETS SYNC INSTRUCTIONS

Step 1: Create a Google Sheet
- Go to sheets.google.com
- Create a new spreadsheet named "OKUM Energy Data"

Step 2: Open Apps Script Editor
- Click Extensions ‚Üí Apps Script
- Delete any existing code

Step 3: Paste the Apps Script code
- Copy the provided code
- Paste it into the Apps Script editor

Step 4: Save and Run
- Save the script (Ctrl+S)
- Run importOkumData function
- Grant permissions when prompted

Step 5: Use the Import Button
- In your Google Sheet, click "Import OKUM Data"
- Select the exported JSON file
- Data will be imported automatically!

Step 6: Set up Auto-Sync (Optional)
- Add a time-based trigger in Apps Script
- Set it to run daily/weekly to keep data synced

The exported JSON file contains:
- Readings (all shift data)
- Purchases (supplier purchases)
- Expenses (all expenses)
- Credit Payments
- Supplier Payments
`;
            
            alert(instructions);
        }

        // Reload Data Function - Forces fresh load from localStorage
        function reloadData() {
            showAlert('üîÑ Reloading data from storage...', 'info');
            
            // Force reload all data from localStorage
            readings = JSON.parse(localStorage.getItem('readings') || '[]');
            purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            creditPayments = JSON.parse(localStorage.getItem('creditPayments') || '[]');
            supplierPayments = JSON.parse(localStorage.getItem('supplierPayments') || '[]');
            
            // Update display
            updateStats();
            
            // If currently viewing a data view, refresh it
            const currentView = Array.from(document.querySelectorAll('.readings-container'))
                .find(el => el.style.display === 'block');
            
            if (currentView) {
                const viewId = currentView.id;
                if (viewId === 'meters-view') renderMetersView();
                else if (viewId === 'sales-view') renderSalesView();
                else if (viewId === 'credits-view') renderCreditsView();
                else if (viewId === 'credit-payments-view') renderCreditPaymentsView();
                else if (viewId === 'purchases-view') renderPurchasesView();
                else if (viewId === 'expenses-view') renderExpensesView();
                else if (viewId === 'staff-accountability-view') renderStaffAccountability();
                else if (viewId === 'stock-control-view') renderStockControl();
            }
            
            showAlert(`‚úÖ Data reloaded! Found ${readings.length} meter readings, ${purchases.length} purchases, ${expenses.length} expenses.`, 'success');
        }

        // Remove Duplicates Function
        function removeDuplicates() {
            if (!confirm('This will remove duplicate entries based on ID, date, shift, and pump. Continue?')) {
                return;
            }
            
            // Reload fresh data from localStorage first
            readings = JSON.parse(localStorage.getItem('readings') || '[]');
            
            // Remove duplicate readings
            const uniqueReadings = [];
            const seenKeys = new Set();
            
            readings.forEach(r => {
                // Create unique key from ID or combination of date+shift+pump+staff
                const key = r.id || `${r.date}-${r.shift}-${r.pump}-${r.staff}`;
                
                if (!seenKeys.has(key)) {
                    seenKeys.add(key);
                    uniqueReadings.push(r);
                }
            });
            
            const removedCount = readings.length - uniqueReadings.length;
            
            if (removedCount > 0) {
                readings = uniqueReadings;
                localStorage.setItem('readings', JSON.stringify(readings));
                
                showAlert(`‚úÖ Removed ${removedCount} duplicate entries! Kept ${uniqueReadings.length} unique entries.`, 'success');
                
                // Force reload and refresh all views
                location.reload();
            } else {
                showAlert('‚úÖ No duplicates found! Your data is clean.', 'success');
            }
        }

        // Clear All Data Function
        function clearData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL data permanently!\n\nAre you absolutely sure?')) {
                return;
            }
            
            const confirmation = prompt('Type YES in capital letters to confirm deletion:');
            if (confirmation !== 'YES') {
                showAlert('‚ùå Data deletion cancelled', 'info');
                return;
            }
            
            // Clear all data arrays
            readings = [];
            purchases = [];
            expenses = [];
            creditPayments = [];
            supplierPayments = [];
            
            // Clear localStorage
            localStorage.setItem('readings', '[]');
            localStorage.setItem('purchases', '[]');
            localStorage.setItem('expenses', '[]');
            localStorage.setItem('creditPayments', '[]');
            localStorage.setItem('supplierPayments', '[]');
            
            showAlert('‚úÖ All data has been cleared. Refreshing...', 'success');
            
            // Force page reload to reset everything
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // ========================================
        // PHASE III: SETTINGS, STAFF MASTER & LOSSES CLEARING
        // ========================================

        // Settings Functions
        function loadSettings() {
            document.getElementById('settings-pms-stock').value = settings.openingStock.pms;
            document.getElementById('settings-ago-stock').value = settings.openingStock.ago;
            document.getElementById('settings-stock-date').value = settings.openingStock.date;
            
            document.getElementById('settings-cash-balance').value = settings.openingBalance.cash;
            document.getElementById('settings-momo-balance').value = settings.openingBalance.momo;
            document.getElementById('settings-balance-date').value = settings.openingBalance.date;
            
            document.getElementById('settings-pms-selling').value = settings.prices.pmsSelling;
            document.getElementById('settings-ago-selling').value = settings.prices.agoSelling;
            document.getElementById('settings-pms-cost').value = settings.prices.pmsCost;
            document.getElementById('settings-ago-cost').value = settings.prices.agoCost;
            
            // BATCH 3: Show View Locking section only for ISAAC (case-insensitive)
            const username = currentUser && currentUser.username ? currentUser.username.toUpperCase() : '';
            if (username === 'ISAAC') {
                document.getElementById('view-locking-section').style.display = 'block';
                
                // Load lock states from viewLocks
                document.getElementById('lock-meters').checked = viewLocks.meters || false;
                document.getElementById('lock-sales').checked = viewLocks.sales || false;
                document.getElementById('lock-purchases').checked = viewLocks.purchases || false;
                document.getElementById('lock-expenses').checked = viewLocks.expenses || false;
                document.getElementById('lock-credits').checked = viewLocks.credits || false;
                document.getElementById('lock-supplierCredits').checked = viewLocks.supplierCredits || false;
                document.getElementById('lock-staffMaster').checked = viewLocks.staffMaster || false;
                document.getElementById('lock-stockControl').checked = viewLocks.stockControl || false;
                document.getElementById('lock-profitLoss').checked = viewLocks.profitLoss || false;
                document.getElementById('lock-ledger').checked = viewLocks.ledger || false;
            } else {
                document.getElementById('view-locking-section').style.display = 'none';
            }
        }

        function saveOpeningStock() {
            settings.openingStock = {
                pms: parseFloat(document.getElementById('settings-pms-stock').value) || 0,
                ago: parseFloat(document.getElementById('settings-ago-stock').value) || 0,
                date: document.getElementById('settings-stock-date').value
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            showAlert('Opening stock saved successfully!', 'success');
        }

        function saveOpeningBalance() {
            settings.openingBalance = {
                cash: parseFloat(document.getElementById('settings-cash-balance').value) || 0,
                momo: parseFloat(document.getElementById('settings-momo-balance').value) || 0,
                date: document.getElementById('settings-balance-date').value
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            showAlert('Opening balance saved successfully!', 'success');
        }

        // BATCH 3: View Locking Function
        function toggleViewLock(viewName) {
            viewLocks[viewName] = document.getElementById(`lock-${viewName}`).checked;
            localStorage.setItem('viewLocks', JSON.stringify(viewLocks));
            showAlert(`${viewName} view ${viewLocks[viewName] ? 'locked' : 'unlocked'}!`, 'success');
        }

        function savePrices() {
            settings.prices = {
                pmsSelling: parseFloat(document.getElementById('settings-pms-selling').value) || 0,
                agoSelling: parseFloat(document.getElementById('settings-ago-selling').value) || 0,
                pmsCost: parseFloat(document.getElementById('settings-pms-cost').value) || 0,
                agoCost: parseFloat(document.getElementById('settings-ago-cost').value) || 0
            };
            localStorage.setItem('settings', JSON.stringify(settings));
            showAlert('Prices saved successfully!', 'success');
        }

        function changePassword() {
            const current = document.getElementById('settings-current-password').value;
            const newPass = document.getElementById('settings-new-password').value;
            const confirm = document.getElementById('settings-confirm-password').value;
            
            if (!current || !newPass || !confirm) {
                showAlert('Please fill all password fields', 'error');
                return;
            }
            
            if (currentUser.password !== current) {
                showAlert('Current password is incorrect', 'error');
                return;
            }
            
            if (newPass !== confirm) {
                showAlert('New passwords do not match', 'error');
                return;
            }
            
            if (newPass.length < 6) {
                showAlert('New password must be at least 6 characters', 'error');
                return;
            }
            
            // Update password
            currentUser.password = newPass;
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            if (userIndex !== -1) {
                users[userIndex].password = newPass;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Clear form
                document.getElementById('settings-current-password').value = '';
                document.getElementById('settings-new-password').value = '';
                document.getElementById('settings-confirm-password').value = '';
                
                showAlert('Password changed successfully!', 'success');
            }
        }

        // Staff Master Functions
        function renderStaffMaster() {
            const tbody = document.getElementById('staff-master-tbody');
            
            if (staffMaster.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--gray);"><div style="font-size: 48px; margin-bottom: 15px;">üë®‚Äçüíº</div><div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No staff members yet</div><div style="font-size: 14px;">Click "+ Add Staff" to add your first staff member</div></td></tr>';
                return;
            }
            
            tbody.innerHTML = staffMaster.map(s => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px; font-weight: 600; color: var(--primary);">${s.id}</td>
                    <td style="padding: 12px;">
                        <div style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden; background: var(--light); display: flex; align-items: center; justify-content: center;">
                            ${s.photo ? `<img src="${s.photo}" style="width: 100%; height: 100%; object-fit: cover;">` : '<span style="font-size: 24px;">üë§</span>'}
                        </div>
                    </td>
                    <td style="padding: 12px; font-weight: 600;">${s.fullName}</td>
                    <td style="padding: 12px;">${s.role}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">UGX ${formatNumber(s.baseSalary)}</td>
                    <td style="padding: 12px; text-align: center;"><span style="background: ${s.status === 'Active' ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${s.status}</span></td>
                    <td style="padding: 12px;">${s.phone || '-'}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="btn btn-primary btn-sm" onclick="viewStaffDetail('${s.id}')" style="margin-right: 5px;">View</button>
                        <button class="btn btn-secondary btn-sm" onclick="showEditStaffModal('${s.id}')" style="margin-right: 5px;">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteStaff('${s.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Staff Photo Upload Handler
        function handleStaffPhotoUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Check if it's an image
            if (!file.type.startsWith('image/')) {
                showAlert('Please select an image file (JPG, PNG, etc.)', 'error');
                input.value = '';
                return;
            }
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showAlert('Image size must be less than 2MB', 'error');
                input.value = '';
                return;
            }
            
            // Read and convert to base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                
                // Store in hidden textarea
                document.getElementById('staff-photo').value = base64Data;
                
                // Show preview
                const preview = document.getElementById('staff-photo-preview');
                preview.innerHTML = `<img src="${base64Data}" style="width: 100%; height: 100%; object-fit: cover;">`;
                
                showAlert('Photo uploaded successfully!', 'success');
            };
            
            reader.onerror = function() {
                showAlert('Error reading image file', 'error');
                input.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        function showAddStaffModal() {
            document.getElementById('staff-modal-title').textContent = 'Add Staff Member';
            document.getElementById('staff-form').reset();
            document.getElementById('staff-id').value = '';
            document.getElementById('staff-status').value = 'Active';
            
            // Clear photo preview
            document.getElementById('staff-photo-preview').innerHTML = '<span style="color: var(--gray); font-size: 48px;">üì∑</span>';
            document.getElementById('staff-photo').value = '';
            
            document.getElementById('staff-modal').style.display = 'flex';
        }

        function showEditStaffModal(staffId) {
            const staff = staffMaster.find(s => s.id === staffId);
            if (!staff) return;
            
            document.getElementById('staff-modal-title').textContent = 'Edit Staff Member';
            document.getElementById('staff-id').value = staff.id;
            document.getElementById('staff-fullname').value = staff.fullName;
            document.getElementById('staff-role').value = staff.role;
            document.getElementById('staff-salary').value = staff.baseSalary;
            document.getElementById('staff-phone').value = staff.phone || '';
            document.getElementById('staff-address').value = staff.address || '';
            document.getElementById('staff-status').value = staff.status;
            document.getElementById('staff-photo').value = staff.photo || '';
            document.getElementById('staff-notes').value = staff.notes || '';
            
            // Show existing photo preview
            const preview = document.getElementById('staff-photo-preview');
            if (staff.photo) {
                preview.innerHTML = `<img src="${staff.photo}" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                preview.innerHTML = '<span style="color: var(--gray); font-size: 48px;">üì∑</span>';
            }
            
            document.getElementById('staff-modal').style.display = 'flex';
        }

        function closeStaffModal() {
            document.getElementById('staff-modal').style.display = 'none';
        }

        document.getElementById('staff-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const staffId = document.getElementById('staff-id').value;
            const staffData = {
                fullName: document.getElementById('staff-fullname').value.trim(),
                role: document.getElementById('staff-role').value,
                baseSalary: parseFloat(document.getElementById('staff-salary').value) || 0,
                phone: document.getElementById('staff-phone').value.trim(),
                address: document.getElementById('staff-address').value.trim(),
                status: document.getElementById('staff-status').value,
                photo: document.getElementById('staff-photo').value.trim(),
                notes: document.getElementById('staff-notes').value.trim()
            };
            
            if (staffId) {
                // Update existing staff
                const index = staffMaster.findIndex(s => s.id === staffId);
                if (index !== -1) {
                    staffMaster[index] = { ...staffMaster[index], ...staffData };
                    localStorage.setItem('staffMaster', JSON.stringify(staffMaster));
                    showAlertAndReload('Staff updated successfully!', 'success');
                }
            } else {
                // Add new staff
                const newStaff = {
                    id: `ST ${String(staffMaster.length + 1).padStart(3, '0')}`,
                    ...staffData,
                    hireDate: new Date().toISOString().split('T')[0]
                };
                staffMaster.push(newStaff);
                localStorage.setItem('staffMaster', JSON.stringify(staffMaster));
                showAlertAndReload('Staff added successfully!', 'success');
            }
            
            closeStaffModal();
        });

        function deleteStaff(staffId) {
            if (!confirm('Are you sure you want to delete this staff member?')) return;
            
            staffMaster = staffMaster.filter(s => s.id !== staffId);
            localStorage.setItem('staffMaster', JSON.stringify(staffMaster));
            showAlertAndReload('Staff deleted successfully!', 'success');
        }

        function viewStaffDetail(staffId) {
            const staff = staffMaster.find(s => s.id === staffId);
            if (!staff) return;
            
            showView('staff-detail');
            
            // Set name
            document.getElementById('staff-detail-name').textContent = staff.fullName;
            
            // Set photo
            const photoDiv = document.getElementById('staff-detail-photo');
            if (staff.photo) {
                photoDiv.innerHTML = `<img src="${staff.photo}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 15px;">`;
            } else {
                photoDiv.innerHTML = '<span style="font-size: 100px;">üë§</span>';
            }
            
            // Set info
            const infoDiv = document.getElementById('staff-detail-info');
            infoDiv.innerHTML = `
                <div style="padding: 10px; background: var(--light); border-radius: 8px; margin-bottom: 5px;">
                    <div style="font-size: 12px; color: var(--gray);">Staff ID</div>
                    <div style="font-weight: 600;">${staff.id}</div>
                </div>
                <div style="padding: 10px; background: var(--light); border-radius: 8px; margin-bottom: 5px;">
                    <div style="font-size: 12px; color: var(--gray);">Role</div>
                    <div style="font-weight: 600;">${staff.role}</div>
                </div>
                <div style="padding: 10px; background: var(--light); border-radius: 8px; margin-bottom: 5px;">
                    <div style="font-size: 12px; color: var(--gray);">Base Salary</div>
                    <div style="font-weight: 600; color: var(--success);">UGX ${formatNumber(staff.baseSalary)}</div>
                </div>
                <div style="padding: 10px; background: var(--light); border-radius: 8px; margin-bottom: 5px;">
                    <div style="font-size: 12px; color: var(--gray);">Status</div>
                    <div><span style="background: ${staff.status === 'Active' ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${staff.status}</span></div>
                </div>
                ${staff.phone ? `<div style="padding: 10px; background: var(--light); border-radius: 8px; margin-bottom: 5px;">
                    <div style="font-size: 12px; color: var(--gray);">Phone</div>
                    <div style="font-weight: 600;">${staff.phone}</div>
                </div>` : ''}
                ${staff.address ? `<div style="padding: 10px; background: var(--light); border-radius: 8px; margin-bottom: 5px;">
                    <div style="font-size: 12px; color: var(--gray);">Address</div>
                    <div>${staff.address}</div>
                </div>` : ''}
            `;
            
            // Calculate financial summary
            renderStaffFinancialSummary(staffId);
        }

        function renderStaffFinancialSummary(staffId) {
            const staff = staffMaster.find(s => s.id === staffId);
            if (!staff) return;
            
            // FIX 2: Reload all data fresh from localStorage for real-time cumulative calculations
            const freshReadings = JSON.parse(localStorage.getItem('readings') || '[]');
            const freshLossPayments = JSON.parse(localStorage.getItem('lossPayments') || '[]');
            const freshExpenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const freshCreditPayments = JSON.parse(localStorage.getItem('creditPayments') || '[]');
            
            // Calculate total losses from readings
            let totalLosses = 0;
            let lossesCleared = 0;
            freshReadings.forEach(r => {
                if (r.staff === staff.fullName && r.losses > 0) {
                    totalLosses += r.losses;
                    // Check if this loss has been cleared
                    const cleared = freshLossPayments.find(lp => lp.readingId === r.id);
                    if (cleared) {
                        lossesCleared += cleared.amountPaid;
                    }
                }
            });
            
            const lossesOutstanding = totalLosses - lossesCleared;
            
            // BATCH 3: Calculate staff expenses (Advance, Loan, Fine) from expenses
            let totalAdvances = 0;
            let totalLoans = 0;
            let totalFines = 0;
            let loansOutstanding = 0;
            let finesOutstanding = 0;
            
            // FIX 3: Extract first name from staff.fullName for better matching
            // Example: "BRIAN - Okot Brian" ‚Üí "BRIAN"
            const staffFirstName = staff.fullName.split('-')[0].trim().toUpperCase();
            const staffFullNameClean = staff.fullName.trim().toUpperCase();
            
            // Reload loan/fine payments fresh
            const freshLoanFinePayments = JSON.parse(localStorage.getItem('loanFinePayments') || '[]');
            
            freshExpenses.forEach(expense => {
                // Match expense.paidTo with staff name (flexible matching)
                const paidToClean = expense.paidTo ? expense.paidTo.trim().toUpperCase() : '';
                
                // Match if:
                // 1. Exact match with full name: "BRIAN - OKOT BRIAN" === "BRIAN - OKOT BRIAN"
                // 2. Exact match with first name: "BRIAN" === "BRIAN"
                // 3. Staff full name contains paidTo: "BRIAN - OKOT BRIAN" contains "BRIAN"
                const isMatch = paidToClean === staffFullNameClean || 
                               paidToClean === staffFirstName || 
                               staffFullNameClean.includes(paidToClean);
                
                if (isMatch) {
                    if (expense.category && (expense.category.includes('Advance') || expense.category.includes('advance'))) {
                        totalAdvances += expense.amount;

                    }
                    if (expense.category && (expense.category.includes('Loan') || expense.category.includes('loan'))) {
                        totalLoans += expense.amount;
                        
                        // Calculate outstanding loan amount (after payments)
                        const paidAmount = freshLoanFinePayments
                            .filter(p => p.expenseId === expense.id)
                            .reduce((sum, p) => sum + p.amountPaid, 0);
                        loansOutstanding += (expense.amount - paidAmount);
                    }
                    if (expense.category && (expense.category.includes('Fine') || expense.category.includes('fine'))) {
                        totalFines += expense.amount;
                        
                        // Calculate outstanding fine amount (after payments)
                        const paidAmount = freshLoanFinePayments
                            .filter(p => p.expenseId === expense.id)
                            .reduce((sum, p) => sum + p.amountPaid, 0);
                        finesOutstanding += (expense.amount - paidAmount);
                    }
                }
            });
            
            // FIX 3: Calculate credits unpaid (credits issued by this staff that haven't been paid)
            let totalCreditsIssued = 0;
            let creditsUnpaid = 0;
            freshReadings.forEach(r => {
                if (r.staff === staff.fullName && r.creditTransactions && r.creditTransactions.length > 0) {
                    r.creditTransactions.forEach(credit => {
                        totalCreditsIssued += credit.amount;
                        
                        // Calculate payments made to this credit
                        const timestampId = credit.id ? credit.id.toString() : '';
                        const totalPaid = freshCreditPayments
                            .filter(cp => cp.creditId === timestampId || 
                                         cp.creditId === `CR ${timestampId}` ||
                                         cp.creditId.includes(timestampId))
                            .reduce((sum, cp) => sum + cp.amount, 0);
                        
                        const balance = credit.amount - totalPaid;
                        if (balance > 0) {
                            creditsUnpaid += balance;
                        }
                    });
                }
            });
            
            // FIX 3: Calculate Net Salary and Clear Salary using outstanding amounts
            const netSalary = staff.baseSalary - lossesOutstanding - finesOutstanding - loansOutstanding + totalAdvances;
            const clearSalary = netSalary - creditsUnpaid;  // Final take-home after credits deducted
            
            // Display summary with 8 cards
            const summaryDiv = document.getElementById('staff-financial-summary');
            summaryDiv.innerHTML = `
                <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9;">Total Losses</div>
                    <div style="font-size: 24px; font-weight: 700;">UGX ${formatNumber(totalLosses)}</div>
                </div>
                <div style="padding: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9;">Advances Given</div>
                    <div style="font-size: 24px; font-weight: 700;">UGX ${formatNumber(totalAdvances)}</div>
                </div>
                <div style="padding: 20px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 12px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9;">Loans Outstanding</div>
                    <div style="font-size: 24px; font-weight: 700;">UGX ${formatNumber(loansOutstanding)}</div>
                    <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">Total: ${formatNumber(totalLoans)} | Paid: ${formatNumber(totalLoans - loansOutstanding)}</div>
                </div>
                <div style="padding: 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9;">Fines Outstanding</div>
                    <div style="font-size: 24px; font-weight: 700;">UGX ${formatNumber(finesOutstanding)}</div>
                    <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">Total: ${formatNumber(totalFines)} | Paid: ${formatNumber(totalFines - finesOutstanding)}</div>
                </div>
                <div style="padding: 20px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 12px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9;">Outstanding Losses</div>
                    <div style="font-size: 24px; font-weight: 700;">UGX ${formatNumber(lossesOutstanding)}</div>
                </div>
                <div style="padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9;">Credits Unpaid</div>
                    <div style="font-size: 24px; font-weight: 700;">UGX ${formatNumber(creditsUnpaid)}</div>
                    <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">Total Credits: ${formatNumber(totalCreditsIssued)}</div>
                </div>
                <div style="padding: 20px; background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); border-radius: 12px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9;">Net Salary</div>
                    <div style="font-size: 24px; font-weight: 700;">UGX ${formatNumber(netSalary)}</div>
                    <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">Before Credits: Base - Losses - Fines - Loans + Advances</div>
                </div>
                <div style="padding: 20px; background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%); border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    <div style="font-size: 14px; opacity: 0.9;">üí∞ Clear Salary (Take Home)</div>
                    <div style="font-size: 28px; font-weight: 700;">UGX ${formatNumber(clearSalary)}</div>
                    <div style="font-size: 11px; opacity: 0.8; margin-top: 5px; line-height: 1.4;">
                        Base: ${formatNumber(staff.baseSalary)}<br>
                        - Outstanding Losses: ${formatNumber(lossesOutstanding)}<br>
                        - Outstanding Fines: ${formatNumber(finesOutstanding)}<br>
                        - Outstanding Loans: ${formatNumber(loansOutstanding)}<br>
                        + Advances: ${formatNumber(totalAdvances)}<br>
                        - Unpaid Credits: ${formatNumber(creditsUnpaid)}
                    </div>
                </div>
            `;
            
            
            // Display transaction history (losses + expenses) - Using fresh data
            const historyDiv = document.getElementById('staff-transaction-history');
            
            // Collect all transactions
            const allTransactions = [];
            
            // 1. Add losses from readings
            freshReadings.forEach(r => {
                if (r.staff === staff.fullName && r.losses > 0) {
                    const payment = freshLossPayments.find(lp => lp.readingId === r.id);
                    allTransactions.push({
                        date: r.date,
                        type: 'Loss',
                        reference: r.id,
                        amount: r.losses,
                        status: payment ? 'Cleared' : 'Outstanding',
                        details: payment ? `${payment.method} - ${formatDate(payment.date)}` : '',
                        color: payment ? 'var(--success)' : 'var(--danger)'
                    });
                }
            });
            
            // 2. Add staff expenses
            freshExpenses.forEach(expense => {
                const paidToClean = expense.paidTo ? expense.paidTo.trim().toUpperCase() : '';
                
                // Use same flexible matching as financial summary
                const isMatch = paidToClean === staffFullNameClean || 
                               paidToClean === staffFirstName || 
                               staffFullNameClean.includes(paidToClean);
                
                if (isMatch) {
                    const expenseCategories = ['Advance', 'Loan', 'Fine', 'Loss', 'advance', 'loan', 'fine'];
                    if (expenseCategories.some(cat => expense.category && expense.category.includes(cat))) {
                        allTransactions.push({
                            date: expense.date,
                            type: expense.category,
                            reference: expense.id,
                            amount: expense.amount,
                            status: expense.status || 'Paid',
                            details: expense.description || '-',
                            color: expense.status === 'Paid' ? 'var(--success)' : '#f59e0b',
                            expenseId: expense.id,
                            isLoanOrFine: expense.category.toLowerCase().includes('loan') || 
                                         expense.category.toLowerCase().includes('fine')
                        });
                    }
                }
            });
            
            // 3. Add credits issued by this staff
            freshReadings.forEach(r => {
                if (r.staff === staff.fullName && r.creditTransactions && r.creditTransactions.length > 0) {
                    r.creditTransactions.forEach((credit, idx) => {
                        const creditId = `CR ${String(idx + 1).padStart(4, '0')}`;
                        const timestampId = credit.id ? credit.id.toString() : '';
                        
                        // Calculate payment status
                        const totalPaid = freshCreditPayments
                            .filter(cp => cp.creditId === timestampId || 
                                         cp.creditId === `CR ${timestampId}` ||
                                         cp.creditId.includes(timestampId))
                            .reduce((sum, cp) => sum + cp.amount, 0);
                        
                        const balance = credit.amount - totalPaid;
                        let status = balance <= 0 ? 'Fully Paid' : (totalPaid > 0 ? 'Partially Paid' : 'Unpaid');
                        let statusColor = balance <= 0 ? 'var(--success)' : (totalPaid > 0 ? '#f59e0b' : 'var(--danger)');
                        
                        allTransactions.push({
                            date: r.date,
                            type: 'Credit Issued',
                            reference: creditId,
                            amount: credit.amount,
                            status: status,
                            details: `${credit.customer} - ${credit.fuel}${totalPaid > 0 ? ` (Paid: ${formatNumber(totalPaid)})` : ''}`,
                            color: statusColor
                        });
                    });
                }
            });
            
            // Sort by date (most recent first)
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allTransactions.length === 0) {
                historyDiv.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">No transactions found for this staff member.</p>';
                return;
            }
            
            historyDiv.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--light); border-bottom: 2px solid var(--border);">
                            <th style="padding: 12px; text-align: left;">Date</th>
                            <th style="padding: 12px; text-align: left;">Type</th>
                            <th style="padding: 12px; text-align: left;">Reference</th>
                            <th style="padding: 12px; text-align: right;">Amount</th>
                            <th style="padding: 12px; text-align: center;">Status</th>
                            <th style="padding: 12px; text-align: left;">Details</th>
                            <th style="padding: 12px; text-align: center;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allTransactions.map(t => {
                            // Calculate paid amount for loans/fines
                            let actionButton = '-';
                            if (t.isLoanOrFine && t.expenseId) {
                                const paidSoFar = loanFinePayments
                                    .filter(p => p.expenseId === t.expenseId)
                                    .reduce((sum, p) => sum + p.amountPaid, 0);
                                const balance = t.amount - paidSoFar;
                                
                                if (balance > 0) {
                                    actionButton = `<button class="btn btn-primary btn-sm" onclick="clearLoanOrFine('${t.expenseId}')">Clear (Bal: ${formatNumber(balance)})</button>`;
                                } else {
                                    actionButton = '<span style="color: var(--success); font-weight: 600;">‚úì Fully Paid</span>';
                                }
                            }
                            
                            return `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 12px;">${formatDate(t.date)}</td>
                                <td style="padding: 12px;">
                                    <span style="background: ${t.type === 'Loss' ? '#7c3aed' : t.type.includes('Credit') ? 'var(--primary)' : t.type.includes('Advance') ? '#10b981' : t.type.includes('Loan') ? '#3b82f6' : '#ef4444'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">
                                        ${t.type}
                                    </span>
                                </td>
                                <td style="padding: 12px; color: var(--primary); font-weight: 600;">${t.reference}</td>
                                <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--danger);">UGX ${formatNumber(t.amount)}</td>
                                <td style="padding: 12px; text-align: center;">
                                    <span style="background: ${t.color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">${t.status}</span>
                                </td>
                                <td style="padding: 12px; color: var(--gray); font-size: 12px;">${t.details}</td>
                                <td style="padding: 12px; text-align: center;">${actionButton}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Losses Clearing Functions
        function showClearLossModal(readingId) {
            const reading = readings.find(r => r.id === readingId);
            if (!reading || reading.losses <= 0) return;
            
            // Check if already cleared
            const existing = lossPayments.find(lp => lp.readingId === readingId);
            if (existing) {
                showAlert('This loss has already been cleared', 'info');
                return;
            }
            
            const amount = reading.losses;
            const staff = reading.staff;
            
            if (confirm(`Clear loss of UGX ${formatNumber(amount)} for ${staff}?

Choose payment method:
- OK for Cash
- Cancel to choose method`)) {
                const method = prompt('Enter payment method:\n1. Cash\n2. MoMo\n3. Salary Deduction', '1');
                let paymentMethod = 'Cash';
                if (method === '2') paymentMethod = 'Mobile Money';
                else if (method === '3') paymentMethod = 'Salary Deduction';
                
                saveLossPayment(readingId, staff, amount, paymentMethod);
            }
        }

        function saveLossPayment(readingId, staff, amount, method) {
            const payment = {
                id: `LP ${String(lossPayments.length + 1).padStart(4, '0')}`,
                readingId: readingId,
                staff: staff,
                lossAmount: amount,
                amountPaid: amount,
                method: method,
                date: new Date().toISOString().split('T')[0],
                clearedBy: currentUser.name,
                timestamp: new Date().toISOString()
            };
            
            lossPayments.push(payment);
            localStorage.setItem('lossPayments', JSON.stringify(lossPayments));
            
            showAlertAndReload(`Loss cleared successfully! UGX ${formatNumber(amount)} via ${method}`, 'success');
        }

        // Mark Expense as Paid Function
        // FIX 4: Loan/Fine Clearing System with Installment Support
        function clearLoanOrFine(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) {
                showAlert('Expense not found', 'error');
                return;
            }
            
            // Calculate already paid amount
            const paidSoFar = loanFinePayments
                .filter(p => p.expenseId === expenseId)
                .reduce((sum, p) => sum + p.amountPaid, 0);
            
            const balance = expense.amount - paidSoFar;
            
            if (balance <= 0) {
                showAlert('This loan/fine has already been fully paid', 'info');
                return;
            }
            
            // Prompt for payment amount (allows partial payments/installments)
            const amountStr = prompt(`Clear ${expense.category} for ${expense.paidTo}:
            
Total Amount: UGX ${formatNumber(expense.amount)}
Paid So Far: UGX ${formatNumber(paidSoFar)}
Balance: UGX ${formatNumber(balance)}

Enter payment amount (leave blank to pay full balance):`);
            
            if (amountStr === null) return; // User cancelled
            
            const paymentAmount = amountStr.trim() === '' ? balance : parseFloat(amountStr);
            
            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                showAlert('Invalid payment amount', 'error');
                return;
            }
            
            if (paymentAmount > balance) {
                showAlert(`Payment amount (${formatNumber(paymentAmount)}) exceeds balance (${formatNumber(balance)})`, 'error');
                return;
            }
            
            // Ask for payment method
            const method = confirm('Select payment method:\n\n‚úì OK = Cash\n‚úó Cancel = Mobile Money') ? 'Cash' : 'Mobile Money';
            
            // Create payment record
            const payment = {
                id: `LF ${String(loanFinePayments.length + 1).padStart(4, '0')}`,
                expenseId: expenseId,
                expenseCategory: expense.category,
                staff: expense.paidTo,
                totalAmount: expense.amount,
                amountPaid: paymentAmount,
                balance: balance - paymentAmount,
                method: method,
                date: new Date().toISOString().split('T')[0],
                clearedBy: currentUser.name,
                timestamp: new Date().toISOString()
            };
            
            loanFinePayments.push(payment);
            localStorage.setItem('loanFinePayments', JSON.stringify(loanFinePayments));
            
            // If fully paid, update expense status
            if (balance - paymentAmount <= 0) {
                expense.status = 'Paid';
                expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
                const expenseIndex = expenses.findIndex(e => e.id === expenseId);
                if (expenseIndex !== -1) {
                    expenses[expenseIndex].status = 'Paid';
                    localStorage.setItem('expenses', JSON.stringify(expenses));
                }
            }
            
            const statusMsg = balance - paymentAmount <= 0 ? 'Fully Paid!' : `Partial Payment (Balance: UGX ${formatNumber(balance - paymentAmount)})`;
            showAlertAndReload(`${expense.category} cleared: UGX ${formatNumber(paymentAmount)} via ${method}. ${statusMsg}`, 'success');
        }
        
        // Keep markExpensePaid for non-loan/fine expenses
        function markExpensePaid(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) {
                showAlert('Expense not found', 'error');
                return;
            }
            
            if (confirm(`Mark expense as paid?\n\nExpense: ${expense.description}\nAmount: UGX ${formatNumber(expense.amount)}\nPaid To: ${expense.paidTo}`)) {
                // Update expense status
                expense.status = 'Paid';
                localStorage.setItem('expenses', JSON.stringify(expenses));
                
                showAlertAndReload(`Expense marked as paid! ${expense.category}: UGX ${formatNumber(expense.amount)}`, 'success');
            }
        }

        // Utility Functions
        function generateId() {
            const count = readings.length + 1;
            return `ME ${String(count).padStart(4, '0')}`;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-UG').format(Math.round(num));
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // BATCH 1 - IMPROVEMENT 4: Auto-reload after save
        function showAlertAndReload(message, type = 'success', delay = 1500) {
            showAlert(message, type);
            setTimeout(() => {
                location.reload();
            }, delay);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            if (currentUser) {
                updateStats();
            }
        });
    </script>
</body>
</html>